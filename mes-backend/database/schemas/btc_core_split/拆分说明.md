# BTC Core Schema 拆分说明

## 概述

原始的`btc_core_schema.sql`文件超过1800行，包含28个表定义和大量初始数据。为了便于维护和初始化，已按表和数据类型拆分为多个小文件，每个文件控制在200行以内。

## 文件结构

### 表定义文件（DDL）- 12个文件

| 序号 | 文件名 | 内容 | 行数 |
|------|--------|------|------|
| 01 | `01_tenant_dept.sql` | 租户和部门表 | 56 |
| 02 | `02_user.sql` | 用户表 | 43 |
| 03 | `03_role_permission.sql` | 角色和权限表 | 64 |
| 04 | `04_menu.sql` | 菜单表 | 198 |
| 05 | `05_module_plugin.sql` | 模块、插件、用户模块表 | 121 |
| 06 | `06_menu_permission.sql` | 菜单权限关联表 | 19 |
| 07 | `07_position.sql` | 职位和职位-角色映射表 | 44 |
| 08 | `08_user_role.sql` | 用户角色和角色权限关联表 | 35 |
| 09 | `09_workflow.sql` | 工作流相关表（6个表） | 162 |
| 10 | `10_trace_maps.sql` | 追溯映射表（4个表） | 5 |
| 11 | `11_trace_events.sql` | 追溯事件和链路表（2个表） | 62 |
| 12 | `12_test_measure.sql` | 测试和测量记录表（2个表） | 52 |

### 数据插入文件（DML）- 8+个文件

| 序号 | 文件名 | 内容 | 数据量 |
|------|--------|------|--------|
| 20 | `data_20_tenant_dept.sql` | 租户和部门数据 | 3租户+12部门 |
| 21 | `data_21_users_inert.sql` | UK+INERT用户（USER_1-58） | 58用户 |
| 22 | `data_22_users_supplier_01.sql` | 供应商用户第1批（USER_59-84） | 26用户 |
| 23 | `data_23_users_supplier_02.sql` | 供应商用户第2批（USER_85-110） | 26用户 |
| 24 | `data_24_roles.sql` | 44个业务角色数据 | 44角色 |
| 25 | `data_25_positions.sql` | 职位数据 | 40职位 |
| 26 | `data_26_position_role_map_01.sql` | 职位-角色映射第1部分 | ~50条 |
| 27 | `data_27_position_role_map_02.sql` | 职位-角色映射第2部分 | ~50条 |

## 数据库表清单（28个表）

### 系统管理表（10个）
1. `tenant` - 租户管理表
2. `sys_dept` - 部门表
3. `sys_user` - 系统用户表
4. `sys_role` - 系统角色表
5. `sys_permission` - 系统权限表
6. `sys_menu` - 系统菜单表
7. `sys_position` - 职位表
8. `sys_user_role` - 用户角色关联表
9. `sys_role_permission` - 角色权限关联表
10. `sys_menu_permission` - 菜单权限关联表

### 模块管理表（3个）
11. `sys_module` - 模块表
12. `sys_plugin` - 插件表
13. `sys_user_module` - 用户模块关联表

### 职位管理表（1个）
14. `sys_position_role` - 职位角色映射表

### 工作流表（6个）
15. `workflow_definition` - 流程定义表
16. `workflow_node` - 流程节点表
17. `workflow_connection` - 流程连接表
18. `workflow_instance` - 流程实例表
19. `workflow_task` - 流程任务表
20. `workflow_history` - 流程历史表

### 追溯映射表（4个）
21. `map_sn` - 产品SN映射表
22. `map_box_sn` - 箱码SN映射表
23. `map_pallet_box` - 托盘箱码映射表
24. `map_lot_material` - 批次物料映射表

### 追溯事件表（2个）
25. `trace_event` - 追溯事件表
26. `trace_link` - 追溯链路快照表

### 测试测量表（2个）
27. `test_record` - 测试记录表
28. `measure_record` - 测量记录表

## 初始化数据统计

- **租户**: 3个（UK_HEAD, INERT, SUPPLIER）
- **部门**: 12个
- **用户**: 110个
  - UK总公司: 1个只读用户
  - INERT内网: 57个员工
  - SUPPLIER: 52个供应商用户
- **角色**: 44个（基于业务行为的RBAC角色）
- **职位**: 40个
- **职位-角色映射**: 100+条

## 执行顺序

### 方式1：使用初始化脚本（推荐）

#### Linux/Mac:
```bash
cd mes-backend/database/schemas/btc_core_split
chmod +x init_btc_core.sh
./init_btc_core.sh
```

#### Windows:
```cmd
cd mes-backend\database\schemas\btc_core_split
init_btc_core.bat
```

### 方式2：手动执行

#### 1. 创建数据库
```sql
CREATE DATABASE IF NOT EXISTS btc_core 
CHARACTER SET utf8mb4 
COLLATE utf8mb4_unicode_ci;

USE btc_core;
```

#### 2. 执行表定义（按序号顺序）
```bash
mysql -u root -p btc_core < 01_tenant_dept.sql
mysql -u root -p btc_core < 02_user.sql
mysql -u root -p btc_core < 03_role_permission.sql
mysql -u root -p btc_core < 04_menu.sql
mysql -u root -p btc_core < 05_module_plugin.sql
mysql -u root -p btc_core < 06_menu_permission.sql
mysql -u root -p btc_core < 07_position.sql
mysql -u root -p btc_core < 08_user_role.sql
mysql -u root -p btc_core < 09_workflow.sql
mysql -u root -p btc_core < 10_trace_maps.sql
mysql -u root -p btc_core < 11_trace_events.sql
mysql -u root -p btc_core < 12_test_measure.sql
```

#### 3. 执行数据插入（按序号顺序）
```bash
mysql -u root -p btc_core < data_20_tenant_dept.sql
mysql -u root -p btc_core < data_24_roles.sql
mysql -u root -p btc_core < data_25_positions.sql
mysql -u root -p btc_core < data_21_users_inert.sql
mysql -u root -p btc_core < data_22_users_supplier_01.sql
mysql -u root -p btc_core < data_23_users_supplier_02.sql
mysql -u root -p btc_core < data_26_position_role_map_01.sql
mysql -u root -p btc_core < data_27_position_role_map_02.sql
```

## 重要说明

### 1. 依赖关系
- 必须按序号顺序执行，存在外键依赖
- 职位表（`sys_position`）必须在用户表（`sys_user`）之前创建
- 用户数据必须在职位数据之后插入（因为用户表引用职位）
- 角色数据必须在职位-角色映射之前插入

### 2. 编码格式
- 所有SQL文件使用UTF-8编码（无BOM）
- 数据库字符集：`utf8mb4`
- 排序规则：`utf8mb4_unicode_ci`

### 3. 外键约束
- 用户表（`sys_user`）外键：
  - `tenant_id` → `tenant(tenant_id)`
  - `dept_id` → `sys_dept(dept_id)`
  - `position_id` → `sys_position(position_id)`
- 职位-角色映射（`sys_position_role`）外键：
  - `position_id` → `sys_position(position_id)`
  - `role_id` → `sys_role(role_id)`

### 4. 拆分优势
- ✅ 文件小巧，便于阅读和维护（每个文件≤200行）
- ✅ 模块化，可独立修改某个表或数据
- ✅ 减少Git合并冲突
- ✅ 便于增量更新和回滚
- ✅ 支持按需加载特定表或数据

## 维护指南

### 添加新表
1. 在对应的DDL文件中添加表定义
2. 如果是新类别的表，创建新的编号文件（如`13_new_category.sql`）
3. 更新本文档的表清单

### 添加新数据
1. 在对应的DML文件中添加数据
2. 如果数据量大（>100行），创建新的分批文件（如`data_XX_name_02.sql`）
3. 更新初始化脚本中的文件列表

### 修改现有表
1. 找到对应的DDL文件
2. 修改表定义
3. 如果是breaking change，创建迁移脚本

## 恢复到单文件（如需）

如果需要将所有拆分文件合并回单个文件：

```bash
cd mes-backend/database/schemas/btc_core_split

# Linux/Mac
cat [0-9][0-9]_*.sql data_*.sql > ../btc_core_schema_merged.sql

# Windows PowerShell
Get-Content [0-9][0-9]_*.sql, data_*.sql | Set-Content ../btc_core_schema_merged.sql
```

## 版本信息

- **拆分日期**: 2025-01-08
- **原始文件**: `btc_core_schema.sql` (1871行)
- **拆分后文件数**: 21个（12个DDL + 8个DML + 1个README）
- **平均文件大小**: ~80行
- **最大文件**: `04_menu.sql` (198行)

