- # MESç³»ç»Ÿå…¨å±€æ¶æ„åŸºç¡€æ–‡æ¡£

  ## ä¸€ã€ç³»ç»Ÿæ€»ä½“è®¾è®¡æ€è·¯

  ### 1. æ€»åŠŸèƒ½æ¨¡å—

  1. **BI æ•°æ®å¤§å±çœ‹æ¿**ï¼šç”¨äºæ•°æ®è¿½è¸ªã€æŠ¥è¡¨å±•ç¤ºä¸ç”Ÿäº§çŠ¶æ€å¯è§†åŒ–ã€‚
2. **MES åå°ç®¡ç†ç³»ç»Ÿ**ï¼ˆæ ¸å¿ƒç³»ç»Ÿï¼‰ï¼šåŒ…å«èµ„äº§ç®¡ç†ã€æµç¨‹è¿½è¸ªã€å“è´¨ç®¡æ§ã€ç‰©æµç®¡ç†ç­‰æ ¸å¿ƒæ¨¡å—ã€‚
  3. **ä¾›åº”å•†ç«¯ç§»åŠ¨ç«¯/å°ç¨‹åº**ï¼šæ”¯æŒå¤šç”¨æˆ·ç™»å½•ä¸å¤šè®¾å¤‡ç™»å½•ï¼Œè´Ÿè´£æ¨¡å…·çŠ¶æ€ã€å‘è´§åŠè´¨æ£€ååŒã€‚

  ### 2. æ ¸å¿ƒä¸šåŠ¡æµç¨‹æ¦‚è§ˆ
  
  ç”Ÿäº§è¿‡ç¨‹åˆ†ä¸ºæ–°æ—§é¡¹ç›®ä¸¤ç±»ï¼š

  - **æ–°é¡¹ç›®ï¼ˆå¦‚éªŒé’æœºã€é’±ç®±ï¼‰**ï¼šéœ€ä¸æ€»éƒ¨ï¼ˆITLï¼‰æ²Ÿé€šè¯•äº§æ–¹æ¡ˆå¹¶å®Œæˆ FAIï¼ˆé¦–ä»¶éªŒè¯ï¼‰ã€‚
- **æ—§é¡¹ç›®**ï¼šåŒºåˆ†æ€»éƒ¨è®¢å•ä¸ä¸‰æ–¹è®¢å•ï¼Œç»é¦–ä»¶éªŒè¯åæ‰¹é‡ç”Ÿäº§ã€‚
  
è¯¦ç»†æµç¨‹åŒ…æ‹¬ï¼šæµ·å…³æŠ¥å¤‡ä¸åŸæ–™å…¥åº“ï¼ˆç‰©æµåŸŸï¼‰â†’ IQC è¿›æ–™æ£€éªŒï¼ˆå“è´¨åŸŸï¼‰â†’ è¯•äº§/é¦–ä»¶ï¼ˆç”Ÿäº§åŸŸï¼‰â†’ æ‰¹é‡ç”Ÿäº§ + IPQC æŠ½æ£€ â†’ æµ‹è¯•ã€ç»´ä¿®ã€OQC æŠ½æ£€ä¸å‡ºè´§ â†’ å¹´åº¦ç›˜ç‚¹ä¸ ERP æ•°æ®æ¯”å¯¹ã€‚
  
  ------

  ## äºŒã€æ¶æ„åˆ†å±‚ä¸æ¨¡å—è¾¹ç•Œ

  ### 1. ç³»ç»Ÿåˆ†å±‚

  - **å‰ç«¯å±‚**ï¼šVue3 + Element Plus å®ç° MES Webï¼›BI å¤§å±ä½¿ç”¨ EChartsï¼›ç§»åŠ¨ç«¯é‡‡ç”¨ uniapp æˆ–å°ç¨‹åºåŸç”Ÿã€‚
- **ä¸šåŠ¡æœåŠ¡å±‚**ï¼ˆREST APIï¼‰ï¼š
    - èµ„äº§ç®¡ç†ï¼ˆæ¨¡å…·/è¾…æ–™/ä¸»æ–™å°è´¦ï¼‰
  - å“è´¨ï¼ˆIQCã€IPQCã€OQCã€è¿”ä¿®ã€æµ‹è¯•ã€NCR/SCARï¼‰
    - ç‰©æµï¼ˆå…¥åº“/å‡ºåº“/ç›˜ç‚¹/å¤‡æ–™/åº“å­˜å¯¹è´¦ï¼‰
    - ç”Ÿäº§ï¼ˆå·¥å•ã€SOPã€å·¥è‰ºè·¯çº¿ã€é¦–ä»¶/æ‰¹æ¬¡ç”Ÿäº§ï¼‰
    - è¿½æº¯ï¼ˆæ­£å‘/åå‘å…¨é“¾è·¯è¿½æº¯ï¼‰
  - **æ•°æ®å±‚**ï¼šMySQLï¼ˆäº‹åŠ¡åº“ï¼‰+ Redisï¼ˆç¼“å­˜ä¸é”ï¼‰+ OSSï¼ˆå½±åƒä¸é™„ä»¶ï¼‰ã€‚
  
  ### 2. ç³»ç»Ÿé›†æˆ
  
  - **ERP**ï¼šå¯¹æ¥ BOMã€å·¥å•ã€åº“å­˜åŒæ­¥ã€‚
- **ITL æ€»éƒ¨**ï¼šæ–°é¡¹ç›® FAI æŠ¥å‘Šã€ECN æ–‡ä»¶ä¸Šä¼ ã€‚
  - **ä¾›åº”å•†ç³»ç»Ÿ**ï¼šè®¢å•å‘è´§ä¸ IQC çŠ¶æ€åŒæ­¥ã€‚

  ------
  
  ## ä¸‰ã€æ•°æ®æ¶æ„ä¸æ ‡è¯†ä½“ç³»

  ### 1. ä¸»è¦å¯¹è±¡ä¸æ ‡è¯†

  | å¯¹è±¡   | æ ‡è¯†è§„åˆ™               |
| ------ | ---------------------- |
  | ç‰©æ–™   | ITM-YYYYMM-XXXX        |
| æ¨¡å…·   | MLD-SUP-XXXX           |
  | è®¢å•   | PO-YYYYMMDD-SEQ        |
  | å·¥å•   | WO-LINE-SEQ            |
  | æ‰¹æ¬¡   | LOT-YYYYMMDD-SEQ       |
  | åºåˆ—å· | SN-LOT-SEQ             |
  | æ£€éªŒå• | INSP-TYPE-YYYYMMDD-SEQ |
  
  ### 2. è¿½æº¯ä¸»çº¿
  
  - **æ­£å‘**ï¼šè®¢å• â†’ å·¥å• â†’ æ‰¹æ¬¡/åºåˆ—å· â†’ æµ‹è¯•/ç»´ä¿® â†’ OQC â†’ å‡ºè´§ã€‚
- **åå‘**ï¼šåºåˆ—å· â†’ æ‰¹æ¬¡ â†’ åŸæ–™æ‰¹æ¬¡/ä¾›åº”å•† â†’ æ¨¡å…· â†’ IQC â†’ å·¥åº/è´£ä»»äººã€‚
  
### 3. æ•°æ®è¡¨è®¾è®¡ï¼ˆMySQLï¼‰ç¤ºä¾‹
  
  ```sql
CREATE TABLE inspection (
    insp_id     VARCHAR(32) PRIMARY KEY,
  type        VARCHAR(8),      -- IQC/IPQC/OQC/FAI
    ref_id      VARCHAR(32),     -- grn_id / lot_id / wo_id / box_no
    result      VARCHAR(16),     -- PASS/FAIL/SPECIAL
    sample_size INT,
    created_by  VARCHAR(64),
    created_at  DATETIME
  );
  
  CREATE TABLE test_record (
    id         BIGINT AUTO_INCREMENT PRIMARY KEY,
    sn         VARCHAR(64),
    station    VARCHAR(64),
    result     VARCHAR(8),       -- PASS/FAIL
    code       VARCHAR(32),      -- å¤±è´¥ä»£ç 
    tested_at  DATETIME
  );
  ```
  
  ### 4. Redis åº”ç”¨åœºæ™¯
  
  - ä¼šè¯ï¼š`session:{user_id}`ï¼›
- åˆ†å¸ƒå¼é”ï¼š`lock:pick:{wo_id}:{item_id}` æ§åˆ¶å¤‡æ–™å¹¶å‘ï¼›
  - ç¼“å­˜ï¼šçœ‹æ¿æŒ‡æ ‡ï¼ˆTTL 30â€“120sï¼‰ï¼›
- å¹‚ç­‰ï¼š`Idempotency-Key` æäº¤å»é‡ã€‚
  
  ------
  
  ## å››ã€ä¸šåŠ¡æµç¨‹æ”¹è¿›

  - **IQC æµç¨‹æ•°å­—åŒ–**ï¼šç”µå­ SOP + AQL è‡ªåŠ¨æŠ½æ · + å½±åƒç›´ä¼  OSSï¼›ä¸åˆæ ¼è§¦å‘ NCR/SCAR å¹¶è®¡å…¥ä¾›åº”å•†è¯„åˆ†ã€‚
- **FAI é¦–ä»¶æ§åˆ¶**ï¼šæœªé€šè¿‡ç¦æ­¢æ‰¹é‡æŠ•äº§ï¼›ç”Ÿæˆé¦–ä»¶åˆæ ¼æŠ¥å‘Šå½’æ¡£ã€‚
  - **ç”Ÿäº§ä¸å·¡æ£€**ï¼šWIP çŠ¶æ€æœºï¼ˆå¾…æŠ•äº§â†’è£…é…â†’åˆæµ‹â†’è¿”ä¿®â†’å¤æµ‹â†’ç»ˆæµ‹â†’æ‰“åŒ…ï¼‰ï¼›IPQC æŠ½æ£€é¢‘æ¬¡éšä¸åˆæ ¼ç‡åŠ¨æ€è°ƒæ•´ã€‚
- **OQC ä¸ç›˜ç‚¹**ï¼šæŒ‰å®¢æˆ·åè®®é…ç½® AQLï¼›ç§»åŠ¨ç«¯æ‰«ç ç›˜ç‚¹ä¸å·®å¼‚å®¡è®¡ã€‚
  
  ------
  
  ## äº”ã€æ¥å£ä¸ API ç¤ºä¾‹

  ç»Ÿä¸€è¿”å›ï¼š`{code, message, data}`

  - `POST /iqc/inspections` â†’ åˆ›å»ºæ£€éªŒå•
- `GET /trace/reverse?sn=` â†’ åå‘è¿½æº¯
  - `POST /stock/move` â†’ åº“å­˜ç§»åº“

  ------
  
  ## å…­ã€éåŠŸèƒ½æ€§è¦æ±‚ï¼ˆNFRï¼‰

  - **æ€§èƒ½**ï¼šå¤§è¡¨æŒ‰æ—¥/å‘¨åˆ†åŒºï¼›çƒ­ç‚¹æ•°æ®ç¼“å­˜ï¼›ç»Ÿè®¡æŸ¥è¯¢èµ°åªè¯»å‰¯æœ¬ã€‚
- **å®‰å…¨**ï¼šJWT + åˆ·æ–°ä»¤ç‰Œï¼›é™„ä»¶é¢„ç­¾å URLï¼›è¡Œçº§æ•°æ®æƒé™ã€‚
  - **å¯é æ€§**ï¼šå¹‚ç­‰ä¸åˆ†å¸ƒå¼é”ï¼›ä¸»ä»å¤åˆ¶ä¸å®šæ—¶å¤‡ä»½ã€‚
- **å¯ç»´æŠ¤æ€§**ï¼šTraceID è´¯ç©¿ï¼›æ“ä½œå®¡è®¡ä¸å‘Šè­¦ã€‚
  
  ------
  
  ## ä¸ƒã€Element Plus å‰ç«¯è½åœ°å»ºè®®

  - IQC æ£€éªŒï¼š`ElForm`ï¼ˆåŠ¨æ€æ ¡éªŒï¼‰+ `ElUpload`ï¼ˆå½±åƒï¼‰+ AQL è®¡ç®—å™¨
- WIP çœ‹æ¿ï¼š`ElCard` æ …æ ¼ + ECharts è‰¯ç‡/åœ¨åˆ¶
  - è¿½æº¯é¡µï¼š`ElInput`ï¼ˆSN/ç®±å·ï¼‰â†’ `ElTimeline`ï¼ˆèŠ‚ç‚¹è½¨è¿¹ï¼‰
- ç›˜ç‚¹é¡µï¼šç§»åŠ¨ç«¯æ‰«ç  + å·®å¼‚å³æ—¶æç¤º
  
  ------
  
  ## å…«ã€æ”¹è¿›ç‰ˆæµç¨‹å›¾ï¼ˆä¸»æµç¨‹ + å¤šåˆ†æ”¯ + BI ä¼ªå®æ—¶é—­ç¯ï¼‰

  ```mermaid
graph TD
      %% ===== ä¸»å¹²ï¼šç”Ÿäº§å…¨é“¾ =====
    ROOT["ğŸ”¹ è®¢å•éœ€æ±‚å‘èµ·"] --> RES["ğŸŸ¦ èµ„æºå‡†å¤‡"]
      RES --> PROD["ğŸŸ¦ ç”Ÿäº§æ‰§è¡Œ"]
      PROD --> WMS["ğŸŸ¦ ç‰©æµä»“å‚¨"]
      WMS --> QA["ğŸŸ¦ å“è´¨ä¸å‡ºè´§"]
      QA --> TRACE["ğŸŸ¦ æ•°æ®è¿½æº¯ä¸åˆ†æ"]
      TRACE --> CLOSE["ğŸ”¹ æµç¨‹é—­ç¯å½’æ¡£"]
  
      %% ====== åˆ†æ”¯å…¥å£ï¼ˆä»ä¸»å¹²åˆ†å‰ï¼‰======
      RES --> IQC_ENTRY[["ğŸ“„ IQCæ£€éªŒï¼ˆå­æµç¨‹ï¼‰"]]
      PROD --> P_ENTRY[["ğŸ“„ ç”Ÿäº§+IPQCï¼ˆå­æµç¨‹ï¼‰"]]
      QA --> OQC_ENTRY[["ğŸ“„ OQCä¸å‡ºè´§ï¼ˆå­æµç¨‹ï¼‰"]]
      WMS --> CC_ENTRY[["ğŸ“„ ç›˜ç‚¹ä¸å®¡è®¡ï¼ˆå­æµç¨‹ï¼‰"]]
      TRACE --> CS_ENTRY[["ğŸ“„ å®¢è¯‰è¿½æº¯ï¼ˆå­æµç¨‹ï¼‰"]]
  
      %% ====== IQC å­æµç¨‹ ======
      subgraph IQC_Flow["IQCæ£€éªŒå­æµç¨‹"]
        direction TB
        IQ1["ç‰©æ–™åˆ°è´§ / å»ºGRN"] --> IQ2["åˆ›å»ºIQCæ£€éªŒå•"]
        IQ2 --> IQ3{"AQLæŠ½æ ·ä¸æ£€æµ‹"}
        IQ3 -->|åˆæ ¼| IQ4["å…¥åº“ç™»è®° â†’ å¯ç”¨åº“å­˜"]
        IQ3 -->|ä¸åˆæ ¼| IQ5["ä¸åˆæ ¼éš”ç¦»"]
        IQ5 --> IQ6["ç‰¹é‡‡ / é€€è´§ / ç«‹NCR"]
        IQ6 --> IQ7["ä¾›åº”å•†è¯„åˆ†è”åŠ¨"]
        IQ4 --> IQ8["æ£€éªŒæŠ¥å‘Šå½’æ¡£"]
      end
      IQC_ENTRY -.è¿›å…¥.-> IQ1
      IQ8 -.è¿”å›ä¸»å¹².-> WMS
  
      %% ====== ç”Ÿäº§+IPQC å­æµç¨‹ ======
      subgraph P_Flow["ç”Ÿäº§ä¸IPQCå­æµç¨‹"]
        direction TB
        P0["å·¥å•ä¸‹å‘"] --> P1["å¤‡æ–™äº¤ä»˜ç”Ÿäº§"]
        P1 --> P2["è£…é… / ç»„è£…"]
        P2 --> P3["é¦–ä»¶éªŒè¯ï¼ˆFAIï¼‰"]
        P3 --> P4{"é¦–ä»¶ç»“æœ"}
        P4 -->|é€šè¿‡| P5["æ‰¹é‡ç”Ÿäº§"]
        P4 -->|æœªé€šè¿‡| P6["å·¥è‰ºå‚æ•°è°ƒæ•´ â†’ é‡æµ‹"]
        P5 --> P7["IPQCå·¡æ£€ï¼ˆåŠ¨æ€é¢‘æ¬¡ï¼‰"]
        P7 --> P8{"æŠ½æ£€ç»“æœ"}
        P8 -->|åˆæ ¼| P9["åˆæµ‹ â†’ ç»ˆæµ‹ â†’ æ‰“åŒ…"]
        P8 -->|ä¸åˆæ ¼| P10["æš‚åœ â†’ è¿”ä¿®åˆ†æï¼ˆæ¬¡æ•°ä¸Šé™ï¼‰"]
      end
      P_ENTRY -.è¿›å…¥.-> P0
      P9 -.è‰¯å“æ‰“åŒ…â†’.-> QA
  
      %% ====== OQC+å‡ºè´§ å­æµç¨‹ ======
      subgraph OQC_Flow["OQCæ£€éªŒä¸å‡ºè´§å­æµç¨‹"]
        direction TB
        O1["æˆå“æ‰“åŒ…å®Œæˆ"] --> O2["ç”Ÿæˆç®±å· / æ‰˜ç›˜å·"]
        O2 --> O3["OQCæŠ½æ£€ï¼ˆAQLï¼‰"]
        O3 --> O4{"æ£€éªŒç»“æœ"}
        O4 -->|åˆæ ¼| O5["å‡ºè´§æ”¾è¡Œ"]
        O4 -->|ä¸åˆæ ¼| O6["éš”ç¦» / è¿”ä¿® / å¤æ£€"]
        O5 --> O7["å‡ºè´§æŠ¥å‘Šå½’æ¡£"]
      end
      OQC_ENTRY -.è¿›å…¥.-> O1
      O7 -.è¿”å›ä¸»å¹².-> TRACE
  
      %% ====== ç›˜ç‚¹ä¸å®¡è®¡ å­æµç¨‹ ======
      subgraph CC_Flow["ç›˜ç‚¹ä¸åº“å­˜å®¡è®¡å­æµç¨‹"]
        direction TB
        C1["ç”Ÿæˆç›˜ç‚¹ä»»åŠ¡"] --> C2["ç§»åŠ¨ç«¯æ‰«æç›˜ç‚¹"]
        C2 --> C3["æ•°æ®ä¸Šä¼  / Redisç¼“å­˜"]
        C3 --> C4["å¯¹æ¯”ERPåº“å­˜"]
        C4 --> C5{"æ˜¯å¦æœ‰å·®å¼‚"}
        C5 -->|æ— | C6["ç›˜ç‚¹ç»“æœå½’æ¡£"]
        C5 -->|æœ‰| C7["å·®å¼‚å•å¤æ ¸"]
        C7 --> C8["è´£ä»»å½’å› åˆ†æ"]
      end
      CC_ENTRY -.è¿›å…¥.-> C1
      C6 -.è¿”å›ä¸»å¹².-> TRACE
      C8 -.è¿”å›ä¸»å¹².-> TRACE
  
      %% ====== å®¢è¯‰è¿½æº¯ å­æµç¨‹ ======
      subgraph CS_Flow["å®¢è¯‰è¿½æº¯å­æµç¨‹"]
        direction TB
        S1["æ¥æ”¶å®¢æˆ·SN/ç®±å·"] --> S2["åæŸ¥æ‰¹æ¬¡ / å·¥å•"]
        S2 --> S3["å…³è”ç”¨æ–™æ‰¹æ¬¡ / ä¾›åº”å•† / æ¨¡å…·"]
        S3 --> S4["æŸ¥è¯¢IQC / OQCç»“æœ"]
        S4 --> S5["æå–æµ‹è¯• / ç»´ä¿®è®°å½•"]
        S5 --> S6["ç”Ÿæˆè´£ä»»å½’å› æŠ¥å‘Š"]
      end
      CS_ENTRY -.è¿›å…¥.-> S1
      S6 -.è¿”å›ä¸»å¹².-> CLOSE
  
      %% ====== BI ä¼ªå®æ—¶ï¼ˆåˆ†é’Ÿçº§ï¼‰å­æµç¨‹ ======
      subgraph BI_Flow["BI è¿‘å®æ—¶ï¼ˆåˆ†é’Ÿçº§ï¼‰"]
        direction LR
        BI_COLLECT["æ•°æ®é‡‡é›†ï¼ˆåªè¯»å‰¯æœ¬ / å¢é‡ï¼‰"] --> BI_AGG["5åˆ†é’Ÿå¢é‡èšåˆï¼ˆç‰©åŒ–è¡¨ï¼‰"]
        BI_AGG --> BI_CACHE["RedisçŸ­æœŸç¼“å­˜ï¼ˆ30â€“120sï¼‰"]
        BI_CACHE --> BI_PUSH["WebSocket / è½®è¯¢æ¨é€"]
        BI_PUSH --> BI_DASH["BIå¤§å± / çœ‹æ¿ï¼ˆElement + EChartsï¼‰"]
        BI_AGG --> BI_QC["æ–°é²œåº¦ / è´¨é‡ç›‘æ§ï¼ˆå‘Šè­¦ï¼‰"]
      end
  
      %% ä»å„å­æµç¨‹åˆ° BI æ•°æ®é‡‡é›†ï¼ˆå¢é‡ï¼‰
      IQ8 -.-> BI_COLLECT
      P7 -.-> BI_COLLECT
      P9 -.-> BI_COLLECT
      O3 -.-> BI_COLLECT
      O7 -.-> BI_COLLECT
      C3 -.-> BI_COLLECT
      C6 -.-> BI_COLLECT
  
      %% BI åé¦ˆå›ä¸»å¹²ï¼ˆå‘Šè­¦/æç¤ºï¼‰
      BI_QC -.-> QA
      BI_QC -.-> PROD
  
      %% æ ·å¼
      classDef trunk fill:#e3f2fd,stroke:#2196f3,stroke-width:1px;
      class ROOT,RES,PROD,WMS,QA,TRACE,CLOSE trunk;
  ```
  
  ------
  
  ## ä¹ã€BI è¿‘å®æ—¶ï¼ˆåˆ†é’Ÿçº§ï¼‰ä½“ç³»è®¾è®¡

  > ç›®æ ‡ï¼šåœ¨ä¸å¼•å…¥å¤§æ•°æ®æ ˆå‰æä¸‹ï¼Œä»…ç”¨ **MySQL + Redis** å®ç°åˆ†é’Ÿçº§ä¼ªå®æ—¶æ¸²æŸ“ï¼Œä¿éšœè¿½è¸ªã€è‰¯ç‡/è¿›åº¦ç­‰å…³é”®æŒ‡æ ‡ 1â€“5 åˆ†é’Ÿå†…æ›´æ–°ã€‚

  ### 9.1 æŒ‡æ ‡åŸŸä¸ SLA

  - **ç”Ÿäº§åŸŸ**ï¼šå½“æ—¥äº§é‡ã€å·¥å•è¾¾æˆç‡ã€WIP åˆ†å¸ƒ â†’ **SLAï¼šâ‰¤2 åˆ†é’Ÿ**
- **å“è´¨åŸŸ**ï¼šIQC/OQC é€šè¿‡ç‡ã€ç¼ºé™·ç  TopNã€è¿”ä¿®å›åœˆæ—¶é—´ â†’ **SLAï¼šâ‰¤3 åˆ†é’Ÿ**
  - **ç‰©æµåŸŸ**ï¼šåº“å­˜å‘¨è½¬ã€å‡ºå…¥åº“èŠ‚æ‹ã€ç›˜ç‚¹è¿›åº¦ â†’ **SLAï¼šâ‰¤5 åˆ†é’Ÿ**

  ### 9.2 æ–¹æ¡ˆ
  
  - åªè¯»å‰¯æœ¬æŸ¥è¯¢ï¼›å¢é‡ç‰©åŒ–è¡¨ï¼ˆ1â€“5 åˆ†é’Ÿï¼‰ï¼›binlog ä½ç‚¹æˆ– `updated_at > last_ts` æ‹‰å¢é‡ï¼›
- Redis ç»ˆç«¯æŒ‡æ ‡ç¼“å­˜ï¼ˆTTL 30â€“120sï¼‰ï¼›WebSocket æ¨é€ï¼›èšåˆä½œä¸šå¹‚ç­‰ä¸å›çœ‹çª—å£ï¼ˆ10â€“15 åˆ†é’Ÿï¼‰ã€‚
  
### 9.3 è¡¨ä¸ç¤ºä¾‹ SQL
  
  **æ˜ç»†è¡¨**ï¼š`test_record(sn, station, result, code, tested_at)` / `inspection(...)` / `stock_txn(...)`
 **èšåˆè¡¨**ï¼š
  
```sql
  CREATE TABLE agg_yield_5m (
    bucket_start DATETIME PRIMARY KEY,
  pass_cnt INT, fail_cnt INT, yield DECIMAL(5,2),
    updated_at DATETIME
  );
  ```
  
  **åˆ·æ–°ç¤ºä¾‹**ï¼š
  
  ```sql
REPLACE INTO agg_yield_5m (bucket_start, pass_cnt, fail_cnt, yield, updated_at)
  SELECT
  FROM_UNIXTIME(UNIX_TIMESTAMP(tested_at) - MOD(UNIX_TIMESTAMP(tested_at), 300)) AS bucket_start,
    SUM(result = 'PASS') AS pass_cnt,
    SUM(result = 'FAIL') AS fail_cnt,
    ROUND(100 * SUM(result = 'PASS') / GREATEST(COUNT(*),1), 2) AS yield,
    NOW()
  FROM test_record
  WHERE tested_at > (SELECT COALESCE(MAX(updated_at), '1970-01-01') FROM agg_yield_5m)
  GROUP BY bucket_start;
  ```
  
  ### 9.4 è°ƒåº¦ä¸å¹¶å‘
  
  - Cronï¼š`*/1` æˆ– `*/3`ï¼›
- åˆ†å¸ƒå¼é”ï¼š`lock:agg:{table}:{bucket}`ï¼›
  - å¹‚ç­‰æ¸¸æ ‡ï¼š`agg:cursor:{table}`ï¼›
- å¤±è´¥é‡è¯•ä¸æ–°é²œåº¦å‘Šè­¦ã€‚
  
  ### 9.5 å‰ç«¯å¥‘çº¦ï¼ˆElement + EChartsï¼‰
  
  ```json
{
    "updated_at": "2025-10-07T10:12:00Z",
  "yield": [{"t":"10:05","value":96.2},{"t":"10:10","value":95.7}],
    "wip": {"assembling":120,"testing":45,"packing":30,"finished":60},
    "alerts": ["IPQCä¸åˆæ ¼ç‡ä¸Šå‡è‡³5%ï¼ˆ>3%é˜ˆå€¼ï¼‰"]
  }
  ```
  
  ------
  
  ## åã€è¿½æº¯å­—æ®µä¸æ•°æ®è§„èŒƒï¼ˆå…³é”®å­—æ®µæ ‡å‡†ï¼‰

  > **è¿½è¸ªé“¾è·¯åˆ†å±‚**ï¼šåŸææ–™ï¼ˆRAWï¼‰ â†’ ç»„ä»¶ï¼ˆCOMPONENTï¼‰ â†’ æˆå“ï¼ˆFINISHEDï¼‰
>  **æ ¸å¿ƒå±æ€§**ï¼šå¯¹åº”å·¥åºã€å·¥åºæ‰§è¡Œå¼€å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´ã€æ‰§è¡Œäººã€æ‰§è¡Œç»“æœï¼ˆPASS/FAIL/REWORK/HOLDï¼‰ï¼Œä»¥åŠå·¥ä½/è®¾å¤‡ã€ç­æ¬¡ç­‰ä¸Šä¸‹æ–‡ã€‚
  
### 10.1 å‘½åä¸é€šç”¨çº¦å®š
  
  - `snake_case`ï¼›ä¸»é”® `*_id`ï¼›åºåˆ—å· `sn`ï¼›ç¼–å·å‰ç¼€ï¼ˆ`PO-`/`LOT-` ç­‰ï¼‰ã€‚
- æ—¶é—´ç»Ÿä¸€å­˜ UTCï¼Œåç«¯å­—æ®µ `*_at`ï¼Œå‰ç«¯æœ¬åœ°åŒ–æ˜¾ç¤ºã€‚
  - å¤šç§Ÿæˆ·å­—æ®µï¼š`tenant_id` / `site_id`ï¼ˆå¯é€‰ `org_id`ï¼‰ã€‚
- å®¡è®¡ï¼š`created_by/created_at/updated_by/updated_at/source_system`ã€‚
  - å—æ§å˜æ›´ï¼š`version/effective_from/effective_to`ã€‚
  - äº‹ä»¶/è¿½æº¯è¡¨ä¸å¯æ›´æ–°åˆ é™¤ï¼ˆä»…è¿½åŠ ï¼‰ã€‚
  
  ### 10.2 æ ¸å¿ƒæ ‡è¯†ä½“ç³»ï¼ˆç»Ÿä¸€ç¼–ç ï¼‰
  
  | å®ä½“      | å­—æ®µ               | è§„åˆ™ç¤ºä¾‹                 | è¯´æ˜                        |
| --------- | ------------------ | ------------------------ | --------------------------- |
  | ç‰©æ–™      | `item_id`          | ITM-YYYYMM-XXXX          | ä¸ ERP `item_code` å”¯ä¸€æ˜ å°„ |
| æ¨¡å…·      | `mold_id`          | MLD-SUP-XXXX             | SUP ä¸ºä¾›åº”å•†ç¼–ç             |
  | ä¾›åº”å•†    | `supplier_id`      | SUP-XXXXX                | ä¾›åº”å•†ä¸»æ•°æ®                |
  | é‡‡è´­è®¢å•  | `po_id`            | PO-YYYYMMDD-SEQ          | å¯¹åº” ERP `po_no`            |
  | æ”¶è´§/æ¥æ–™ | `grn_id`           | GRN-YYYYMMDD-SEQ         | æ”¶è´§æ‰¹                      |
  | ç”Ÿäº§å·¥å•  | `wo_id`            | WO-LINE-SEQ              | äº§çº¿ LINE                   |
  | ç”Ÿäº§æ‰¹æ¬¡  | `lot_id`           | LOT-YYYYMMDD-SEQ         | ä¸å·¥å•å¼ºå…³è”                |
  | åºåˆ—å·    | `sn`               | SN-{lot_id}-{SEQ}        | å¼ºç»‘å®šæ‰¹æ¬¡                  |
  | ç®±å·      | `box_no`           | BOX-YYYYMMDD-SEQ         | å‡ºè´§åŒ…è£…                    |
  | æ‰˜ç›˜å·    | `pallet_no`        | PLT-YYYYMMDD-SEQ         | ç‰©æµæ‰“æ‰˜                    |
  | å‡ºè´§å•    | `shipment_id`      | SHP-YYYYMMDD-SEQ         | å‡ºè´§ä¸»å•                    |
  | æ£€éªŒå•    | `insp_id`          | INSP-{type}-YYYYMMDD-SEQ | type=IQC/IPQC/OQC/FAI       |
  | NCR/SCAR  | `ncr_id`/`scar_id` | NCR-.../SCAR-...         | é—­ç¯è´¨é‡                    |
  
  > ç»Ÿä¸€â€œå‘å·å™¨æœåŠ¡â€é˜²å¹¶å‘å†²çªï¼›å¯¹å†…å¯ UUIDï¼Œå¯¹å¤–å±•ç¤ºä¿å‰ç¼€è¯­ä¹‰ã€‚
  
  ### 10.3 ç»“æ„åŒ–è¿½æº¯æ˜ å°„ï¼ˆå››å¼ å…³é”®æ˜ å°„è¡¨ï¼‰

  ```sql
-- SN â†’ æ‰¹æ¬¡/å·¥å•/ç®±å·/æ‰˜ç›˜
  CREATE TABLE map_sn (
  sn         VARCHAR(64) PRIMARY KEY,
    lot_id     VARCHAR(32) NOT NULL,
    wo_id      VARCHAR(32) NOT NULL,
    box_no     VARCHAR(64),
    pallet_no  VARCHAR(64),
    tenant_id  VARCHAR(32), site_id VARCHAR(32),
    created_at DATETIME, created_by VARCHAR(64)
  );
  CREATE INDEX idx_map_sn_lot ON map_sn(lot_id);
  CREATE INDEX idx_map_sn_box ON map_sn(box_no);
  
  -- ç®±å· â†’ SN
  CREATE TABLE map_box_sn (
    id        BIGINT PRIMARY KEY AUTO_INCREMENT,
    box_no    VARCHAR(64) NOT NULL,
    sn        VARCHAR(64) NOT NULL,
    tenant_id VARCHAR(32), site_id VARCHAR(32),
    created_at DATETIME
  );
  CREATE INDEX idx_box_sn_box ON map_box_sn(box_no);
  
  -- æ‰˜ç›˜ â†’ ç®±å·
  CREATE TABLE map_pallet_box (
    id        BIGINT PRIMARY KEY AUTO_INCREMENT,
    pallet_no VARCHAR(64) NOT NULL,
    box_no    VARCHAR(64) NOT NULL,
    created_at DATETIME
  );
  CREATE INDEX idx_pallet_box_pl ON map_pallet_box(pallet_no);
  
  -- æ‰¹æ¬¡ â†’ ç”¨æ–™æ¥æºï¼ˆä¾›åº”å•†/æ¥æ–™æ‰¹æ¬¡/æ¨¡å…·ï¼‰
  CREATE TABLE map_lot_material (
    id          BIGINT PRIMARY KEY AUTO_INCREMENT,
    lot_id      VARCHAR(32) NOT NULL,
    item_id     VARCHAR(32) NOT NULL,
    supplier_id VARCHAR(32),
    grn_id      VARCHAR(32),
    mold_id     VARCHAR(32),
    qty_used    DECIMAL(18,4),
    created_at  DATETIME
  );
  CREATE INDEX idx_lot_material_lot ON map_lot_material(lot_id);
  ```
  
  > æ”¯æŒ **æ­£å‘**ï¼ˆè®¢å•â†’å‡ºè´§ï¼‰ä¸ **åå‘**ï¼ˆSNâ†’ç”¨æ–™/æ¨¡å…·/ä¾›åº”å•†ï¼‰O(1~log n) æŸ¥è¯¢ã€‚
  
  ### 10.4 å·¥è‰º/å·¥åºå¯æ‰©å±•å»ºæ¨¡ï¼ˆæ’æ‹”å¼ï¼‰

  ```sql
-- å·¥è‰ºè·¯çº¿ï¼ˆç‰ˆæœ¬åŒ–ï¼‰
  CREATE TABLE routing (
  routing_id     VARCHAR(32) PRIMARY KEY,
    item_id        VARCHAR(32),
    version        INT,
    effective_from DATETIME, effective_to DATETIME,
    status         VARCHAR(16)
  );
  
  -- å·¥åºå®šä¹‰ï¼ˆå¯æ’æ‹”ï¼ŒæŒ‰åºå·æ’åˆ—ï¼‰
  CREATE TABLE operation (
    op_id        VARCHAR(32) PRIMARY KEY,
    routing_id   VARCHAR(32) NOT NULL,
    op_seq       INT NOT NULL,
    op_code      VARCHAR(32),   -- ç»„è£…/ä¸Šç”µ/åˆæµ‹/ç»ˆæµ‹/åŒ…è£…...
    station_id   VARCHAR(32),   -- å·¥ä½/è®¾å¤‡
    sop_id       VARCHAR(32), sop_version INT,
    sample_plan  JSON,          -- æŠ½æ£€/AQLå‚æ•°
    check_items  JSON,          -- è´¨æ£€é¡¹ç›®æ¨¡æ¿
    UNIQUE KEY uk_routing_seq(routing_id, op_seq)
  );
  ```
  
  > æ–°å¢å·¥åºåªéœ€æ’å…¥ `operation`ï¼Œå·¥å•å¯åŠ¨æ—¶å°† `routing` å¿«ç…§åŒ–ä¸ºå®ä¾‹è¡¨ `wo_operation`ã€‚
  
  ### 10.5 äº‹ä»¶æº¯æºï¼ˆ**æ ¸å¿ƒ**ï¼šå·¥åº+äººå‘˜+æ—¶é—´+ç»“æœï¼‰

  ```sql
-- æ‰€æœ‰å¯è¿½èŠ‚ç‚¹æŠ½è±¡ä¸ºä¸å¯å˜äº‹ä»¶
  CREATE TABLE trace_event (
  event_id       VARCHAR(40) PRIMARY KEY,
    entity_type    VARCHAR(32),   -- SN/LOT/WO/GRN/BOX/PLT/INSP
    entity_id      VARCHAR(64),
    action         VARCHAR(32),   -- START/END/PASS/FAIL/REWORK/MOVE/PACK/SHIP...
    occurred_at    DATETIME,
    op_id          VARCHAR(32),   -- å¯¹åº”å·¥åº
    op_name        VARCHAR(64),
    op_start_at    DATETIME,
    op_end_at      DATETIME,
    operator_id    VARCHAR(64),
    result         VARCHAR(16),   -- PASS/FAIL/REWORK/HOLD
    station_id     VARCHAR(64),
    shift_code     VARCHAR(16),
    ref_id         VARCHAR(64),   -- ä¸šåŠ¡å•æ®ï¼šinsp_id/stock_txnç­‰
    data           JSON,          -- æµ‹é‡å€¼/å‚æ•°/é™„ä»¶keyç­‰
    prev_event_id  VARCHAR(40),   -- é“¾å¼è¿½æº¯
    correlation_id VARCHAR(64),   -- åŒäº‹åŠ¡/åŒå·¥åºç›¸å…³æ€§
    tenant_id      VARCHAR(32), site_id VARCHAR(32),
    source_system  VARCHAR(32),
    created_at     DATETIME
  );
  CREATE INDEX idx_event_entity ON trace_event(entity_type, entity_id, occurred_at);
  CREATE INDEX idx_event_action ON trace_event(action, occurred_at);
  ```
  
  - **æ–°å¢è¿½è¸ªç‚¹** = æ–° `action` + å¯¹åº”ä¸Šä¸‹æ–‡å†™å…¥ `data`ï¼ˆæ— éœ€æ”¹è¡¨ï¼‰ï¼›
  - **æ­£åå‘è¿½æº¯**ï¼šä»¥ `entity_type+entity_id`/`sn` ä¸ºå…¥å£ä¸²è” `prev_event_id`/`correlation_id`ã€‚
  
### 10.6 é“¾è·¯å¿«ç…§ï¼ˆä¸‰å±‚ï¼šåŸææ–™/ç»„ä»¶/æˆå“ï¼‰
  
  ```sql
-- ä¾¿æ·é“¾è·¯å¿«ç…§ï¼Œç”¨äºå¿«é€Ÿæ‹‰é€šå±‚çº§ï¼ˆå¯æŒ‰éœ€å¼€å¯ï¼‰
  CREATE TABLE trace_link (
  id           BIGINT PRIMARY KEY AUTO_INCREMENT,
    level        ENUM('RAW','COMPONENT','FINISHED'),
    sn           VARCHAR(64),
    lot_id       VARCHAR(32),
    wo_id        VARCHAR(32),
    op_id        VARCHAR(32), op_name VARCHAR(64),
    op_start_at  DATETIME, op_end_at DATETIME,
    operator_id  VARCHAR(64),
    result       ENUM('PASS','FAIL','REWORK','HOLD'),
    station_id   VARCHAR(64),
    next_sn      VARCHAR(64),     -- æŒ‡å‘ä¸Šå±‚ï¼ˆç»„ä»¶â†’æˆå“ï¼‰çš„SN
    tenant_id    VARCHAR(32), site_id VARCHAR(32),
    created_at   DATETIME, updated_at DATETIME
  );
  CREATE INDEX idx_trace_link_sn   ON trace_link(sn);
  CREATE INDEX idx_trace_link_next ON trace_link(next_sn);
  ```
  
  > å¿«ç…§è¡¨å¯ç”± `trace_event` å®šæ—¶å›å¡«ï¼Œæå‡æŸ¥è¯¢é€Ÿåº¦ï¼›ç»“æ„ä¿æŒç¨³å®šï¼Œä¾¿äºåç»­éšæ—¶å¢åŠ å·¥åºæˆ–è¿½è¸ªèŠ‚ç‚¹ã€‚
  
  ### 10.7 å“è´¨ç è¡¨ä¸æ£€éªŒæ˜ç»†å¯¹é½

  ```sql
-- ç¼ºé™·/åŸå› /å¤„ç½® ä¸‰çº§å­—å…¸
  CREATE TABLE qms_code (
  code_type   VARCHAR(16),   -- DEFECT/CAUSE/ACTION
    code        VARCHAR(32),
    description VARCHAR(255),
    PRIMARY KEY (code_type, code)
  );
  
  -- æ£€éªŒæ˜ç»†å¯¹é½ç è¡¨
  ALTER TABLE inspection_item
    ADD COLUMN defect_code VARCHAR(32),
    ADD COLUMN cause_code  VARCHAR(32),
    ADD COLUMN action_code VARCHAR(32);
  ```
  
  ### 10.8 é™„ä»¶ä¸æµ‹é‡å…ƒæ•°æ®
  
  ```sql
ALTER TABLE attachment
    ADD COLUMN tenant_id VARCHAR(32),
  ADD COLUMN site_id   VARCHAR(32),
    ADD COLUMN biz_path  VARCHAR(128),
    ADD COLUMN checksum  CHAR(64);
  
  CREATE TABLE measure_record (
    id          BIGINT PRIMARY KEY AUTO_INCREMENT,
    insp_id     VARCHAR(32),
    item_key    VARCHAR(64),
    value_num   DECIMAL(18,6),
    unit        VARCHAR(16),
    measured_at DATETIME
  );
  ```
  
  ### 10.9 æ¡ç /äºŒç»´ç 
  
  - å»ºè®® Code128ï¼ˆæ¡ç ï¼‰+ QRï¼ˆäºŒç»´ç ï¼‰åŒåˆ¶å¼ï¼›
- å†…å®¹ï¼š`key|value` é”®å€¼æˆ– GS1ï¼ˆAI ç ï¼‰ï¼›
  - æœ€å°é›†åˆï¼š`sn/lot_id/wo_id/box_no/pallet_no`ã€‚

  ### 10.10 è¿½æº¯ API å¥‘çº¦ï¼ˆç¤ºä¾‹ï¼‰
  
  - `GET /trace/reverse?sn=...`

  ```json
{
    "sn": "SN-LOT-0001-0012",
  "lot": "LOT-20251007-0001",
    "wo": "WO-L1-8899",
    "operations": [
      {"op_name":"ç»ˆæ£€","start":"2025-10-07T09:00Z","end":"2025-10-07T09:05Z","operator":"OP123","result":"PASS"}
    ],
    "materials": [{"item_id":"ITM-202510-0012","supplier_id":"SUP-ACME","grn_id":"GRN-20251007-017"}],
    "quality": {"iqc":"PASS","oqc":"PASS","defect_top":[{"code":"SOLDER-01","cnt":3}]},
    "shipping": {"box_no":"BOX-20251007-008","pallet_no":"PLT-20251007-003","shipment_id":"SHP-20251007-002"}
  }
  ```
  
  ### 10.11 ç´¢å¼•/åˆ†åŒºä¸æ€§èƒ½
  
  - åˆ†åŒºï¼š`trace_event/test_record/inspection_item/stock_txn` æŒ‰æ—¥/å‘¨ï¼›
- è¦†ç›–ç´¢å¼•ï¼š`(entity_type,entity_id,occurred_at)`ã€`(sn,tested_at)`ã€`(box_no)`ã€`(pallet_no)`ï¼›
  - BI èµ°åªè¯»åº“ï¼Œäº‹åŠ¡èµ°ä¸»åº“ï¼›å¤§æŸ¥è¯¢é™æ—¶çª—+åˆ†é¡µã€‚

  ### 10.12 å­—æ®µæ¼”åŒ–ä¸æ‰©å±•æœºåˆ¶
  
  - **æ–°å¢å·¥åº**ï¼šä»…å¢ `operation` è¡Œï¼›
- **æ–°å¢è¿½è¸ªç‚¹**ï¼šä»…å¢ `trace_event.action`ï¼›
  - **æ–°å¢å­—æ®µ**ï¼šä¼˜å…ˆæ”¾ `data(JSON)`ï¼›
- **å¼ƒç”¨å­—æ®µ**ï¼šæ ‡æ³¨ `deprecated_at`ï¼Œé¿å…ç‰©ç†åˆ é™¤ã€‚
