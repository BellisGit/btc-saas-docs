# æƒé™æ§åˆ¶æŸ¥è¯¢ç¤ºä¾‹

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£æä¾›äº†åŸºäºä¼˜åŒ–åçš„ç³»ç»ŸåŸºç¡€è¡¨çš„æƒé™æ§åˆ¶æŸ¥è¯¢ç¤ºä¾‹ï¼ŒåŒ…æ‹¬èœå•è®¿é—®ã€æŒ‰é’®æƒé™ã€æ•°æ®æƒé™ç­‰å¸¸è§åœºæ™¯ã€‚

---

## ğŸ” åŸºç¡€æŸ¥è¯¢

### 1. è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯

```sql
-- è·å–ç”¨æˆ·åŸºæœ¬ä¿¡æ¯ï¼ˆåŒ…å«éƒ¨é—¨ä¿¡æ¯ï¼‰
SELECT 
    u.user_id,
    u.username,
    u.real_name,
    u.email,
    u.phone,
    u.status,
    u.user_type,
    t.tenant_name,
    d.dept_name,
    d.dept_type
FROM sys_user u
LEFT JOIN tenant t ON u.tenant_id = t.tenant_id
LEFT JOIN sys_dept d ON u.dept_id = d.dept_id
WHERE u.user_id = ? AND u.status = 'ACTIVE';
```

### 2. è·å–ç”¨æˆ·è§’è‰²ä¿¡æ¯

```sql
-- è·å–ç”¨æˆ·çš„æ‰€æœ‰è§’è‰²
SELECT 
    r.role_id,
    r.role_code,
    r.role_name,
    r.role_type,
    r.data_scope,
    r.description
FROM sys_user u
JOIN sys_user_role ur ON u.user_id = ur.user_id
JOIN sys_role r ON ur.role_id = r.role_id
WHERE u.user_id = ? AND u.status = 'ACTIVE' AND r.status = 'ACTIVE';
```

---

## ğŸ“± èœå•æƒé™æ§åˆ¶

### 1. è·å–ç”¨æˆ·å¯è®¿é—®çš„èœå•æ ‘

```sql
-- é€’å½’æŸ¥è¯¢ç”¨æˆ·å¯è®¿é—®çš„èœå•æ ‘
WITH RECURSIVE menu_tree AS (
    -- æ ¹èŠ‚ç‚¹ï¼šç”¨æˆ·æœ‰æƒé™çš„é¡¶çº§ç›®å½•
    SELECT 
        p.permission_id,
        p.permission_code,
        p.permission_name,
        p.permission_type,
        p.parent_id,
        p.path,
        p.component,
        p.icon,
        p.sort_order,
        p.visible,
        1 as level
    FROM sys_user u
    JOIN sys_user_role ur ON u.user_id = ur.user_id
    JOIN sys_role_permission rp ON ur.role_id = rp.role_id
    JOIN sys_permission p ON rp.permission_id = p.permission_id
    WHERE u.user_id = ?
      AND u.status = 'ACTIVE'
      AND p.permission_type = 'DIRECTORY'
      AND p.status = 'ACTIVE'
      AND p.visible = TRUE
    
    UNION ALL
    
    -- å­èŠ‚ç‚¹ï¼šé€’å½’æŸ¥è¯¢å­èœå•
    SELECT 
        p.permission_id,
        p.permission_code,
        p.permission_name,
        p.permission_type,
        p.parent_id,
        p.path,
        p.component,
        p.icon,
        p.sort_order,
        p.visible,
        mt.level + 1
    FROM sys_permission p
    JOIN menu_tree mt ON p.parent_id = mt.permission_id
    JOIN sys_user u ON p.tenant_id = u.tenant_id
    JOIN sys_user_role ur ON u.user_id = ur.user_id
    JOIN sys_role_permission rp ON ur.role_id = rp.role_id AND rp.permission_id = p.permission_id
    WHERE u.user_id = ?
      AND u.status = 'ACTIVE'
      AND p.permission_type IN ('MENU', 'DIRECTORY')
      AND p.status = 'ACTIVE'
      AND p.visible = TRUE
)
SELECT * FROM menu_tree
ORDER BY level, sort_order;
```

### 2. ç®€åŒ–ç‰ˆèœå•æŸ¥è¯¢ï¼ˆé€‚ç”¨äºèœå•å±‚çº§ä¸æ·±çš„æƒ…å†µï¼‰

```sql
-- è·å–ç”¨æˆ·å¯è®¿é—®çš„èœå•ï¼ˆç®€åŒ–ç‰ˆï¼‰
SELECT DISTINCT
    p.permission_id,
    p.permission_code,
    p.permission_name,
    p.permission_type,
    p.parent_id,
    p.path,
    p.component,
    p.icon,
    p.sort_order,
    p.visible
FROM sys_user u
JOIN sys_user_role ur ON u.user_id = ur.user_id
JOIN sys_role_permission rp ON ur.role_id = rp.role_id
JOIN sys_permission p ON rp.permission_id = p.permission_id
WHERE u.user_id = ?
  AND u.status = 'ACTIVE'
  AND p.permission_type IN ('DIRECTORY', 'MENU')
  AND p.status = 'ACTIVE'
  AND p.visible = TRUE
ORDER BY p.sort_order;
```

---

## ğŸ”˜ æŒ‰é’®æƒé™æ§åˆ¶

### 1. æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰ç‰¹å®šæŒ‰é’®æƒé™

```sql
-- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰ç‰¹å®šæŒ‰é’®æƒé™
SELECT COUNT(*) > 0 as has_permission
FROM sys_user u
JOIN sys_user_role ur ON u.user_id = ur.user_id
JOIN sys_role_permission rp ON ur.role_id = rp.role_id
JOIN sys_permission p ON rp.permission_id = p.permission_id
WHERE u.user_id = ?
  AND p.permission_code = ?
  AND p.permission_type = 'BUTTON'
  AND u.status = 'ACTIVE'
  AND p.status = 'ACTIVE';
```

### 2. è·å–ç”¨æˆ·åœ¨æŸé¡µé¢ä¸‹çš„æ‰€æœ‰æŒ‰é’®æƒé™

```sql
-- è·å–ç”¨æˆ·åœ¨æŸé¡µé¢ä¸‹çš„æ‰€æœ‰æŒ‰é’®æƒé™
SELECT 
    p.permission_code,
    p.permission_name
FROM sys_user u
JOIN sys_user_role ur ON u.user_id = ur.user_id
JOIN sys_role_permission rp ON ur.role_id = rp.role_id
JOIN sys_permission p ON rp.permission_id = p.permission_id
WHERE u.user_id = ?
  AND p.parent_id = (
    SELECT permission_id FROM sys_permission 
    WHERE permission_code = ? AND permission_type = 'MENU'
  )
  AND p.permission_type = 'BUTTON'
  AND u.status = 'ACTIVE'
  AND p.status = 'ACTIVE';
```

---

## ğŸ” APIæƒé™æ§åˆ¶

### 1. æ£€æŸ¥APIè®¿é—®æƒé™

```sql
-- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰APIè®¿é—®æƒé™
SELECT COUNT(*) > 0 as has_api_permission
FROM sys_user u
JOIN sys_user_role ur ON u.user_id = ur.user_id
JOIN sys_role_permission rp ON ur.role_id = rp.role_id
JOIN sys_permission p ON rp.permission_id = p.permission_id
WHERE u.user_id = ?
  AND p.permission_code = ?
  AND p.permission_type = 'API'
  AND u.status = 'ACTIVE'
  AND p.status = 'ACTIVE';
```

### 2. è·å–ç”¨æˆ·çš„æ‰€æœ‰APIæƒé™

```sql
-- è·å–ç”¨æˆ·çš„æ‰€æœ‰APIæƒé™
SELECT 
    p.permission_code,
    p.permission_name,
    p.path
FROM sys_user u
JOIN sys_user_role ur ON u.user_id = ur.user_id
JOIN sys_role_permission rp ON ur.role_id = rp.role_id
JOIN sys_permission p ON rp.permission_id = p.permission_id
WHERE u.user_id = ?
  AND p.permission_type = 'API'
  AND u.status = 'ACTIVE'
  AND p.status = 'ACTIVE';
```

---

## ğŸ“Š æ•°æ®æƒé™æ§åˆ¶

### 1. æ ¹æ®æ•°æ®æƒé™èŒƒå›´è¿‡æ»¤æ•°æ®

```sql
-- æ ¹æ®ç”¨æˆ·çš„æ•°æ®æƒé™èŒƒå›´è¿‡æ»¤ä¸šåŠ¡æ•°æ®
SELECT * FROM your_business_table bt
WHERE CASE (
    SELECT r.data_scope 
    FROM sys_user u
    JOIN sys_user_role ur ON u.user_id = ur.user_id
    JOIN sys_role r ON ur.role_id = r.role_id
    WHERE u.user_id = ?
    LIMIT 1
)
WHEN 'ALL' THEN 1=1
WHEN 'SELF' THEN bt.created_by = ?
WHEN 'DEPT' THEN bt.dept_id = (
    SELECT dept_id FROM sys_user WHERE user_id = ?
)
WHEN 'DEPT_AND_CHILD' THEN bt.dept_id IN (
    WITH RECURSIVE dept_tree AS (
        SELECT dept_id FROM sys_dept WHERE dept_id = (
            SELECT dept_id FROM sys_user WHERE user_id = ?
        )
        UNION ALL
        SELECT d.dept_id FROM sys_dept d
        JOIN dept_tree dt ON d.parent_id = dt.dept_id
    )
    SELECT dept_id FROM dept_tree
)
ELSE 1=0 END;
```

### 2. éƒ¨é—¨æ•°æ®æƒé™æŸ¥è¯¢ï¼ˆç®€åŒ–ç‰ˆï¼‰

```sql
-- è·å–ç”¨æˆ·å¯è®¿é—®çš„éƒ¨é—¨æ•°æ®
SELECT * FROM your_business_table bt
WHERE bt.dept_id IN (
    SELECT dept_id FROM sys_user WHERE user_id = ?
    UNION
    SELECT dept_id FROM sys_dept WHERE parent_id = (
        SELECT dept_id FROM sys_user WHERE user_id = ?
    )
);
```

---

## ğŸ¢ éƒ¨é—¨æƒé™æ§åˆ¶

### 1. è·å–éƒ¨é—¨æ ‘ç»“æ„

```sql
-- é€’å½’è·å–éƒ¨é—¨æ ‘ç»“æ„
WITH RECURSIVE dept_tree AS (
    -- æ ¹éƒ¨é—¨
    SELECT 
        dept_id,
        dept_code,
        dept_name,
        parent_id,
        dept_type,
        manager_id,
        sort_order,
        1 as level
    FROM sys_dept
    WHERE parent_id IS NULL AND tenant_id = ?
    
    UNION ALL
    
    -- å­éƒ¨é—¨
    SELECT 
        d.dept_id,
        d.dept_code,
        d.dept_name,
        d.parent_id,
        d.dept_type,
        d.manager_id,
        d.sort_order,
        dt.level + 1
    FROM sys_dept d
    JOIN dept_tree dt ON d.parent_id = dt.dept_id
)
SELECT * FROM dept_tree
ORDER BY level, sort_order;
```

### 2. è·å–ç”¨æˆ·å¯ç®¡ç†çš„éƒ¨é—¨

```sql
-- è·å–ç”¨æˆ·å¯ç®¡ç†çš„éƒ¨é—¨ï¼ˆåŒ…æ‹¬å­éƒ¨é—¨ï¼‰
WITH RECURSIVE managed_depts AS (
    -- ç”¨æˆ·æ‰€åœ¨éƒ¨é—¨
    SELECT dept_id FROM sys_user WHERE user_id = ?
    
    UNION ALL
    
    -- ç”¨æˆ·ä½œä¸ºè´Ÿè´£äººçš„éƒ¨é—¨
    SELECT dept_id FROM sys_dept WHERE manager_id = ?
    
    UNION ALL
    
    -- å­éƒ¨é—¨
    SELECT d.dept_id FROM sys_dept d
    JOIN managed_depts md ON d.parent_id = md.dept_id
)
SELECT DISTINCT d.* FROM sys_dept d
JOIN managed_depts md ON d.dept_id = md.dept_id
WHERE d.status = 'ACTIVE';
```

---

## ğŸ” æƒé™éªŒè¯å­˜å‚¨è¿‡ç¨‹

### 1. æƒé™éªŒè¯å­˜å‚¨è¿‡ç¨‹

```sql
DELIMITER $$

CREATE PROCEDURE CheckUserPermission(
    IN p_user_id VARCHAR(32),
    IN p_permission_code VARCHAR(128),
    OUT p_has_permission BOOLEAN
)
BEGIN
    DECLARE permission_count INT DEFAULT 0;
    
    SELECT COUNT(*) INTO permission_count
    FROM sys_user u
    JOIN sys_user_role ur ON u.user_id = ur.user_id
    JOIN sys_role_permission rp ON ur.role_id = rp.role_id
    JOIN sys_permission p ON rp.permission_id = p.permission_id
    WHERE u.user_id = p_user_id
      AND p.permission_code = p_permission_code
      AND u.status = 'ACTIVE'
      AND p.status = 'ACTIVE';
    
    SET p_has_permission = (permission_count > 0);
END$$

DELIMITER ;
```

### 2. ä½¿ç”¨ç¤ºä¾‹

```sql
-- è°ƒç”¨æƒé™éªŒè¯å­˜å‚¨è¿‡ç¨‹
CALL CheckUserPermission('USER_001', 'system:user:add', @has_permission);
SELECT @has_permission;
```

---

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. ç´¢å¼•ä¼˜åŒ–

```sql
-- ä¸ºæƒé™æŸ¥è¯¢åˆ›å»ºå¤åˆç´¢å¼•
CREATE INDEX idx_user_role_permission ON sys_user_role(user_id, role_id);
CREATE INDEX idx_role_permission ON sys_role_permission(role_id, permission_id);
CREATE INDEX idx_permission_code_type ON sys_permission(permission_code, permission_type, status);
CREATE INDEX idx_user_status ON sys_user(user_id, status);
```

### 2. ç¼“å­˜ç­–ç•¥

- **èœå•æƒé™**: ç¼“å­˜ç”¨æˆ·èœå•æ ‘ï¼Œå®šæœŸæ›´æ–°
- **æŒ‰é’®æƒé™**: ç¼“å­˜ç”¨æˆ·æŒ‰é’®æƒé™åˆ—è¡¨
- **æ•°æ®æƒé™**: ç¼“å­˜ç”¨æˆ·æ•°æ®æƒé™èŒƒå›´

### 3. æŸ¥è¯¢ä¼˜åŒ–

- ä½¿ç”¨EXISTSæ›¿ä»£INå­æŸ¥è¯¢
- é¿å…åœ¨WHEREå­å¥ä¸­ä½¿ç”¨å‡½æ•°
- åˆç†ä½¿ç”¨LIMITé™åˆ¶ç»“æœé›†

---

## ğŸ”§ åº”ç”¨å±‚é›†æˆç¤ºä¾‹

### 1. Java Spring Securityé›†æˆ

```java
@Service
public class PermissionService {
    
    @Autowired
    private UserMapper userMapper;
    
    // æ£€æŸ¥ç”¨æˆ·æƒé™
    public boolean hasPermission(String userId, String permissionCode) {
        return userMapper.checkUserPermission(userId, permissionCode) > 0;
    }
    
    // è·å–ç”¨æˆ·èœå•
    public List<MenuVO> getUserMenus(String userId) {
        return userMapper.getUserMenus(userId);
    }
    
    // è·å–ç”¨æˆ·æŒ‰é’®æƒé™
    public List<String> getUserButtonPermissions(String userId, String menuCode) {
        return userMapper.getUserButtonPermissions(userId, menuCode);
    }
}
```

### 2. Vueå‰ç«¯æƒé™æ§åˆ¶

```javascript
// æƒé™æ··å…¥
export const permissionMixin = {
  methods: {
    // æ£€æŸ¥æŒ‰é’®æƒé™
    hasPermission(permissionCode) {
      return this.$store.getters.permissions.includes(permissionCode);
    },
    
    // æ£€æŸ¥èœå•æƒé™
    hasMenuPermission(menuCode) {
      return this.$store.getters.menus.some(menu => menu.permission_code === menuCode);
    }
  }
};

// æƒé™æŒ‡ä»¤
Vue.directive('permission', {
  inserted(el, binding) {
    const permission = binding.value;
    if (!hasPermission(permission)) {
      el.parentNode.removeChild(el);
    }
  }
});
```

---

## ğŸ“‹ æ€»ç»“

é€šè¿‡ä»¥ä¸ŠæŸ¥è¯¢ç¤ºä¾‹ï¼Œæˆ‘ä»¬å¯ä»¥å®ç°ï¼š

1. **èœå•æƒé™æ§åˆ¶**: åŠ¨æ€ç”Ÿæˆç”¨æˆ·å¯è®¿é—®çš„èœå•æ ‘
2. **æŒ‰é’®æƒé™æ§åˆ¶**: ç²¾ç¡®æ§åˆ¶é¡µé¢æŒ‰é’®çš„æ˜¾ç¤ºå’Œéšè—
3. **APIæƒé™æ§åˆ¶**: åç«¯æ¥å£çš„è®¿é—®æƒé™éªŒè¯
4. **æ•°æ®æƒé™æ§åˆ¶**: åŸºäºéƒ¨é—¨çš„æ•°æ®è®¿é—®èŒƒå›´æ§åˆ¶
5. **æ€§èƒ½ä¼˜åŒ–**: é€šè¿‡ç´¢å¼•å’Œç¼“å­˜æå‡æŸ¥è¯¢æ€§èƒ½

è¿™äº›æŸ¥è¯¢ç¤ºä¾‹ä¸ºç³»ç»Ÿçš„æƒé™æ§åˆ¶æä¾›äº†å®Œæ•´çš„æŠ€æœ¯æ–¹æ¡ˆï¼Œå¯ä»¥æ ¹æ®å®é™…ä¸šåŠ¡éœ€æ±‚è¿›è¡Œè°ƒæ•´å’Œæ‰©å±•ã€‚
