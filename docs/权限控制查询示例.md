# 权限控制查询示例

## 📋 概述

本文档提供了基于优化后的系统基础表的权限控制查询示例，包括菜单访问、按钮权限、数据权限等常见场景。

---

## 🔍 基础查询

### 1. 获取用户基本信息

```sql
-- 获取用户基本信息（包含部门信息）
SELECT 
    u.user_id,
    u.username,
    u.real_name,
    u.email,
    u.phone,
    u.status,
    u.user_type,
    t.tenant_name,
    d.dept_name,
    d.dept_type
FROM sys_user u
LEFT JOIN tenant t ON u.tenant_id = t.tenant_id
LEFT JOIN sys_dept d ON u.dept_id = d.dept_id
WHERE u.user_id = ? AND u.status = 'ACTIVE';
```

### 2. 获取用户角色信息

```sql
-- 获取用户的所有角色
SELECT 
    r.role_id,
    r.role_code,
    r.role_name,
    r.role_type,
    r.data_scope,
    r.description
FROM sys_user u
JOIN sys_user_role ur ON u.user_id = ur.user_id
JOIN sys_role r ON ur.role_id = r.role_id
WHERE u.user_id = ? AND u.status = 'ACTIVE' AND r.status = 'ACTIVE';
```

---

## 📱 菜单权限控制

### 1. 获取用户可访问的菜单树

```sql
-- 递归查询用户可访问的菜单树
WITH RECURSIVE menu_tree AS (
    -- 根节点：用户有权限的顶级目录
    SELECT 
        p.permission_id,
        p.permission_code,
        p.permission_name,
        p.permission_type,
        p.parent_id,
        p.path,
        p.component,
        p.icon,
        p.sort_order,
        p.visible,
        1 as level
    FROM sys_user u
    JOIN sys_user_role ur ON u.user_id = ur.user_id
    JOIN sys_role_permission rp ON ur.role_id = rp.role_id
    JOIN sys_permission p ON rp.permission_id = p.permission_id
    WHERE u.user_id = ?
      AND u.status = 'ACTIVE'
      AND p.permission_type = 'DIRECTORY'
      AND p.status = 'ACTIVE'
      AND p.visible = TRUE
    
    UNION ALL
    
    -- 子节点：递归查询子菜单
    SELECT 
        p.permission_id,
        p.permission_code,
        p.permission_name,
        p.permission_type,
        p.parent_id,
        p.path,
        p.component,
        p.icon,
        p.sort_order,
        p.visible,
        mt.level + 1
    FROM sys_permission p
    JOIN menu_tree mt ON p.parent_id = mt.permission_id
    JOIN sys_user u ON p.tenant_id = u.tenant_id
    JOIN sys_user_role ur ON u.user_id = ur.user_id
    JOIN sys_role_permission rp ON ur.role_id = rp.role_id AND rp.permission_id = p.permission_id
    WHERE u.user_id = ?
      AND u.status = 'ACTIVE'
      AND p.permission_type IN ('MENU', 'DIRECTORY')
      AND p.status = 'ACTIVE'
      AND p.visible = TRUE
)
SELECT * FROM menu_tree
ORDER BY level, sort_order;
```

### 2. 简化版菜单查询（适用于菜单层级不深的情况）

```sql
-- 获取用户可访问的菜单（简化版）
SELECT DISTINCT
    p.permission_id,
    p.permission_code,
    p.permission_name,
    p.permission_type,
    p.parent_id,
    p.path,
    p.component,
    p.icon,
    p.sort_order,
    p.visible
FROM sys_user u
JOIN sys_user_role ur ON u.user_id = ur.user_id
JOIN sys_role_permission rp ON ur.role_id = rp.role_id
JOIN sys_permission p ON rp.permission_id = p.permission_id
WHERE u.user_id = ?
  AND u.status = 'ACTIVE'
  AND p.permission_type IN ('DIRECTORY', 'MENU')
  AND p.status = 'ACTIVE'
  AND p.visible = TRUE
ORDER BY p.sort_order;
```

---

## 🔘 按钮权限控制

### 1. 检查用户是否有特定按钮权限

```sql
-- 检查用户是否有特定按钮权限
SELECT COUNT(*) > 0 as has_permission
FROM sys_user u
JOIN sys_user_role ur ON u.user_id = ur.user_id
JOIN sys_role_permission rp ON ur.role_id = rp.role_id
JOIN sys_permission p ON rp.permission_id = p.permission_id
WHERE u.user_id = ?
  AND p.permission_code = ?
  AND p.permission_type = 'BUTTON'
  AND u.status = 'ACTIVE'
  AND p.status = 'ACTIVE';
```

### 2. 获取用户在某页面下的所有按钮权限

```sql
-- 获取用户在某页面下的所有按钮权限
SELECT 
    p.permission_code,
    p.permission_name
FROM sys_user u
JOIN sys_user_role ur ON u.user_id = ur.user_id
JOIN sys_role_permission rp ON ur.role_id = rp.role_id
JOIN sys_permission p ON rp.permission_id = p.permission_id
WHERE u.user_id = ?
  AND p.parent_id = (
    SELECT permission_id FROM sys_permission 
    WHERE permission_code = ? AND permission_type = 'MENU'
  )
  AND p.permission_type = 'BUTTON'
  AND u.status = 'ACTIVE'
  AND p.status = 'ACTIVE';
```

---

## 🔐 API权限控制

### 1. 检查API访问权限

```sql
-- 检查用户是否有API访问权限
SELECT COUNT(*) > 0 as has_api_permission
FROM sys_user u
JOIN sys_user_role ur ON u.user_id = ur.user_id
JOIN sys_role_permission rp ON ur.role_id = rp.role_id
JOIN sys_permission p ON rp.permission_id = p.permission_id
WHERE u.user_id = ?
  AND p.permission_code = ?
  AND p.permission_type = 'API'
  AND u.status = 'ACTIVE'
  AND p.status = 'ACTIVE';
```

### 2. 获取用户的所有API权限

```sql
-- 获取用户的所有API权限
SELECT 
    p.permission_code,
    p.permission_name,
    p.path
FROM sys_user u
JOIN sys_user_role ur ON u.user_id = ur.user_id
JOIN sys_role_permission rp ON ur.role_id = rp.role_id
JOIN sys_permission p ON rp.permission_id = p.permission_id
WHERE u.user_id = ?
  AND p.permission_type = 'API'
  AND u.status = 'ACTIVE'
  AND p.status = 'ACTIVE';
```

---

## 📊 数据权限控制

### 1. 根据数据权限范围过滤数据

```sql
-- 根据用户的数据权限范围过滤业务数据
SELECT * FROM your_business_table bt
WHERE CASE (
    SELECT r.data_scope 
    FROM sys_user u
    JOIN sys_user_role ur ON u.user_id = ur.user_id
    JOIN sys_role r ON ur.role_id = r.role_id
    WHERE u.user_id = ?
    LIMIT 1
)
WHEN 'ALL' THEN 1=1
WHEN 'SELF' THEN bt.created_by = ?
WHEN 'DEPT' THEN bt.dept_id = (
    SELECT dept_id FROM sys_user WHERE user_id = ?
)
WHEN 'DEPT_AND_CHILD' THEN bt.dept_id IN (
    WITH RECURSIVE dept_tree AS (
        SELECT dept_id FROM sys_dept WHERE dept_id = (
            SELECT dept_id FROM sys_user WHERE user_id = ?
        )
        UNION ALL
        SELECT d.dept_id FROM sys_dept d
        JOIN dept_tree dt ON d.parent_id = dt.dept_id
    )
    SELECT dept_id FROM dept_tree
)
ELSE 1=0 END;
```

### 2. 部门数据权限查询（简化版）

```sql
-- 获取用户可访问的部门数据
SELECT * FROM your_business_table bt
WHERE bt.dept_id IN (
    SELECT dept_id FROM sys_user WHERE user_id = ?
    UNION
    SELECT dept_id FROM sys_dept WHERE parent_id = (
        SELECT dept_id FROM sys_user WHERE user_id = ?
    )
);
```

---

## 🏢 部门权限控制

### 1. 获取部门树结构

```sql
-- 递归获取部门树结构
WITH RECURSIVE dept_tree AS (
    -- 根部门
    SELECT 
        dept_id,
        dept_code,
        dept_name,
        parent_id,
        dept_type,
        manager_id,
        sort_order,
        1 as level
    FROM sys_dept
    WHERE parent_id IS NULL AND tenant_id = ?
    
    UNION ALL
    
    -- 子部门
    SELECT 
        d.dept_id,
        d.dept_code,
        d.dept_name,
        d.parent_id,
        d.dept_type,
        d.manager_id,
        d.sort_order,
        dt.level + 1
    FROM sys_dept d
    JOIN dept_tree dt ON d.parent_id = dt.dept_id
)
SELECT * FROM dept_tree
ORDER BY level, sort_order;
```

### 2. 获取用户可管理的部门

```sql
-- 获取用户可管理的部门（包括子部门）
WITH RECURSIVE managed_depts AS (
    -- 用户所在部门
    SELECT dept_id FROM sys_user WHERE user_id = ?
    
    UNION ALL
    
    -- 用户作为负责人的部门
    SELECT dept_id FROM sys_dept WHERE manager_id = ?
    
    UNION ALL
    
    -- 子部门
    SELECT d.dept_id FROM sys_dept d
    JOIN managed_depts md ON d.parent_id = md.dept_id
)
SELECT DISTINCT d.* FROM sys_dept d
JOIN managed_depts md ON d.dept_id = md.dept_id
WHERE d.status = 'ACTIVE';
```

---

## 🔍 权限验证存储过程

### 1. 权限验证存储过程

```sql
DELIMITER $$

CREATE PROCEDURE CheckUserPermission(
    IN p_user_id VARCHAR(32),
    IN p_permission_code VARCHAR(128),
    OUT p_has_permission BOOLEAN
)
BEGIN
    DECLARE permission_count INT DEFAULT 0;
    
    SELECT COUNT(*) INTO permission_count
    FROM sys_user u
    JOIN sys_user_role ur ON u.user_id = ur.user_id
    JOIN sys_role_permission rp ON ur.role_id = rp.role_id
    JOIN sys_permission p ON rp.permission_id = p.permission_id
    WHERE u.user_id = p_user_id
      AND p.permission_code = p_permission_code
      AND u.status = 'ACTIVE'
      AND p.status = 'ACTIVE';
    
    SET p_has_permission = (permission_count > 0);
END$$

DELIMITER ;
```

### 2. 使用示例

```sql
-- 调用权限验证存储过程
CALL CheckUserPermission('USER_001', 'system:user:add', @has_permission);
SELECT @has_permission;
```

---

## 📈 性能优化建议

### 1. 索引优化

```sql
-- 为权限查询创建复合索引
CREATE INDEX idx_user_role_permission ON sys_user_role(user_id, role_id);
CREATE INDEX idx_role_permission ON sys_role_permission(role_id, permission_id);
CREATE INDEX idx_permission_code_type ON sys_permission(permission_code, permission_type, status);
CREATE INDEX idx_user_status ON sys_user(user_id, status);
```

### 2. 缓存策略

- **菜单权限**: 缓存用户菜单树，定期更新
- **按钮权限**: 缓存用户按钮权限列表
- **数据权限**: 缓存用户数据权限范围

### 3. 查询优化

- 使用EXISTS替代IN子查询
- 避免在WHERE子句中使用函数
- 合理使用LIMIT限制结果集

---

## 🔧 应用层集成示例

### 1. Java Spring Security集成

```java
@Service
public class PermissionService {
    
    @Autowired
    private UserMapper userMapper;
    
    // 检查用户权限
    public boolean hasPermission(String userId, String permissionCode) {
        return userMapper.checkUserPermission(userId, permissionCode) > 0;
    }
    
    // 获取用户菜单
    public List<MenuVO> getUserMenus(String userId) {
        return userMapper.getUserMenus(userId);
    }
    
    // 获取用户按钮权限
    public List<String> getUserButtonPermissions(String userId, String menuCode) {
        return userMapper.getUserButtonPermissions(userId, menuCode);
    }
}
```

### 2. Vue前端权限控制

```javascript
// 权限混入
export const permissionMixin = {
  methods: {
    // 检查按钮权限
    hasPermission(permissionCode) {
      return this.$store.getters.permissions.includes(permissionCode);
    },
    
    // 检查菜单权限
    hasMenuPermission(menuCode) {
      return this.$store.getters.menus.some(menu => menu.permission_code === menuCode);
    }
  }
};

// 权限指令
Vue.directive('permission', {
  inserted(el, binding) {
    const permission = binding.value;
    if (!hasPermission(permission)) {
      el.parentNode.removeChild(el);
    }
  }
});
```

---

## 📋 总结

通过以上查询示例，我们可以实现：

1. **菜单权限控制**: 动态生成用户可访问的菜单树
2. **按钮权限控制**: 精确控制页面按钮的显示和隐藏
3. **API权限控制**: 后端接口的访问权限验证
4. **数据权限控制**: 基于部门的数据访问范围控制
5. **性能优化**: 通过索引和缓存提升查询性能

这些查询示例为系统的权限控制提供了完整的技术方案，可以根据实际业务需求进行调整和扩展。
