# 系统基础表审查报告

## 📋 审查概述

**审查范围**: 系统基础表设计（不包含站点管理）
**审查时间**: 2025-01-07
**审查目标**: 优化用户、角色、权限、菜单之间的关联关系

---

## 🔍 当前设计分析

### 现有表结构

| 表名 | 功能描述 | 问题分析 |
|------|----------|----------|
| `tenant` | 租户管理 | ✅ 设计合理 |
| `sys_user` | 系统用户 | ⚠️ 缺少部门字段，外键关联站点 |
| `sys_role` | 系统角色 | ✅ 设计合理 |
| `sys_permission` | 系统权限 | ⚠️ 与菜单表功能重复 |
| `sys_menu` | 系统菜单 | ⚠️ 与权限表功能重复 |
| `sys_user_role` | 用户角色关联 | ✅ 设计合理 |
| `sys_role_permission` | 角色权限关联 | ⚠️ 缺少菜单关联 |

---

## ❗ 发现的问题

### 1. **权限与菜单表功能重复**
- `sys_permission` 和 `sys_menu` 都包含菜单相关字段
- 造成数据冗余和维护困难
- 权限控制逻辑复杂

### 2. **缺少用户部门管理**
- 用户表没有部门字段
- 无法实现部门级权限控制
- 缺少组织架构管理

### 3. **菜单权限关联不清晰**
- 角色权限表只关联权限，没有直接关联菜单
- 菜单访问控制逻辑复杂
- 前端菜单渲染需要多层查询

### 4. **数据权限控制不完善**
- 角色表有数据权限范围字段，但缺少具体实现
- 无法实现行级权限控制

---

## ✅ 优化方案

### 方案1: 权限菜单合并（推荐）

#### 核心思路
- 将 `sys_permission` 和 `sys_menu` 合并为一个表
- 通过权限类型区分菜单、按钮、API权限
- 简化权限控制逻辑

#### 优化后的表结构

```sql
-- 1. 租户表（保持不变）
CREATE TABLE tenant (
    tenant_id VARCHAR(32) PRIMARY KEY COMMENT '租户ID',
    tenant_code VARCHAR(64) NOT NULL UNIQUE COMMENT '租户代码',
    tenant_name VARCHAR(128) NOT NULL COMMENT '租户名称',
    tenant_type ENUM('ENTERPRISE', 'SMALL_MEDIUM', 'INDIVIDUAL') DEFAULT 'ENTERPRISE' COMMENT '租户类型',
    status ENUM('ACTIVE', 'INACTIVE', 'SUSPENDED') DEFAULT 'ACTIVE' COMMENT '状态',
    contact_person VARCHAR(64) COMMENT '联系人',
    contact_phone VARCHAR(32) COMMENT '联系电话',
    contact_email VARCHAR(128) COMMENT '联系邮箱',
    address TEXT COMMENT '地址',
    industry VARCHAR(64) COMMENT '行业',
    scale VARCHAR(32) COMMENT '规模',
    logo_url VARCHAR(255) COMMENT 'Logo URL',
    settings JSON COMMENT '租户配置',
    subscription_plan VARCHAR(32) COMMENT '订阅计划',
    subscription_expire DATETIME COMMENT '订阅过期时间',
    created_by VARCHAR(64) NOT NULL,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_by VARCHAR(64),
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_tenant_code (tenant_code),
    INDEX idx_tenant_name (tenant_name),
    INDEX idx_status (status),
    INDEX idx_subscription_expire (subscription_expire)
) COMMENT '租户管理表';

-- 2. 部门表（新增）
CREATE TABLE sys_dept (
    dept_id VARCHAR(32) PRIMARY KEY COMMENT '部门ID',
    tenant_id VARCHAR(32) NOT NULL COMMENT '租户ID',
    dept_code VARCHAR(64) NOT NULL COMMENT '部门代码',
    dept_name VARCHAR(128) NOT NULL COMMENT '部门名称',
    parent_id VARCHAR(32) COMMENT '父部门ID',
    dept_type ENUM('COMPANY', 'DEPARTMENT', 'TEAM', 'GROUP') DEFAULT 'DEPARTMENT' COMMENT '部门类型',
    manager_id VARCHAR(32) COMMENT '部门负责人ID',
    sort_order INT DEFAULT 0 COMMENT '排序',
    status ENUM('ACTIVE', 'INACTIVE') DEFAULT 'ACTIVE' COMMENT '状态',
    created_by VARCHAR(64) NOT NULL,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_by VARCHAR(64),
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_tenant (tenant_id),
    INDEX idx_parent_id (parent_id),
    INDEX idx_status (status),
    FOREIGN KEY (tenant_id) REFERENCES tenant(tenant_id),
    FOREIGN KEY (parent_id) REFERENCES sys_dept(dept_id)
) COMMENT '部门表';

-- 3. 用户表（优化）
CREATE TABLE sys_user (
    user_id VARCHAR(32) PRIMARY KEY COMMENT '用户ID',
    tenant_id VARCHAR(32) NOT NULL COMMENT '租户ID',
    dept_id VARCHAR(32) COMMENT '部门ID',
    username VARCHAR(64) NOT NULL UNIQUE COMMENT '用户名',
    password_hash VARCHAR(255) NOT NULL COMMENT '密码哈希',
    email VARCHAR(128) COMMENT '邮箱',
    phone VARCHAR(32) COMMENT '手机号',
    real_name VARCHAR(64) COMMENT '真实姓名',
    nickname VARCHAR(64) COMMENT '昵称',
    avatar_url VARCHAR(255) COMMENT '头像URL',
    gender ENUM('MALE', 'FEMALE', 'UNKNOWN') DEFAULT 'UNKNOWN' COMMENT '性别',
    birthday DATE COMMENT '生日',
    status ENUM('ACTIVE', 'INACTIVE', 'LOCKED', 'EXPIRED') DEFAULT 'ACTIVE' COMMENT '状态',
    user_type ENUM('SYSTEM', 'TENANT', 'EMPLOYEE', 'EXTERNAL') DEFAULT 'TENANT' COMMENT '用户类型',
    last_login_time DATETIME COMMENT '最后登录时间',
    last_login_ip VARCHAR(45) COMMENT '最后登录IP',
    login_count INT DEFAULT 0 COMMENT '登录次数',
    password_update_time DATETIME COMMENT '密码更新时间',
    account_expire_time DATETIME COMMENT '账户过期时间',
    password_expire_time DATETIME COMMENT '密码过期时间',
    created_by VARCHAR(64) NOT NULL,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_by VARCHAR(64),
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_tenant (tenant_id),
    INDEX idx_dept (dept_id),
    INDEX idx_username (username),
    INDEX idx_email (email),
    INDEX idx_phone (phone),
    INDEX idx_status (status),
    INDEX idx_user_type (user_type),
    FOREIGN KEY (tenant_id) REFERENCES tenant(tenant_id),
    FOREIGN KEY (dept_id) REFERENCES sys_dept(dept_id)
) COMMENT '系统用户表';

-- 4. 角色表（保持不变）
CREATE TABLE sys_role (
    role_id VARCHAR(32) PRIMARY KEY COMMENT '角色ID',
    tenant_id VARCHAR(32) NOT NULL COMMENT '租户ID',
    role_code VARCHAR(64) NOT NULL COMMENT '角色代码',
    role_name VARCHAR(128) NOT NULL COMMENT '角色名称',
    role_type ENUM('SYSTEM', 'TENANT', 'CUSTOM') DEFAULT 'TENANT' COMMENT '角色类型',
    description TEXT COMMENT '角色描述',
    data_scope ENUM('ALL', 'CUSTOM', 'DEPT', 'DEPT_AND_CHILD', 'SELF') DEFAULT 'SELF' COMMENT '数据权限范围',
    status ENUM('ACTIVE', 'INACTIVE') DEFAULT 'ACTIVE' COMMENT '状态',
    sort_order INT DEFAULT 0 COMMENT '排序',
    created_by VARCHAR(64) NOT NULL,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_by VARCHAR(64),
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_tenant (tenant_id),
    INDEX idx_role_code (role_code),
    INDEX idx_role_name (role_name),
    INDEX idx_status (status),
    FOREIGN KEY (tenant_id) REFERENCES tenant(tenant_id)
) COMMENT '系统角色表';

-- 5. 权限菜单表（合并权限和菜单）
CREATE TABLE sys_permission (
    permission_id VARCHAR(32) PRIMARY KEY COMMENT '权限ID',
    tenant_id VARCHAR(32) NOT NULL COMMENT '租户ID',
    permission_code VARCHAR(128) NOT NULL COMMENT '权限代码',
    permission_name VARCHAR(128) NOT NULL COMMENT '权限名称',
    permission_type ENUM('DIRECTORY', 'MENU', 'BUTTON', 'API', 'DATA') DEFAULT 'MENU' COMMENT '权限类型',
    parent_id VARCHAR(32) COMMENT '父权限ID',
    path VARCHAR(255) COMMENT '路由路径',
    component VARCHAR(255) COMMENT '组件路径',
    icon VARCHAR(64) COMMENT '图标',
    sort_order INT DEFAULT 0 COMMENT '排序',
    visible BOOLEAN DEFAULT TRUE COMMENT '是否可见',
    status ENUM('ACTIVE', 'INACTIVE') DEFAULT 'ACTIVE' COMMENT '状态',
    created_by VARCHAR(64) NOT NULL,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_by VARCHAR(64),
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_tenant (tenant_id),
    INDEX idx_permission_code (permission_code),
    INDEX idx_parent_id (parent_id),
    INDEX idx_permission_type (permission_type),
    INDEX idx_status (status),
    FOREIGN KEY (tenant_id) REFERENCES tenant(tenant_id),
    FOREIGN KEY (parent_id) REFERENCES sys_permission(permission_id)
) COMMENT '权限菜单表';

-- 6. 用户角色关联表（保持不变）
CREATE TABLE sys_user_role (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id VARCHAR(32) NOT NULL COMMENT '用户ID',
    role_id VARCHAR(32) NOT NULL COMMENT '角色ID',
    created_by VARCHAR(64) NOT NULL,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_user (user_id),
    INDEX idx_role (role_id),
    UNIQUE KEY uk_user_role (user_id, role_id),
    FOREIGN KEY (user_id) REFERENCES sys_user(user_id),
    FOREIGN KEY (role_id) REFERENCES sys_role(role_id)
) COMMENT '用户角色关联表';

-- 7. 角色权限关联表（保持不变）
CREATE TABLE sys_role_permission (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    role_id VARCHAR(32) NOT NULL COMMENT '角色ID',
    permission_id VARCHAR(32) NOT NULL COMMENT '权限ID',
    created_by VARCHAR(64) NOT NULL,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_role (role_id),
    INDEX idx_permission (permission_id),
    UNIQUE KEY uk_role_permission (role_id, permission_id),
    FOREIGN KEY (role_id) REFERENCES sys_role(role_id),
    FOREIGN KEY (permission_id) REFERENCES sys_permission(permission_id)
) COMMENT '角色权限关联表';
```

---

## 🎯 优化效果

### 1. **简化表结构**
- 从8张表减少到7张表
- 合并权限和菜单表，减少数据冗余
- 统一权限控制逻辑

### 2. **增强功能**
- 新增部门管理，支持组织架构
- 用户关联部门，支持部门级权限
- 权限类型更清晰（目录、菜单、按钮、API、数据）

### 3. **提升性能**
- 减少JOIN查询次数
- 简化前端菜单渲染逻辑
- 统一权限检查接口

### 4. **改善维护性**
- 权限配置更直观
- 菜单权限一体化管理
- 减少数据不一致问题

---

## 🔄 数据迁移方案

### 1. **权限菜单合并**
```sql
-- 将现有菜单数据迁移到权限表
INSERT INTO sys_permission (
    permission_id, tenant_id, permission_code, permission_name,
    permission_type, parent_id, path, component, icon, sort_order, visible, status
)
SELECT 
    menu_id, tenant_id, menu_code, menu_name,
    CASE menu_type 
        WHEN 'DIRECTORY' THEN 'DIRECTORY'
        WHEN 'MENU' THEN 'MENU'
        WHEN 'BUTTON' THEN 'BUTTON'
    END as permission_type,
    parent_id, path, component, icon, sort_order, visible, status
FROM sys_menu;

-- 更新角色权限关联
UPDATE sys_role_permission rp
JOIN sys_permission p ON rp.permission_id = p.permission_id
SET rp.permission_id = (
    SELECT permission_id FROM sys_permission 
    WHERE permission_code = p.permission_code AND permission_type = 'MENU'
)
WHERE p.permission_type = 'BUTTON';
```

### 2. **部门数据初始化**
```sql
-- 为每个租户创建默认部门
INSERT INTO sys_dept (dept_id, tenant_id, dept_code, dept_name, dept_type)
SELECT 
    CONCAT('DEPT_', tenant_id) as dept_id,
    tenant_id,
    'DEFAULT' as dept_code,
    '默认部门' as dept_name,
    'DEPARTMENT' as dept_type
FROM tenant;

-- 将现有用户分配到默认部门
UPDATE sys_user u
SET dept_id = (
    SELECT dept_id FROM sys_dept 
    WHERE tenant_id = u.tenant_id AND dept_code = 'DEFAULT'
);
```

---

## 📊 权限控制逻辑

### 1. **菜单访问控制**
```sql
-- 获取用户可访问的菜单
SELECT DISTINCT p.*
FROM sys_user u
JOIN sys_user_role ur ON u.user_id = ur.user_id
JOIN sys_role_permission rp ON ur.role_id = rp.role_id
JOIN sys_permission p ON rp.permission_id = p.permission_id
WHERE u.user_id = ? 
  AND u.status = 'ACTIVE'
  AND p.permission_type IN ('DIRECTORY', 'MENU')
  AND p.status = 'ACTIVE'
  AND p.visible = TRUE
ORDER BY p.sort_order;
```

### 2. **按钮权限控制**
```sql
-- 检查用户是否有特定按钮权限
SELECT COUNT(*) > 0 as has_permission
FROM sys_user u
JOIN sys_user_role ur ON u.user_id = ur.user_id
JOIN sys_role_permission rp ON ur.role_id = rp.role_id
JOIN sys_permission p ON rp.permission_id = p.permission_id
WHERE u.user_id = ? 
  AND p.permission_code = ?
  AND p.permission_type = 'BUTTON'
  AND u.status = 'ACTIVE'
  AND p.status = 'ACTIVE';
```

### 3. **数据权限控制**
```sql
-- 根据数据权限范围过滤数据
SELECT * FROM business_table bt
WHERE CASE (
    SELECT r.data_scope 
    FROM sys_user u
    JOIN sys_user_role ur ON u.user_id = ur.user_id
    JOIN sys_role r ON ur.role_id = r.role_id
    WHERE u.user_id = ?
    LIMIT 1
)
WHEN 'ALL' THEN 1=1
WHEN 'SELF' THEN bt.created_by = ?
WHEN 'DEPT' THEN bt.dept_id = (
    SELECT dept_id FROM sys_user WHERE user_id = ?
)
WHEN 'DEPT_AND_CHILD' THEN bt.dept_id IN (
    SELECT dept_id FROM sys_dept 
    WHERE dept_id = (SELECT dept_id FROM sys_user WHERE user_id = ?)
    OR parent_id = (SELECT dept_id FROM sys_user WHERE user_id = ?)
)
ELSE 1=0 END;
```

---

## 🚀 实施建议

### 1. **分阶段实施**
- **阶段1**: 创建新表结构，保留旧表
- **阶段2**: 数据迁移和验证
- **阶段3**: 应用代码适配
- **阶段4**: 删除旧表，完成迁移

### 2. **测试验证**
- 单元测试：权限检查逻辑
- 集成测试：菜单渲染功能
- 用户测试：权限控制效果

### 3. **回滚方案**
- 保留原有表结构
- 准备数据回滚脚本
- 监控系统稳定性

---

## 📋 总结

通过本次审查和优化：

1. **解决了权限菜单重复问题**
2. **新增了部门管理功能**
3. **简化了权限控制逻辑**
4. **提升了系统可维护性**

建议采用**方案1**进行实施，能够有效解决当前设计中的问题，并为未来的扩展奠定良好基础。
