# 预警监控系统使用指南

## 📋 概述

BTC-SaaS MES系统的预警监控模块提供实时生产异常检测和告警功能，确保生产过程中的问题能够及时发现和处理。

---

## 🚨 核心功能

### 1. **多维度异常监控**
- **生产异常**: 效率、产量、节拍时间、停机时间
- **质量异常**: 通过率、缺陷率、检验异常
- **设备异常**: OEE、可用率、性能率、质量率
- **库存异常**: 库存水平、供应天数、过期预警
- **系统异常**: 性能指标、错误率、响应时间

### 2. **智能预警规则**
- **阈值告警**: 基于数值阈值的告警
- **趋势告警**: 基于数据趋势的告警
- **异常检测**: 基于统计模型的异常检测
- **组合条件**: 多条件组合的复杂告警规则

### 3. **多渠道通知**
- **邮件通知**: 发送详细告警信息
- **短信通知**: 紧急告警短信提醒
- **钉钉/微信**: 企业通讯工具集成
- **Webhook**: 第三方系统集成
- **系统内通知**: 系统内消息中心

---

## 📊 数据表结构

### 1. **预警规则配置表 (alert_rule_config)**

```sql
-- 创建生产效率预警规则
INSERT INTO alert_rule_config (
    rule_id, tenant_id, site_id, rule_name, rule_code,
    alert_type, severity_level, data_source, condition_field,
    condition_operator, condition_value, threshold_value,
    time_window_minutes, check_interval_seconds, is_enabled,
    notification_channels, escalation_rules, created_by
) VALUES (
    'RULE_PROD_EFFICIENCY_001', 'TENANT_001', 'SITE_001',
    '生产线效率异常预警', 'PROD_EFFICIENCY_ALERT',
    'PRODUCTION', 'WARNING', 'production_line',
    'efficiency_rate', 'LT', '85', 85.00,
    10, 60, TRUE,
    '["EMAIL", "DINGTALK"]', '{"escalate_after_minutes": 30, "escalate_to": ["MANAGER", "SUPERVISOR"]}',
    'ADMIN_001'
);
```

### 2. **预警事件记录表 (alert_event)**

```sql
-- 查看当前活跃的预警事件
SELECT 
    event_id, alert_type, severity_level, title,
    affected_entity_name, current_value, threshold_value,
    deviation_percentage, first_occurred_at, occurrence_count,
    status, acknowledged_by, acknowledged_at
FROM alert_event 
WHERE status = 'ACTIVE' 
  AND tenant_id = 'TENANT_001'
ORDER BY severity_level DESC, first_occurred_at DESC;
```

### 3. **生产异常监控表 (production_alert_monitor)**

```sql
-- 查询生产线异常监控数据
SELECT 
    monitor_time, wo_id, line_id, station_id,
    monitor_type, current_value, normal_min_value, normal_max_value,
    warning_threshold, critical_threshold, alert_level,
    trend_direction, is_alert_triggered, alert_message
FROM production_alert_monitor 
WHERE tenant_id = 'TENANT_001'
  AND monitor_time >= DATE_SUB(NOW(), INTERVAL 1 DAY)
  AND is_alert_triggered = TRUE
ORDER BY monitor_time DESC;
```

---

## 🔧 配置指南

### 1. **创建预警规则**

#### 生产效率预警
```sql
-- 生产线效率低于85%时告警
INSERT INTO alert_rule_config (
    rule_id, tenant_id, rule_name, rule_code,
    alert_type, severity_level, data_source, condition_field,
    condition_operator, condition_value, threshold_value,
    time_window_minutes, check_interval_seconds, is_enabled,
    notification_channels, created_by
) VALUES (
    'RULE_PROD_EFFICIENCY', 'TENANT_001', '生产线效率预警',
    'PROD_EFFICIENCY', 'PRODUCTION', 'WARNING',
    'production_line', 'efficiency_rate', 'LT', '85', 85.00,
    10, 60, TRUE, '["EMAIL", "DINGTALK"]', 'ADMIN_001'
);
```

#### 质量异常预警
```sql
-- 缺陷率超过5%时告警
INSERT INTO alert_rule_config (
    rule_id, tenant_id, rule_name, rule_code,
    alert_type, severity_level, data_source, condition_field,
    condition_operator, condition_value, threshold_value,
    time_window_minutes, check_interval_seconds, is_enabled,
    notification_channels, created_by
) VALUES (
    'RULE_QUALITY_DEFECT', 'TENANT_001', '质量缺陷率预警',
    'QUALITY_DEFECT', 'QUALITY', 'CRITICAL',
    'quality_inspection', 'defect_rate', 'GT', '5', 5.00,
    5, 30, TRUE, '["SMS", "EMAIL"]', 'ADMIN_001'
);
```

#### 设备OEE预警
```sql
-- 设备OEE低于70%时告警
INSERT INTO alert_rule_config (
    rule_id, tenant_id, rule_name, rule_code,
    alert_type, severity_level, data_source, condition_field,
    condition_operator, condition_value, threshold_value,
    time_window_minutes, check_interval_seconds, is_enabled,
    notification_channels, created_by
) VALUES (
    'RULE_EQUIPMENT_OEE', 'TENANT_001', '设备OEE预警',
    'EQUIPMENT_OEE', 'EQUIPMENT', 'WARNING',
    'equipment_status', 'oee', 'LT', '70', 70.00,
    15, 120, TRUE, '["EMAIL"]', 'ADMIN_001'
);
```

#### 库存不足预警
```sql
-- 库存低于安全库存时告警
INSERT INTO alert_rule_config (
    rule_id, tenant_id, rule_name, rule_code,
    alert_type, severity_level, data_source, condition_field,
    condition_operator, condition_value, threshold_value,
    time_window_minutes, check_interval_seconds, is_enabled,
    notification_channels, created_by
) VALUES (
    'RULE_INVENTORY_LOW', 'TENANT_001', '库存不足预警',
    'INVENTORY_LOW', 'INVENTORY', 'CRITICAL',
    'inventory_stock', 'available_stock', 'LT', 'safety_stock', NULL,
    30, 300, TRUE, '["SMS", "EMAIL"]', 'ADMIN_001'
);
```

### 2. **配置通知渠道**

#### 邮件通知配置
```json
{
  "EMAIL": {
    "smtp_server": "smtp.company.com",
    "smtp_port": 587,
    "username": "alerts@company.com",
    "password": "encrypted_password",
    "from_address": "alerts@company.com",
    "to_addresses": ["manager@company.com", "supervisor@company.com"],
    "subject_template": "【{severity_level}】{alert_type}告警 - {title}",
    "body_template": "告警详情：{description}\n受影响实体：{affected_entity_name}\n当前值：{current_value}\n阈值：{threshold_value}\n发生时间：{first_occurred_at}"
  }
}
```

#### 钉钉通知配置
```json
{
  "DINGTALK": {
    "webhook_url": "https://oapi.dingtalk.com/robot/send?access_token=xxx",
    "secret": "SEC123456",
    "at_mobiles": ["13800138000", "13900139000"],
    "is_at_all": false,
    "message_template": "🚨 【{severity_level}】{alert_type}告警\n标题：{title}\n描述：{description}\n受影响实体：{affected_entity_name}\n当前值：{current_value}\n阈值：{threshold_value}\n时间：{first_occurred_at}"
  }
}
```

---

## 📈 监控查询示例

### 1. **生产异常监控**

```sql
-- 查询生产线效率异常
SELECT 
    pam.monitor_time,
    pam.wo_id,
    pam.line_id,
    pam.station_id,
    pam.current_value as efficiency_rate,
    pam.warning_threshold,
    pam.alert_level,
    pam.alert_message
FROM production_alert_monitor pam
WHERE pam.tenant_id = 'TENANT_001'
  AND pam.monitor_type = 'EFFICIENCY'
  AND pam.is_alert_triggered = TRUE
  AND pam.monitor_time >= DATE_SUB(NOW(), INTERVAL 24 HOUR)
ORDER BY pam.monitor_time DESC;
```

### 2. **质量异常监控**

```sql
-- 查询质量缺陷率异常
SELECT 
    qam.monitor_time,
    qam.item_id,
    qam.inspection_type,
    qam.station_id,
    qam.inspector,
    qam.pass_rate,
    qam.defect_rate,
    qam.warning_defect_rate_threshold,
    qam.alert_level,
    qam.top_defects
FROM quality_alert_monitor qam
WHERE qam.tenant_id = 'TENANT_001'
  AND qam.is_alert_triggered = TRUE
  AND qam.monitor_time >= DATE_SUB(NOW(), INTERVAL 24 HOUR)
ORDER BY qam.defect_rate DESC, qam.monitor_time DESC;
```

### 3. **设备异常监控**

```sql
-- 查询设备OEE异常
SELECT 
    eam.monitor_time,
    eam.equipment_id,
    eam.equipment_code,
    eam.equipment_name,
    eam.equipment_status,
    eam.oee,
    eam.availability,
    eam.performance,
    eam.quality,
    eam.warning_oee_threshold,
    eam.alert_level,
    eam.anomaly_types
FROM equipment_alert_monitor eam
WHERE eam.tenant_id = 'TENANT_001'
  AND eam.is_alert_triggered = TRUE
  AND eam.monitor_time >= DATE_SUB(NOW(), INTERVAL 24 HOUR)
ORDER BY eam.oee ASC, eam.monitor_time DESC;
```

### 4. **库存异常监控**

```sql
-- 查询库存不足异常
SELECT 
    iam.monitor_time,
    iam.item_id,
    iam.item_code,
    iam.location_id,
    iam.warehouse_code,
    iam.current_stock,
    iam.available_stock,
    iam.safety_stock,
    iam.min_stock_level,
    iam.days_of_supply,
    iam.alert_level,
    iam.stock_status
FROM inventory_alert_monitor iam
WHERE iam.tenant_id = 'TENANT_001'
  AND iam.is_alert_triggered = TRUE
  AND iam.monitor_time >= DATE_SUB(NOW(), INTERVAL 24 HOUR)
ORDER BY iam.available_stock ASC, iam.monitor_time DESC;
```

---

## 📊 告警统计查询

### 1. **告警趋势分析**

```sql
-- 查询最近24小时告警趋势
SELECT 
    DATE_FORMAT(bucket_start, '%Y-%m-%d %H:00:00') as hour_time,
    alert_type,
    severity_level,
    SUM(total_alerts) as total_alerts,
    SUM(new_alerts) as new_alerts,
    SUM(resolved_alerts) as resolved_alerts,
    SUM(active_alerts) as active_alerts
FROM agg_alert_stats_1h
WHERE tenant_id = 'TENANT_001'
  AND bucket_start >= DATE_SUB(NOW(), INTERVAL 24 HOUR)
GROUP BY DATE_FORMAT(bucket_start, '%Y-%m-%d %H:00:00'), alert_type, severity_level
ORDER BY bucket_start DESC, alert_type, severity_level;
```

### 2. **告警响应时间分析**

```sql
-- 查询告警响应时间统计
SELECT 
    alert_type,
    severity_level,
    COUNT(*) as alert_count,
    AVG(TIMESTAMPDIFF(MINUTE, first_occurred_at, acknowledged_at)) as avg_acknowledge_time,
    AVG(TIMESTAMPDIFF(MINUTE, first_occurred_at, resolved_at)) as avg_resolution_time,
    MAX(TIMESTAMPDIFF(MINUTE, first_occurred_at, resolved_at)) as max_resolution_time
FROM alert_event
WHERE tenant_id = 'TENANT_001'
  AND status = 'RESOLVED'
  AND acknowledged_at IS NOT NULL
  AND resolved_at IS NOT NULL
  AND first_occurred_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)
GROUP BY alert_type, severity_level
ORDER BY alert_type, severity_level;
```

### 3. **告警源分析**

```sql
-- 查询主要告警源
SELECT 
    affected_entity_type,
    affected_entity_name,
    COUNT(*) as alert_count,
    COUNT(CASE WHEN severity_level = 'CRITICAL' THEN 1 END) as critical_count,
    COUNT(CASE WHEN severity_level = 'WARNING' THEN 1 END) as warning_count,
    AVG(occurrence_count) as avg_occurrence_count
FROM alert_event
WHERE tenant_id = 'TENANT_001'
  AND first_occurred_at >= DATE_SUB(NOW(), INTERVAL 7 DAY)
GROUP BY affected_entity_type, affected_entity_name
ORDER BY alert_count DESC
LIMIT 20;
```

---

## 🎯 最佳实践

### 1. **预警规则设计**

#### 阈值设置原则
- **警告阈值**: 设置为正常范围的80-90%
- **严重阈值**: 设置为正常范围的70-80%
- **时间窗口**: 根据业务特点设置，通常5-15分钟
- **检查间隔**: 根据数据更新频率设置，通常30-120秒

#### 告警级别分配
- **INFO**: 信息性提示，不影响生产
- **WARNING**: 需要关注，可能影响效率
- **CRITICAL**: 严重影响生产，需要立即处理
- **FATAL**: 系统故障，需要紧急处理

### 2. **通知策略**

#### 分级通知
```json
{
  "INFO": ["SYSTEM"],
  "WARNING": ["EMAIL", "SYSTEM"],
  "CRITICAL": ["EMAIL", "DINGTALK", "SYSTEM"],
  "FATAL": ["SMS", "EMAIL", "DINGTALK", "SYSTEM"]
}
```

#### 升级策略
```json
{
  "escalate_after_minutes": 30,
  "escalate_to": ["MANAGER", "SUPERVISOR", "TECHNICIAN"],
  "escalation_message": "告警已升级，请立即处理"
}
```

### 3. **监控优化**

#### 避免告警风暴
- 设置告警聚合规则
- 实现告警抑制机制
- 配置合理的检查间隔
- 使用告警分组和标签

#### 提高告警准确性
- 基于历史数据设置阈值
- 使用机器学习算法优化阈值
- 实现自适应阈值调整
- 定期评估和调整规则

---

## 🔧 运维管理

### 1. **规则管理**

```sql
-- 启用/禁用预警规则
UPDATE alert_rule_config 
SET is_enabled = FALSE, updated_by = 'ADMIN_001', updated_at = NOW()
WHERE rule_id = 'RULE_PROD_EFFICIENCY_001';

-- 批量更新规则阈值
UPDATE alert_rule_config 
SET threshold_value = 80.00, updated_by = 'ADMIN_001', updated_at = NOW()
WHERE alert_type = 'PRODUCTION' AND condition_field = 'efficiency_rate';
```

### 2. **告警处理**

```sql
-- 确认告警
UPDATE alert_event 
SET status = 'ACKNOWLEDGED', acknowledged_by = 'USER_001', acknowledged_at = NOW()
WHERE event_id = 'EVENT_001';

-- 解决告警
UPDATE alert_event 
SET status = 'RESOLVED', resolved_by = 'USER_001', resolved_at = NOW(), resolution_notes = '问题已解决'
WHERE event_id = 'EVENT_001';
```

### 3. **数据清理**

```sql
-- 清理已解决的旧告警事件（保留3个月）
DELETE FROM alert_event 
WHERE status = 'RESOLVED' 
  AND resolved_at < DATE_SUB(NOW(), INTERVAL 3 MONTH);

-- 清理监控历史数据（保留1个月）
DELETE FROM production_alert_monitor 
WHERE monitor_time < DATE_SUB(NOW(), INTERVAL 1 MONTH);
```

---

## 📞 技术支持

如有问题，请联系：
- **预警系统团队**: alert-team@btc-mes.com
- **技术支持**: support@btc-mes.com
- **紧急联系**: emergency@btc-mes.com

---

*最后更新时间: 2025-01-07*  
*文档版本: v1.0.0*
