# æƒé™èœå•åˆå¹¶å¯è¡Œæ€§åˆ†æ

## ğŸ¤” é—®é¢˜åˆ†æ

æ‚¨æå‡ºçš„é—®é¢˜éå¸¸é‡è¦ï¼š**æƒé™å’Œèœå•èƒ½å¤Ÿåˆå¹¶å—ï¼Ÿèœå•çš„pathå’Œnameå±æ€§ç­‰æ€ä¹ˆå¤„ç†ï¼Ÿ**

è®©æˆ‘ä»å®é™…ä¸šåŠ¡è§’åº¦æ·±å…¥åˆ†æè¿™ä¸ªé—®é¢˜ã€‚

---

## ğŸ“Š æƒé™ä¸èœå•çš„æœ¬è´¨åŒºåˆ«

### æƒé™çš„æœ¬è´¨
- **åŠŸèƒ½æ§åˆ¶**: æ§åˆ¶ç”¨æˆ·èƒ½åšä»€ä¹ˆæ“ä½œ
- **è®¿é—®æ§åˆ¶**: æ§åˆ¶ç”¨æˆ·èƒ½è®¿é—®ä»€ä¹ˆèµ„æº
- **ä¸šåŠ¡é€»è¾‘**: ä¸å…·ä½“ä¸šåŠ¡åŠŸèƒ½ç›¸å…³

### èœå•çš„æœ¬è´¨
- **å¯¼èˆªåŠŸèƒ½**: æä¾›ç”¨æˆ·ç•Œé¢å¯¼èˆª
- **ç”¨æˆ·ä½“éªŒ**: å½±å“ç”¨æˆ·ç•Œé¢çš„å±•ç¤º
- **å‰ç«¯æ¸²æŸ“**: ä¸»è¦ç”¨äºå‰ç«¯ç»„ä»¶æ¸²æŸ“

---

## âŒ åˆå¹¶æ–¹æ¡ˆçš„é—®é¢˜

### 1. **èŒè´£æ··ä¹±**
```sql
-- é—®é¢˜ï¼šæƒé™è¡¨ä¸­æ··åˆäº†èœå•å±æ€§
CREATE TABLE sys_permission (
    permission_id VARCHAR(32) PRIMARY KEY,
    permission_code VARCHAR(128) NOT NULL,
    permission_name VARCHAR(128) NOT NULL,
    permission_type ENUM('DIRECTORY', 'MENU', 'BUTTON', 'API', 'DATA'),
    -- èœå•ç‰¹æœ‰å±æ€§
    path VARCHAR(255) COMMENT 'è·¯ç”±è·¯å¾„',
    component VARCHAR(255) COMMENT 'ç»„ä»¶è·¯å¾„',
    icon VARCHAR(64) COMMENT 'å›¾æ ‡',
    visible BOOLEAN DEFAULT TRUE COMMENT 'æ˜¯å¦å¯è§',
    -- æƒé™ç‰¹æœ‰å±æ€§
    resource_type VARCHAR(64) COMMENT 'èµ„æºç±»å‹',
    action VARCHAR(64) COMMENT 'æ“ä½œç±»å‹'
);
```

**é—®é¢˜åˆ†æï¼š**
- æƒé™å’Œèœå•çš„èŒè´£ä¸æ¸…æ™°
- å­—æ®µè¯­ä¹‰æ··ä¹±ï¼ˆpathæ—¢å¯èƒ½æ˜¯è·¯ç”±è·¯å¾„ï¼Œä¹Ÿå¯èƒ½æ˜¯APIè·¯å¾„ï¼‰
- ç»´æŠ¤å›°éš¾ï¼ˆä¿®æ”¹èœå•ä¸å½±å“æƒé™ï¼Œä¿®æ”¹æƒé™ä¸å½±å“èœå•ï¼‰

### 2. **ä¸šåŠ¡åœºæ™¯å†²çª**
```sql
-- åœºæ™¯1ï¼šèœå•éœ€è¦æƒé™æ§åˆ¶
-- ç”¨æˆ·å¯ä»¥çœ‹åˆ°èœå•ï¼Œä½†æ²¡æœ‰æ“ä½œæƒé™
SELECT * FROM sys_permission 
WHERE permission_type = 'MENU' AND visible = TRUE;

-- åœºæ™¯2ï¼šæƒé™ä¸éœ€è¦èœå•æ˜¾ç¤º
-- ç”¨æˆ·æœ‰APIè°ƒç”¨æƒé™ï¼Œä½†ä¸éœ€è¦èœå•é¡¹
SELECT * FROM sys_permission 
WHERE permission_type = 'API' AND resource_type = 'INTERNAL';
```

### 3. **æ‰©å±•æ€§å·®**
- èœå•å¯èƒ½æœ‰å¤šä¸ªå‰ç«¯æ¡†æ¶ï¼ˆVueã€Reactã€Angularï¼‰
- æƒé™å¯èƒ½éœ€è¦æ”¯æŒå¤šç§èµ„æºç±»å‹ï¼ˆæ–‡ä»¶ã€æ•°æ®ã€æœåŠ¡ï¼‰
- åˆå¹¶åéš¾ä»¥ç‹¬ç«‹æ‰©å±•

---

## âœ… æ¨èçš„åˆ†ç¦»æ–¹æ¡ˆ

### æ–¹æ¡ˆè®¾è®¡åŸåˆ™
1. **å•ä¸€èŒè´£**: æƒé™ç®¡æƒé™ï¼Œèœå•ç®¡èœå•
2. **æ¾è€¦åˆ**: é€šè¿‡å…³è”å…³ç³»è¿æ¥ï¼Œä¸ç›´æ¥åˆå¹¶
3. **å¯æ‰©å±•**: å„è‡ªå¯ä»¥ç‹¬ç«‹æ‰©å±•

### ä¼˜åŒ–åçš„è¡¨ç»“æ„

```sql
-- ==============================================
-- 1. æƒé™è¡¨ï¼ˆä¸“æ³¨æƒé™æ§åˆ¶ï¼‰
-- ==============================================

CREATE TABLE sys_permission (
    permission_id VARCHAR(32) PRIMARY KEY COMMENT 'æƒé™ID',
    tenant_id VARCHAR(32) NOT NULL COMMENT 'ç§Ÿæˆ·ID',
    permission_code VARCHAR(128) NOT NULL COMMENT 'æƒé™ä»£ç ',
    permission_name VARCHAR(128) NOT NULL COMMENT 'æƒé™åç§°',
    permission_type ENUM('MENU_ACCESS', 'BUTTON_ACTION', 'API_CALL', 'DATA_ACCESS') DEFAULT 'MENU_ACCESS' COMMENT 'æƒé™ç±»å‹',
    resource_type VARCHAR(64) COMMENT 'èµ„æºç±»å‹',
    resource_id VARCHAR(128) COMMENT 'èµ„æºæ ‡è¯†',
    action VARCHAR(64) COMMENT 'æ“ä½œç±»å‹',
    scope ENUM('GLOBAL', 'TENANT', 'DEPT', 'SELF') DEFAULT 'TENANT' COMMENT 'æƒé™èŒƒå›´',
    parent_id VARCHAR(32) COMMENT 'çˆ¶æƒé™ID',
    description TEXT COMMENT 'æƒé™æè¿°',
    status ENUM('ACTIVE', 'INACTIVE') DEFAULT 'ACTIVE' COMMENT 'çŠ¶æ€',
    created_by VARCHAR(64) NOT NULL,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_by VARCHAR(64),
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_tenant (tenant_id),
    INDEX idx_permission_code (permission_code),
    INDEX idx_permission_type (permission_type),
    INDEX idx_resource (resource_type, resource_id),
    INDEX idx_parent_id (parent_id),
    INDEX idx_status (status),
    FOREIGN KEY (tenant_id) REFERENCES tenant(tenant_id),
    FOREIGN KEY (parent_id) REFERENCES sys_permission(permission_id)
) COMMENT 'ç³»ç»Ÿæƒé™è¡¨';

-- ==============================================
-- 2. èœå•è¡¨ï¼ˆä¸“æ³¨ç•Œé¢å¯¼èˆªï¼‰
-- ==============================================

CREATE TABLE sys_menu (
    menu_id VARCHAR(32) PRIMARY KEY COMMENT 'èœå•ID',
    tenant_id VARCHAR(32) NOT NULL COMMENT 'ç§Ÿæˆ·ID',
    menu_code VARCHAR(64) NOT NULL COMMENT 'èœå•ä»£ç ',
    menu_name VARCHAR(128) NOT NULL COMMENT 'èœå•åç§°',
    menu_type ENUM('DIRECTORY', 'MENU', 'BUTTON') DEFAULT 'MENU' COMMENT 'èœå•ç±»å‹',
    parent_id VARCHAR(32) COMMENT 'çˆ¶èœå•ID',
    path VARCHAR(255) COMMENT 'è·¯ç”±è·¯å¾„',
    component VARCHAR(255) COMMENT 'ç»„ä»¶è·¯å¾„',
    icon VARCHAR(64) COMMENT 'å›¾æ ‡',
    sort_order INT DEFAULT 0 COMMENT 'æ’åº',
    visible BOOLEAN DEFAULT TRUE COMMENT 'æ˜¯å¦å¯è§',
    keep_alive BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦ç¼“å­˜',
    external_link BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦å¤–é“¾',
    external_url VARCHAR(500) COMMENT 'å¤–é“¾åœ°å€',
    status ENUM('ACTIVE', 'INACTIVE') DEFAULT 'ACTIVE' COMMENT 'çŠ¶æ€',
    created_by VARCHAR(64) NOT NULL,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_by VARCHAR(64),
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    INDEX idx_tenant (tenant_id),
    INDEX idx_menu_code (menu_code),
    INDEX idx_parent_id (parent_id),
    INDEX idx_visible (visible),
    INDEX idx_status (status),
    FOREIGN KEY (tenant_id) REFERENCES tenant(tenant_id),
    FOREIGN KEY (parent_id) REFERENCES sys_menu(menu_id)
) COMMENT 'ç³»ç»Ÿèœå•è¡¨';

-- ==============================================
-- 3. èœå•æƒé™å…³è”è¡¨ï¼ˆå…³è”èœå•å’Œæƒé™ï¼‰
-- ==============================================

CREATE TABLE sys_menu_permission (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    menu_id VARCHAR(32) NOT NULL COMMENT 'èœå•ID',
    permission_id VARCHAR(32) NOT NULL COMMENT 'æƒé™ID',
    relation_type ENUM('REQUIRED', 'OPTIONAL') DEFAULT 'REQUIRED' COMMENT 'å…³è”ç±»å‹',
    created_by VARCHAR(64) NOT NULL,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_menu (menu_id),
    INDEX idx_permission (permission_id),
    UNIQUE KEY uk_menu_permission (menu_id, permission_id),
    FOREIGN KEY (menu_id) REFERENCES sys_menu(menu_id),
    FOREIGN KEY (permission_id) REFERENCES sys_permission(permission_id)
) COMMENT 'èœå•æƒé™å…³è”è¡¨';

-- ==============================================
-- 4. è§’è‰²æƒé™å…³è”è¡¨ï¼ˆä¿æŒä¸å˜ï¼‰
-- ==============================================

CREATE TABLE sys_role_permission (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    role_id VARCHAR(32) NOT NULL COMMENT 'è§’è‰²ID',
    permission_id VARCHAR(32) NOT NULL COMMENT 'æƒé™ID',
    created_by VARCHAR(64) NOT NULL,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_role (role_id),
    INDEX idx_permission (permission_id),
    UNIQUE KEY uk_role_permission (role_id, permission_id),
    FOREIGN KEY (role_id) REFERENCES sys_role(role_id),
    FOREIGN KEY (permission_id) REFERENCES sys_permission(permission_id)
) COMMENT 'è§’è‰²æƒé™å…³è”è¡¨';
```

---

## ğŸ¯ åˆ†ç¦»æ–¹æ¡ˆçš„ä¼˜åŠ¿

### 1. **èŒè´£æ¸…æ™°**
- **æƒé™è¡¨**: ä¸“æ³¨æƒé™æ§åˆ¶ï¼Œä¸å…³å¿ƒç•Œé¢å±•ç¤º
- **èœå•è¡¨**: ä¸“æ³¨ç•Œé¢å¯¼èˆªï¼Œä¸å…³å¿ƒæƒé™é€»è¾‘
- **å…³è”è¡¨**: å¤„ç†ä¸¤è€…ä¹‹é—´çš„å…³ç³»

### 2. **çµæ´»æ€§å¼º**
```sql
-- åœºæ™¯1ï¼šèœå•éœ€è¦å¤šä¸ªæƒé™
-- ä¸€ä¸ªèœå•å¯èƒ½éœ€è¦å¤šä¸ªæƒé™æ‰èƒ½è®¿é—®
INSERT INTO sys_menu_permission VALUES 
('MENU_001', 'PERM_READ', 'REQUIRED'),
('MENU_001', 'PERM_WRITE', 'OPTIONAL');

-- åœºæ™¯2ï¼šæƒé™å¯¹åº”å¤šä¸ªèœå•
-- ä¸€ä¸ªæƒé™å¯èƒ½å¯¹åº”å¤šä¸ªèœå•é¡¹
INSERT INTO sys_menu_permission VALUES 
('MENU_001', 'PERM_USER_MANAGE', 'REQUIRED'),
('MENU_002', 'PERM_USER_MANAGE', 'REQUIRED');
```

### 3. **æ‰©å±•æ€§å¥½**
- èœå•å¯ä»¥æ”¯æŒå¤šå‰ç«¯æ¡†æ¶
- æƒé™å¯ä»¥æ”¯æŒå¤šç§èµ„æºç±»å‹
- å„è‡ªç‹¬ç«‹æ‰©å±•ï¼Œäº’ä¸å½±å“

---

## ğŸ”„ æƒé™æ§åˆ¶é€»è¾‘

### 1. **èœå•è®¿é—®æ§åˆ¶**
```sql
-- è·å–ç”¨æˆ·å¯è®¿é—®çš„èœå•ï¼ˆéœ€è¦æ£€æŸ¥å…³è”çš„æƒé™ï¼‰
SELECT DISTINCT m.*
FROM sys_menu m
JOIN sys_menu_permission mp ON m.menu_id = mp.menu_id
JOIN sys_role_permission rp ON mp.permission_id = rp.permission_id
JOIN sys_user_role ur ON rp.role_id = ur.role_id
WHERE ur.user_id = ?
  AND m.visible = TRUE
  AND m.status = 'ACTIVE'
  AND mp.relation_type = 'REQUIRED'
  AND NOT EXISTS (
    -- æ£€æŸ¥æ˜¯å¦ç¼ºå°‘å¿…éœ€æƒé™
    SELECT 1 FROM sys_menu_permission mp2
    WHERE mp2.menu_id = m.menu_id 
      AND mp2.relation_type = 'REQUIRED'
      AND mp2.permission_id NOT IN (
        SELECT rp2.permission_id FROM sys_role_permission rp2
        JOIN sys_user_role ur2 ON rp2.role_id = ur2.role_id
        WHERE ur2.user_id = ?
      )
  );
```

### 2. **æŒ‰é’®æƒé™æ§åˆ¶**
```sql
-- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰ç‰¹å®šæŒ‰é’®æƒé™
SELECT COUNT(*) > 0 as has_permission
FROM sys_user u
JOIN sys_user_role ur ON u.user_id = ur.user_id
JOIN sys_role_permission rp ON ur.role_id = rp.role_id
JOIN sys_permission p ON rp.permission_id = p.permission_id
WHERE u.user_id = ?
  AND p.permission_code = ?
  AND p.permission_type = 'BUTTON_ACTION'
  AND u.status = 'ACTIVE'
  AND p.status = 'ACTIVE';
```

### 3. **APIæƒé™æ§åˆ¶**
```sql
-- æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰APIè°ƒç”¨æƒé™
SELECT COUNT(*) > 0 as has_api_permission
FROM sys_user u
JOIN sys_user_role ur ON u.user_id = ur.user_id
JOIN sys_role_permission rp ON ur.role_id = rp.role_id
JOIN sys_permission p ON rp.permission_id = p.permission_id
WHERE u.user_id = ?
  AND p.resource_type = 'API'
  AND p.resource_id = ?
  AND p.action = ?
  AND u.status = 'ACTIVE'
  AND p.status = 'ACTIVE';
```

---

## ğŸ“Š æ•°æ®ç¤ºä¾‹

### 1. **æƒé™æ•°æ®ç¤ºä¾‹**
```sql
-- æ’å…¥æƒé™æ•°æ®
INSERT INTO sys_permission (permission_id, tenant_id, permission_code, permission_name, permission_type, resource_type, resource_id, action) VALUES
('PERM_001', 'TENANT_001', 'system:user:read', 'ç”¨æˆ·æŸ¥çœ‹æƒé™', 'MENU_ACCESS', 'MENU', 'USER_MANAGE', 'READ'),
('PERM_002', 'TENANT_001', 'system:user:add', 'ç”¨æˆ·æ–°å¢æƒé™', 'BUTTON_ACTION', 'BUTTON', 'USER_ADD', 'CREATE'),
('PERM_003', 'TENANT_001', 'api:user:create', 'ç”¨æˆ·åˆ›å»ºAPIæƒé™', 'API_CALL', 'API', '/api/users', 'POST'),
('PERM_004', 'TENANT_001', 'data:user:access', 'ç”¨æˆ·æ•°æ®è®¿é—®æƒé™', 'DATA_ACCESS', 'TABLE', 'sys_user', 'SELECT');
```

### 2. **èœå•æ•°æ®ç¤ºä¾‹**
```sql
-- æ’å…¥èœå•æ•°æ®
INSERT INTO sys_menu (menu_id, tenant_id, menu_code, menu_name, menu_type, path, component, icon) VALUES
('MENU_001', 'TENANT_001', 'system', 'ç³»ç»Ÿç®¡ç†', 'DIRECTORY', '/system', 'Layout', 'system'),
('MENU_002', 'TENANT_001', 'system:user', 'ç”¨æˆ·ç®¡ç†', 'MENU', '/system/user', 'system/user/index', 'user'),
('MENU_003', 'TENANT_001', 'system:user:add', 'æ–°å¢ç”¨æˆ·', 'BUTTON', NULL, NULL, 'plus');
```

### 3. **å…³è”æ•°æ®ç¤ºä¾‹**
```sql
-- æ’å…¥èœå•æƒé™å…³è”
INSERT INTO sys_menu_permission (menu_id, permission_id, relation_type) VALUES
('MENU_002', 'PERM_001', 'REQUIRED'),  -- ç”¨æˆ·ç®¡ç†èœå•éœ€è¦ç”¨æˆ·æŸ¥çœ‹æƒé™
('MENU_003', 'PERM_002', 'REQUIRED');  -- æ–°å¢ç”¨æˆ·æŒ‰é’®éœ€è¦ç”¨æˆ·æ–°å¢æƒé™
```

---

## ğŸ”§ å‰ç«¯é›†æˆç¤ºä¾‹

### Vueå‰ç«¯æƒé™æ§åˆ¶
```javascript
// æƒé™æ£€æŸ¥æ··å…¥
export const permissionMixin = {
  computed: {
    // è·å–ç”¨æˆ·èœå•
    userMenus() {
      return this.$store.getters.menus;
    },
    // è·å–ç”¨æˆ·æƒé™
    userPermissions() {
      return this.$store.getters.permissions;
    }
  },
  methods: {
    // æ£€æŸ¥èœå•æƒé™
    hasMenuPermission(menuCode) {
      return this.userMenus.some(menu => menu.menu_code === menuCode);
    },
    
    // æ£€æŸ¥æŒ‰é’®æƒé™
    hasButtonPermission(permissionCode) {
      return this.userPermissions.includes(permissionCode);
    }
  }
};

// æƒé™æŒ‡ä»¤
Vue.directive('permission', {
  inserted(el, binding) {
    const permission = binding.value;
    if (!this.hasButtonPermission(permission)) {
      el.parentNode.removeChild(el);
    }
  }
});

// èœå•æƒé™æŒ‡ä»¤
Vue.directive('menu-permission', {
  inserted(el, binding) {
    const menuCode = binding.value;
    if (!this.hasMenuPermission(menuCode)) {
      el.parentNode.removeChild(el);
    }
  }
});
```

---

## ğŸ“‹ æ€»ç»“

### âŒ ä¸æ¨èåˆå¹¶çš„åŸå› 
1. **èŒè´£æ··ä¹±**: æƒé™å’Œèœå•æœ‰ä¸åŒçš„èŒè´£
2. **å­—æ®µè¯­ä¹‰å†²çª**: pathã€nameç­‰å­—æ®µåœ¨ä¸åŒåœºæ™¯ä¸‹æœ‰ä¸åŒå«ä¹‰
3. **æ‰©å±•æ€§å·®**: éš¾ä»¥ç‹¬ç«‹æ‰©å±•
4. **ç»´æŠ¤å›°éš¾**: ä¿®æ”¹ä¸€ä¸ªå½±å“å¦ä¸€ä¸ª

### âœ… æ¨èåˆ†ç¦»æ–¹æ¡ˆ
1. **èŒè´£æ¸…æ™°**: æƒé™ç®¡æƒé™ï¼Œèœå•ç®¡èœå•
2. **çµæ´»æ€§å¼º**: æ”¯æŒå¤æ‚çš„æƒé™èœå•å…³ç³»
3. **æ‰©å±•æ€§å¥½**: å„è‡ªç‹¬ç«‹æ‰©å±•
4. **ç»´æŠ¤ç®€å•**: èŒè´£å•ä¸€ï¼Œæ˜“äºç»´æŠ¤

### ğŸ¯ æœ€ä½³å®è·µ
- ä½¿ç”¨å…³è”è¡¨å¤„ç†æƒé™å’Œèœå•çš„å…³ç³»
- æƒé™ä¸“æ³¨äºè®¿é—®æ§åˆ¶
- èœå•ä¸“æ³¨äºç•Œé¢å¯¼èˆª
- é€šè¿‡æŸ¥è¯¢é€»è¾‘å®ç°å¤æ‚çš„æƒé™æ§åˆ¶

è¿™ç§åˆ†ç¦»æ–¹æ¡ˆæ›´ç¬¦åˆè½¯ä»¶è®¾è®¡çš„å•ä¸€èŒè´£åŸåˆ™ï¼Œä¹Ÿæ›´é€‚åˆå®é™…ä¸šåŠ¡åœºæ™¯çš„å¤æ‚æ€§ã€‚
