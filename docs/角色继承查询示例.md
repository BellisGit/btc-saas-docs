# 角色继承查询示例

## 📋 概述

本文档提供了基于角色继承设计的完整查询示例，包括角色继承查询、权限继承查询、数据权限继承查询等常见场景。

---

## 🔄 角色继承查询

### 1. 递归查询用户的所有角色（包括继承）

```sql
-- 递归查询用户的所有角色（包括继承的角色）
WITH RECURSIVE user_all_roles AS (
    -- 直接分配的角色
    SELECT 
        r.role_id,
        r.role_code,
        r.role_name,
        r.role_level,
        r.parent_role_id,
        r.inherit_permissions,
        r.inherit_data_scope,
        0 as inheritance_level
    FROM sys_user_role ur
    JOIN sys_role r ON ur.role_id = r.role_id
    WHERE ur.user_id = ? AND r.status = 'ACTIVE'
    
    UNION ALL
    
    -- 继承的父角色
    SELECT 
        pr.role_id,
        pr.role_code,
        pr.role_name,
        pr.role_level,
        pr.parent_role_id,
        pr.inherit_permissions,
        pr.inherit_data_scope,
        uar.inheritance_level + 1
    FROM sys_role pr
    JOIN user_all_roles uar ON pr.role_id = uar.parent_role_id
    WHERE pr.status = 'ACTIVE' AND uar.inherit_permissions = TRUE
)
SELECT DISTINCT * FROM user_all_roles
ORDER BY role_level DESC, inheritance_level;
```

### 2. 获取角色继承路径

```sql
-- 获取角色的完整继承路径
WITH RECURSIVE inheritance_path AS (
    SELECT 
        role_id,
        role_code,
        role_name,
        parent_role_id,
        1 as level,
        CAST(role_code AS CHAR(1000)) as path
    FROM sys_role 
    WHERE role_id = ?
    
    UNION ALL
    
    SELECT 
        r.role_id,
        r.role_code,
        r.role_name,
        r.parent_role_id,
        ip.level + 1,
        CONCAT(r.role_code, ' -> ', ip.path)
    FROM sys_role r
    JOIN inheritance_path ip ON r.role_id = ip.parent_role_id
    WHERE ip.level < 10
)
SELECT * FROM inheritance_path ORDER BY level DESC;
```

### 3. 获取角色树结构

```sql
-- 获取完整的角色树结构
WITH RECURSIVE role_tree AS (
    -- 根角色（没有父角色）
    SELECT 
        role_id,
        parent_role_id,
        role_code,
        role_name,
        role_level,
        inherit_permissions,
        inherit_data_scope,
        1 as level,
        CAST(role_code AS CHAR(1000)) as path
    FROM sys_role 
    WHERE parent_role_id IS NULL AND tenant_id = ?
    
    UNION ALL
    
    -- 子角色
    SELECT 
        r.role_id,
        r.parent_role_id,
        r.role_code,
        r.role_name,
        r.role_level,
        r.inherit_permissions,
        r.inherit_data_scope,
        rt.level + 1,
        CONCAT(rt.path, ' -> ', r.role_code)
    FROM sys_role r
    JOIN role_tree rt ON r.parent_role_id = rt.role_id
)
SELECT * FROM role_tree ORDER BY level, role_level;
```

---

## 🔐 权限继承查询

### 1. 获取用户的所有权限（包括继承）

```sql
-- 获取用户的所有权限（包括继承的权限）
WITH RECURSIVE user_all_roles AS (
    -- 直接分配的角色
    SELECT r.role_id, r.inherit_permissions
    FROM sys_user_role ur
    JOIN sys_role r ON ur.role_id = r.role_id
    WHERE ur.user_id = ? AND r.status = 'ACTIVE'
    
    UNION ALL
    
    -- 继承的父角色
    SELECT pr.role_id, pr.inherit_permissions
    FROM sys_role pr
    JOIN user_all_roles uar ON pr.role_id = uar.parent_role_id
    WHERE pr.status = 'ACTIVE' AND uar.inherit_permissions = TRUE
)
SELECT DISTINCT 
    p.permission_id,
    p.permission_code,
    p.permission_name,
    p.permission_type,
    p.resource_type,
    p.resource_id,
    p.action,
    p.scope
FROM user_all_roles uar
JOIN sys_role_permission rp ON uar.role_id = rp.role_id
JOIN sys_permission p ON rp.permission_id = p.permission_id
WHERE p.status = 'ACTIVE'
ORDER BY p.permission_type, p.permission_code;
```

### 2. 检查用户是否有特定权限

```sql
-- 检查用户是否有特定权限（包括继承）
WITH RECURSIVE user_all_roles AS (
    -- 直接分配的角色
    SELECT r.role_id, r.inherit_permissions
    FROM sys_user_role ur
    JOIN sys_role r ON ur.role_id = r.role_id
    WHERE ur.user_id = ? AND r.status = 'ACTIVE'
    
    UNION ALL
    
    -- 继承的父角色
    SELECT pr.role_id, pr.inherit_permissions
    FROM sys_role pr
    JOIN user_all_roles uar ON pr.role_id = uar.parent_role_id
    WHERE pr.status = 'ACTIVE' AND uar.inherit_permissions = TRUE
)
SELECT COUNT(*) > 0 as has_permission
FROM user_all_roles uar
JOIN sys_role_permission rp ON uar.role_id = rp.role_id
JOIN sys_permission p ON rp.permission_id = p.permission_id
WHERE p.permission_code = ? AND p.status = 'ACTIVE';
```

### 3. 获取角色的所有权限（包括继承）

```sql
-- 获取角色的所有权限（包括继承的权限）
WITH RECURSIVE role_hierarchy AS (
    -- 当前角色
    SELECT 
        role_id,
        parent_role_id,
        inherit_permissions
    FROM sys_role 
    WHERE role_id = ? AND status = 'ACTIVE'
    
    UNION ALL
    
    -- 父角色
    SELECT 
        pr.role_id,
        pr.parent_role_id,
        pr.inherit_permissions
    FROM sys_role pr
    JOIN role_hierarchy rh ON pr.role_id = rh.parent_role_id
    WHERE pr.status = 'ACTIVE' AND rh.inherit_permissions = TRUE
)
SELECT DISTINCT 
    p.permission_id,
    p.permission_code,
    p.permission_name,
    p.permission_type,
    p.resource_type,
    p.resource_id,
    p.action
FROM role_hierarchy rh
JOIN sys_role_permission rp ON rh.role_id = rp.role_id
JOIN sys_permission p ON rp.permission_id = p.permission_id
WHERE p.status = 'ACTIVE'
ORDER BY p.permission_type, p.permission_code;
```

---

## 📊 数据权限继承查询

### 1. 获取用户的最大数据权限范围

```sql
-- 获取用户的最大数据权限范围（继承上级角色）
WITH RECURSIVE user_all_roles AS (
    -- 直接分配的角色
    SELECT 
        r.role_id, 
        r.data_scope,
        r.inherit_data_scope,
        r.role_level
    FROM sys_user_role ur
    JOIN sys_role r ON ur.role_id = r.role_id
    WHERE ur.user_id = ? AND r.status = 'ACTIVE'
    
    UNION ALL
    
    -- 继承的父角色
    SELECT 
        pr.role_id,
        pr.data_scope,
        pr.inherit_data_scope,
        pr.role_level
    FROM sys_role pr
    JOIN user_all_roles uar ON pr.role_id = uar.parent_role_id
    WHERE pr.status = 'ACTIVE' AND uar.inherit_data_scope = TRUE
)
SELECT 
    CASE 
        WHEN MAX(CASE data_scope WHEN 'ALL' THEN 4 WHEN 'CUSTOM' THEN 3 WHEN 'DEPT_AND_CHILD' THEN 2 WHEN 'DEPT' THEN 1 ELSE 0 END) >= 4 THEN 'ALL'
        WHEN MAX(CASE data_scope WHEN 'ALL' THEN 4 WHEN 'CUSTOM' THEN 3 WHEN 'DEPT_AND_CHILD' THEN 2 WHEN 'DEPT' THEN 1 ELSE 0 END) >= 3 THEN 'CUSTOM'
        WHEN MAX(CASE data_scope WHEN 'ALL' THEN 4 WHEN 'CUSTOM' THEN 3 WHEN 'DEPT_AND_CHILD' THEN 2 WHEN 'DEPT' THEN 1 ELSE 0 END) >= 2 THEN 'DEPT_AND_CHILD'
        WHEN MAX(CASE data_scope WHEN 'ALL' THEN 4 WHEN 'CUSTOM' THEN 3 WHEN 'DEPT_AND_CHILD' THEN 2 WHEN 'DEPT' THEN 1 ELSE 0 END) >= 1 THEN 'DEPT'
        ELSE 'SELF'
    END as max_data_scope
FROM user_all_roles;
```

### 2. 根据数据权限范围过滤数据

```sql
-- 根据用户的数据权限范围过滤业务数据
SELECT * FROM your_business_table bt
WHERE CASE (
    WITH RECURSIVE user_all_roles AS (
        SELECT r.data_scope, r.inherit_data_scope
        FROM sys_user_role ur
        JOIN sys_role r ON ur.role_id = r.role_id
        WHERE ur.user_id = ? AND r.status = 'ACTIVE'
        
        UNION ALL
        
        SELECT pr.data_scope, pr.inherit_data_scope
        FROM sys_role pr
        JOIN user_all_roles uar ON pr.role_id = uar.parent_role_id
        WHERE pr.status = 'ACTIVE' AND uar.inherit_data_scope = TRUE
    )
    SELECT 
        CASE 
            WHEN MAX(CASE data_scope WHEN 'ALL' THEN 4 WHEN 'CUSTOM' THEN 3 WHEN 'DEPT_AND_CHILD' THEN 2 WHEN 'DEPT' THEN 1 ELSE 0 END) >= 4 THEN 'ALL'
            WHEN MAX(CASE data_scope WHEN 'ALL' THEN 4 WHEN 'CUSTOM' THEN 3 WHEN 'DEPT_AND_CHILD' THEN 2 WHEN 'DEPT' THEN 1 ELSE 0 END) >= 3 THEN 'CUSTOM'
            WHEN MAX(CASE data_scope WHEN 'ALL' THEN 4 WHEN 'CUSTOM' THEN 3 WHEN 'DEPT_AND_CHILD' THEN 2 WHEN 'DEPT' THEN 1 ELSE 0 END) >= 2 THEN 'DEPT_AND_CHILD'
            WHEN MAX(CASE data_scope WHEN 'ALL' THEN 4 WHEN 'CUSTOM' THEN 3 WHEN 'DEPT_AND_CHILD' THEN 2 WHEN 'DEPT' THEN 1 ELSE 0 END) >= 1 THEN 'DEPT'
            ELSE 'SELF'
        END
    FROM user_all_roles
)
WHEN 'ALL' THEN 1=1
WHEN 'SELF' THEN bt.created_by = ?
WHEN 'DEPT' THEN bt.dept_id = (
    SELECT dept_id FROM sys_user WHERE user_id = ?
)
WHEN 'DEPT_AND_CHILD' THEN bt.dept_id IN (
    WITH RECURSIVE dept_tree AS (
        SELECT dept_id FROM sys_dept WHERE dept_id = (
            SELECT dept_id FROM sys_user WHERE user_id = ?
        )
        UNION ALL
        SELECT d.dept_id FROM sys_dept d
        JOIN dept_tree dt ON d.parent_id = dt.dept_id
    )
    SELECT dept_id FROM dept_tree
)
ELSE 1=0 END;
```

---

## 📱 菜单权限继承查询

### 1. 获取用户可访问的菜单（包括继承权限）

```sql
-- 获取用户可访问的菜单（需要检查继承的权限）
WITH RECURSIVE user_all_roles AS (
    -- 直接分配的角色
    SELECT r.role_id, r.inherit_permissions
    FROM sys_user_role ur
    JOIN sys_role r ON ur.role_id = r.role_id
    WHERE ur.user_id = ? AND r.status = 'ACTIVE'
    
    UNION ALL
    
    -- 继承的父角色
    SELECT pr.role_id, pr.inherit_permissions
    FROM sys_role pr
    JOIN user_all_roles uar ON pr.role_id = uar.parent_role_id
    WHERE pr.status = 'ACTIVE' AND uar.inherit_permissions = TRUE
),
user_permissions AS (
    SELECT DISTINCT p.permission_id
    FROM user_all_roles uar
    JOIN sys_role_permission rp ON uar.role_id = rp.role_id
    JOIN sys_permission p ON rp.permission_id = p.permission_id
    WHERE p.status = 'ACTIVE'
)
SELECT DISTINCT m.*
FROM sys_menu m
WHERE m.visible = TRUE 
  AND m.status = 'ACTIVE'
  AND NOT EXISTS (
    -- 检查是否缺少必需权限
    SELECT 1 FROM sys_menu_permission mp
    WHERE mp.menu_id = m.menu_id 
      AND mp.relation_type = 'REQUIRED'
      AND mp.permission_id NOT IN (SELECT permission_id FROM user_permissions)
  )
ORDER BY m.sort_order;
```

### 2. 获取用户在某页面下的按钮权限

```sql
-- 获取用户在某页面下的按钮权限（包括继承）
WITH RECURSIVE user_all_roles AS (
    -- 直接分配的角色
    SELECT r.role_id, r.inherit_permissions
    FROM sys_user_role ur
    JOIN sys_role r ON ur.role_id = r.role_id
    WHERE ur.user_id = ? AND r.status = 'ACTIVE'
    
    UNION ALL
    
    -- 继承的父角色
    SELECT pr.role_id, pr.inherit_permissions
    FROM sys_role pr
    JOIN user_all_roles uar ON pr.role_id = uar.parent_role_id
    WHERE pr.status = 'ACTIVE' AND uar.inherit_permissions = TRUE
)
SELECT 
    p.permission_code,
    p.permission_name
FROM user_all_roles uar
JOIN sys_role_permission rp ON uar.role_id = rp.role_id
JOIN sys_permission p ON rp.permission_id = p.permission_id
WHERE p.parent_id = (
    SELECT permission_id FROM sys_permission 
    WHERE permission_code = ? AND permission_type = 'MENU_ACCESS'
  )
  AND p.permission_type = 'BUTTON_ACTION'
  AND p.status = 'ACTIVE';
```

---

## 🔍 角色管理查询

### 1. 获取角色的所有子角色

```sql
-- 获取角色的所有子角色（递归）
WITH RECURSIVE child_roles AS (
    -- 直接子角色
    SELECT 
        role_id,
        role_code,
        role_name,
        role_level,
        parent_role_id,
        1 as level
    FROM sys_role 
    WHERE parent_role_id = ? AND status = 'ACTIVE'
    
    UNION ALL
    
    -- 子角色的子角色
    SELECT 
        r.role_id,
        r.role_code,
        r.role_name,
        r.role_level,
        r.parent_role_id,
        cr.level + 1
    FROM sys_role r
    JOIN child_roles cr ON r.parent_role_id = cr.role_id
    WHERE r.status = 'ACTIVE'
)
SELECT * FROM child_roles ORDER BY level, role_level;
```

### 2. 检查角色是否可以设置为指定角色的父角色

```sql
-- 检查角色是否可以设置为指定角色的父角色（防止循环引用）
WITH RECURSIVE role_hierarchy AS (
    SELECT role_id, parent_role_id
    FROM sys_role WHERE role_id = ?
    
    UNION ALL
    
    SELECT r.role_id, r.parent_role_id
    FROM sys_role r
    JOIN role_hierarchy rh ON r.role_id = rh.parent_role_id
)
SELECT COUNT(*) = 0 as can_set_parent
FROM role_hierarchy 
WHERE role_id = ?;  -- 检查是否会形成循环
```

### 3. 获取角色继承统计信息

```sql
-- 获取角色继承统计信息
SELECT 
    r.role_code,
    r.role_name,
    r.role_level,
    COUNT(cr.role_id) as child_count,
    COUNT(CASE WHEN cr.inherit_permissions = TRUE THEN 1 END) as inheriting_children,
    COUNT(CASE WHEN cr.inherit_data_scope = TRUE THEN 1 END) as data_inheriting_children
FROM sys_role r
LEFT JOIN sys_role cr ON r.role_id = cr.parent_role_id AND cr.status = 'ACTIVE'
WHERE r.status = 'ACTIVE'
GROUP BY r.role_id, r.role_code, r.role_name, r.role_level
ORDER BY r.role_level, r.role_code;
```

---

## 🚀 性能优化查询

### 1. 创建角色继承缓存表

```sql
-- 创建角色继承缓存表
CREATE TABLE sys_role_inheritance_cache (
    user_id VARCHAR(32) NOT NULL,
    role_id VARCHAR(32) NOT NULL,
    inherited_role_id VARCHAR(32) NOT NULL,
    inheritance_level INT NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    PRIMARY KEY (user_id, role_id, inherited_role_id),
    INDEX idx_user (user_id),
    INDEX idx_role (role_id),
    INDEX idx_inherited_role (inherited_role_id)
) COMMENT '角色继承缓存表';

-- 刷新角色继承缓存
CREATE PROCEDURE RefreshRoleInheritanceCache()
BEGIN
    DELETE FROM sys_role_inheritance_cache;
    
    INSERT INTO sys_role_inheritance_cache (user_id, role_id, inherited_role_id, inheritance_level)
    WITH RECURSIVE user_role_inheritance AS (
        -- 直接分配的角色
        SELECT 
            ur.user_id,
            ur.role_id as role_id,
            ur.role_id as inherited_role_id,
            0 as inheritance_level
        FROM sys_user_role ur
        JOIN sys_role r ON ur.role_id = r.role_id
        WHERE r.status = 'ACTIVE'
        
        UNION ALL
        
        -- 继承的父角色
        SELECT 
            uri.user_id,
            uri.role_id,
            pr.role_id as inherited_role_id,
            uri.inheritance_level + 1
        FROM sys_role pr
        JOIN user_role_inheritance uri ON pr.role_id = uri.inherited_role_id
        JOIN sys_role r ON uri.role_id = r.role_id
        WHERE pr.status = 'ACTIVE' 
          AND r.inherit_permissions = TRUE
          AND uri.inheritance_level < 10
    )
    SELECT DISTINCT * FROM user_role_inheritance;
END;
```

### 2. 使用缓存表快速查询用户权限

```sql
-- 使用缓存表快速查询用户权限
SELECT DISTINCT 
    p.permission_id,
    p.permission_code,
    p.permission_name,
    p.permission_type
FROM sys_role_inheritance_cache ric
JOIN sys_role_permission rp ON ric.inherited_role_id = rp.role_id
JOIN sys_permission p ON rp.permission_id = p.permission_id
WHERE ric.user_id = ? AND p.status = 'ACTIVE'
ORDER BY p.permission_type, p.permission_code;
```

---

## 📋 总结

### ✅ 查询示例覆盖的场景

1. **角色继承查询**: 递归查询用户的所有角色
2. **权限继承查询**: 获取用户的所有权限（包括继承）
3. **数据权限继承**: 根据继承关系确定数据访问范围
4. **菜单权限继承**: 基于继承权限控制菜单访问
5. **角色管理查询**: 角色树结构、循环检测等
6. **性能优化**: 缓存表、快速查询等

### 🎯 使用建议

1. **递归查询**: 适用于实时查询，但性能较低
2. **缓存表**: 适用于高频查询，需要定期刷新
3. **层级限制**: 建议限制最大继承层级，避免性能问题
4. **索引优化**: 为递归查询的关键字段创建索引

这些查询示例为角色继承功能提供了完整的技术实现方案，可以根据实际业务需求进行调整和优化。
