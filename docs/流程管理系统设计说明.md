# BTC-SaaS MES系统 流程管理系统设计说明

## 📋 概述

基于MES系统全局架构基础文档的分析，系统增加了完整的流程管理功能，支持复杂的业务流程定义、执行和监控。流程管理系统采用BPMN 2.0标准，支持主流程、子流程、并行执行、条件分支等复杂流程场景。

---

## 🏗️ 流程管理架构

### 1. 核心组件

- **流程定义引擎**: 支持可视化流程设计，定义流程模板
- **流程实例引擎**: 管理流程的执行实例和状态
- **任务分配引擎**: 处理任务的分配、认领和执行
- **流程监控引擎**: 监控流程执行状态和性能
- **历史追踪引擎**: 记录完整的流程执行历史

### 2. 支持的功能特性

- ✅ **流程类型**: 生产流程、质量流程、物流流程、维护流程、自定义流程
- ✅ **节点类型**: 开始节点、结束节点、任务节点、网关节点、子流程节点
- ✅ **执行模式**: 串行执行、并行执行、条件分支
- ✅ **任务分配**: 用户分配、角色分配、组织分配
- ✅ **状态管理**: 运行中、已完成、暂停、终止、失败
- ✅ **版本控制**: 流程版本管理，支持流程升级
- ✅ **条件判断**: 支持复杂的条件表达式
- ✅ **超时控制**: 节点超时设置和重试机制
- ✅ **历史追踪**: 完整的执行历史记录

---

## 📊 数据库表结构

### 1. 流程定义相关表

#### `workflow_definition` - 流程定义表
存储流程模板的定义信息，包括流程名称、类型、版本等。

**主要字段：**
- `workflow_id`: 流程ID
- `workflow_code`: 流程代码
- `workflow_name`: 流程名称
- `workflow_type`: 流程类型（生产/质量/物流/维护/自定义）
- `version`: 版本号
- `status`: 状态（活跃/非活跃/草稿）
- `is_template`: 是否模板

#### `workflow_node` - 流程节点表
定义流程中的各个节点，包括节点类型、执行顺序、配置等。

**主要字段：**
- `node_id`: 节点ID
- `workflow_id`: 所属流程ID
- `node_code`: 节点代码
- `node_name`: 节点名称
- `node_type`: 节点类型（开始/结束/任务/网关/子流程）
- `sequence_order`: 执行顺序
- `is_parallel`: 是否并行执行
- `timeout_minutes`: 超时时间
- `node_config`: 节点配置（JSON）

#### `workflow_connection` - 流程连接表
定义节点之间的连接关系和流转条件。

**主要字段：**
- `connection_id`: 连接ID
- `from_node_id`: 源节点ID
- `to_node_id`: 目标节点ID
- `connection_type`: 连接类型（普通/条件/异常）
- `condition_expression`: 条件表达式

### 2. 流程实例相关表

#### `workflow_instance` - 流程实例表
管理流程的执行实例，包括当前状态、变量等。

**主要字段：**
- `instance_id`: 实例ID
- `workflow_id`: 流程定义ID
- `business_key`: 业务键
- `business_type`: 业务类型
- `current_node_id`: 当前节点ID
- `instance_status`: 实例状态
- `variables`: 流程变量（JSON）

#### `workflow_task` - 流程任务表
管理流程中的具体任务，包括分配、状态、完成情况等。

**主要字段：**
- `task_id`: 任务ID
- `instance_id`: 所属实例ID
- `node_id`: 所属节点ID
- `assignee_type`: 分配类型（用户/角色/组织）
- `assignee_id`: 分配人ID
- `task_status`: 任务状态
- `due_date`: 截止时间
- `form_data`: 表单数据（JSON）

#### `workflow_history` - 流程历史表
记录流程执行的完整历史，用于审计和追溯。

**主要字段：**
- `history_id`: 历史ID
- `instance_id`: 实例ID
- `action_type`: 动作类型（开始/完成/跳过/失败等）
- `action_time`: 动作时间
- `operator_id`: 操作人ID
- `action_notes`: 动作备注
- `form_data`: 表单数据快照

---

## 🔄 典型流程场景

### 1. 生产流程

```
开始 → 工单下发 → 备料 → 首件验证 → [通过] → 批量生产 → IPQC抽检 → [合格] → 终测 → 包装 → 结束
                                    [未通过] → 工艺调整 → 重测
                                                    [不合格] → 返修 → 复检
```

### 2. IQC检验流程

```
开始 → 物料到货 → 创建检验单 → AQL抽样 → 检测 → [合格] → 入库 → 结束
                                          [不合格] → 隔离 → 特采/退货/NCR → 供应商评分 → 结束
```

### 3. OQC出货流程

```
开始 → 成品打包 → 生成箱号 → OQC抽检 → [合格] → 出货放行 → 结束
                                    [不合格] → 隔离/返修/复检 → 结束
```

### 4. 客诉追溯流程

```
开始 → 接收客诉 → 反查批次 → 关联用料 → 查询检验结果 → 提取测试记录 → 生成责任报告 → 结束
```

---

## 🛠️ 流程引擎功能

### 1. 流程设计器

- **可视化设计**: 拖拽式流程设计界面
- **节点配置**: 丰富的节点类型和配置选项
- **条件设置**: 支持复杂的条件表达式
- **验证检查**: 流程定义的有效性检查
- **版本管理**: 流程版本控制和升级

### 2. 流程执行引擎

- **实例管理**: 流程实例的创建、启动、暂停、恢复、终止
- **状态跟踪**: 实时跟踪流程执行状态
- **任务调度**: 自动任务分配和调度
- **异常处理**: 异常情况的处理和恢复
- **超时控制**: 节点超时检测和处理

### 3. 任务管理

- **任务分配**: 支持多种分配策略
- **任务认领**: 用户主动认领任务
- **任务委派**: 任务委派和转移
- **任务监控**: 任务执行进度监控
- **任务提醒**: 超时和逾期提醒

### 4. 监控分析

- **实时监控**: 流程执行实时状态
- **性能分析**: 流程执行性能统计
- **瓶颈识别**: 流程瓶颈分析
- **优化建议**: 流程优化建议
- **报表统计**: 流程执行报表

---

## 🔧 API接口设计

### 1. 流程定义管理

```http
# 创建流程定义
POST /api/workflow/definitions
{
  "workflow_code": "PRODUCTION_001",
  "workflow_name": "生产流程",
  "workflow_type": "PRODUCTION",
  "description": "标准生产流程"
}

# 获取流程定义列表
GET /api/workflow/definitions?type=PRODUCTION&status=ACTIVE

# 获取流程定义详情
GET /api/workflow/definitions/{workflow_id}

# 更新流程定义
PUT /api/workflow/definitions/{workflow_id}
```

### 2. 流程实例管理

```http
# 启动流程实例
POST /api/workflow/instances
{
  "workflow_id": "WF_001",
  "business_key": "WO-20250107-001",
  "business_type": "WORK_ORDER",
  "variables": {
    "wo_id": "WO-20250107-001",
    "item_id": "ITM-001",
    "quantity": 100
  }
}

# 获取流程实例列表
GET /api/workflow/instances?status=RUNNING&business_type=WORK_ORDER

# 获取流程实例详情
GET /api/workflow/instances/{instance_id}

# 暂停流程实例
POST /api/workflow/instances/{instance_id}/suspend

# 恢复流程实例
POST /api/workflow/instances/{instance_id}/resume

# 终止流程实例
POST /api/workflow/instances/{instance_id}/terminate
```

### 3. 任务管理

```http
# 获取待办任务
GET /api/workflow/tasks/pending?assignee_id=USER_001

# 获取任务详情
GET /api/workflow/tasks/{task_id}

# 完成任务
POST /api/workflow/tasks/{task_id}/complete
{
  "form_data": {
    "result": "PASS",
    "notes": "检验合格"
  },
  "completion_notes": "任务完成"
}

# 委派任务
POST /api/workflow/tasks/{task_id}/delegate
{
  "delegate_to": "USER_002",
  "delegate_reason": "临时委派"
}
```

### 4. 流程监控

```http
# 获取流程统计
GET /api/workflow/statistics?period=7d

# 获取流程性能分析
GET /api/workflow/performance?workflow_id=WF_001&period=30d

# 获取流程历史
GET /api/workflow/history?instance_id=INST_001
```

---

## 📈 性能优化策略

### 1. 数据库优化

- **索引优化**: 为常用查询字段建立合适的索引
- **分区策略**: 对历史表按时间分区
- **读写分离**: 查询操作使用只读副本
- **缓存策略**: 热点数据使用Redis缓存

### 2. 流程引擎优化

- **异步执行**: 非关键路径异步执行
- **批量处理**: 批量处理任务分配和状态更新
- **连接池**: 数据库连接池优化
- **内存管理**: 合理的内存使用和垃圾回收

### 3. 监控告警

- **性能监控**: 流程执行性能实时监控
- **异常告警**: 流程异常自动告警
- **资源监控**: 系统资源使用监控
- **业务监控**: 业务流程关键指标监控

---

## 🔒 安全控制

### 1. 权限控制

- **流程权限**: 流程定义的创建、修改、删除权限
- **实例权限**: 流程实例的查看、操作权限
- **任务权限**: 任务的查看、认领、完成权限
- **数据权限**: 基于租户和站点的数据隔离

### 2. 数据安全

- **敏感数据**: 敏感数据的加密存储
- **审计日志**: 完整的操作审计日志
- **数据备份**: 定期数据备份和恢复
- **访问控制**: 严格的访问控制机制

---

## 🚀 部署建议

### 1. 环境配置

- **数据库**: MySQL 8.0+，支持JSON字段和窗口函数
- **缓存**: Redis 6.0+，用于会话和缓存
- **应用服务器**: Java 11+，Spring Boot 2.7+
- **监控**: Prometheus + Grafana监控

### 2. 扩展性设计

- **水平扩展**: 支持多实例部署
- **负载均衡**: 使用负载均衡器分发请求
- **消息队列**: 使用消息队列处理异步任务
- **微服务**: 支持微服务架构部署

---

## 📚 使用示例

### 1. 创建生产流程

```sql
-- 创建流程定义
INSERT INTO workflow_definition (workflow_id, tenant_id, workflow_code, workflow_name, workflow_type, status, created_by)
VALUES ('WF_PRODUCTION_001', 'TENANT_001', 'PRODUCTION_STANDARD', '标准生产流程', 'PRODUCTION', 'ACTIVE', 'SYSTEM');

-- 创建流程节点
INSERT INTO workflow_node (node_id, workflow_id, node_code, node_name, node_type, sequence_order, created_by)
VALUES 
('NODE_START', 'WF_PRODUCTION_001', 'START', '开始', 'START', 1, 'SYSTEM'),
('NODE_WO_ISSUE', 'WF_PRODUCTION_001', 'WO_ISSUE', '工单下发', 'TASK', 2, 'SYSTEM'),
('NODE_MATERIAL_PREP', 'WF_PRODUCTION_001', 'MATERIAL_PREP', '备料', 'TASK', 3, 'SYSTEM'),
('NODE_FAI', 'WF_PRODUCTION_001', 'FAI', '首件验证', 'TASK', 4, 'SYSTEM'),
('NODE_BATCH_PRODUCTION', 'WF_PRODUCTION_001', 'BATCH_PRODUCTION', '批量生产', 'TASK', 5, 'SYSTEM'),
('NODE_IPQC', 'WF_PRODUCTION_001', 'IPQC', 'IPQC抽检', 'TASK', 6, 'SYSTEM'),
('NODE_FINAL_TEST', 'WF_PRODUCTION_001', 'FINAL_TEST', '终测', 'TASK', 7, 'SYSTEM'),
('NODE_PACKING', 'WF_PRODUCTION_001', 'PACKING', '包装', 'TASK', 8, 'SYSTEM'),
('NODE_END', 'WF_PRODUCTION_001', 'END', '结束', 'END', 9, 'SYSTEM');
```

### 2. 启动流程实例

```sql
-- 启动流程实例
INSERT INTO workflow_instance (instance_id, workflow_id, business_key, business_type, current_node_id, started_by, created_by)
VALUES ('INST_001', 'WF_PRODUCTION_001', 'WO-20250107-001', 'WORK_ORDER', 'NODE_WO_ISSUE', 'USER_001', 'SYSTEM');

-- 创建任务
INSERT INTO workflow_task (task_id, instance_id, node_id, task_name, assignee_type, assignee_id, created_by)
VALUES ('TASK_001', 'INST_001', 'NODE_WO_ISSUE', '工单下发任务', 'ROLE', 'ROLE_PRODUCTION_MANAGER', 'SYSTEM');
```

---

## 📋 总结

流程管理系统的设计充分考虑了MES系统的复杂业务流程需求，提供了完整的流程定义、执行、监控和历史追踪功能。通过可视化的流程设计器和强大的流程引擎，可以灵活地支持各种业务流程的数字化管理，提高生产效率和质量管理水平。

系统采用标准化的BPMN 2.0规范，具有良好的扩展性和可维护性，能够满足未来业务发展的需要。
