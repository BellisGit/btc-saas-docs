# æ•°æ®åº“æž¶æž„æ›´æ–°è¯´æ˜Ž

## ðŸ“‹ æ›´æ–°æ¦‚è¿°

**æ›´æ–°æ—¥æœŸ**: 2025-01-07  
**æ›´æ–°å†…å®¹**: æ•´ç†å’Œä¼˜åŒ–BTC-SaaS MESç³»ç»Ÿæ•°æ®åº“æž¶æž„  
**æ›´æ–°åŽŸå› **: ç»Ÿä¸€æ•°æ®åº“è¡¨ç»“æž„ï¼Œæ”¯æŒè§’è‰²ç»§æ‰¿å’Œæƒé™èœå•åˆ†ç¦»

---

## ðŸ”„ ä¸»è¦æ›´æ–°å†…å®¹

### 1. **æ–‡ä»¶ç»“æž„ä¼˜åŒ–**

#### æ›´æ–°å‰
```
mes-backend/database/schemas/
â”œâ”€â”€ btc_core_schema.sql                    # åŽŸå§‹ç‰ˆæœ¬
â”œâ”€â”€ btc_core_system_base_optimized.sql     # ä¼˜åŒ–ç‰ˆæœ¬
â”œâ”€â”€ btc_core_system_base_separated.sql     # åˆ†ç¦»ç‰ˆæœ¬
â”œâ”€â”€ btc_core_system_base_with_inheritance.sql  # ç»§æ‰¿ç‰ˆæœ¬
â””â”€â”€ btc_core/                              # æ¨¡å—åŒ–ç›®å½•
    â”œâ”€â”€ 01_master_data.sql
    â”œâ”€â”€ 02_production.sql
    â”œâ”€â”€ 03_inventory.sql
    â”œâ”€â”€ 04_quality.sql
    â”œâ”€â”€ 05_system_management.sql
    â””â”€â”€ 06_workflow_config.sql
```

#### æ›´æ–°åŽ
```
mes-backend/database/schemas/
â”œâ”€â”€ btc_core_schema.sql                    # æœ€ç»ˆç‰ˆæœ¬ï¼ˆæ”¯æŒè§’è‰²ç»§æ‰¿ï¼‰
â”œâ”€â”€ btc_bi/                                # BIæ•°æ®åº“æ¨¡å—
â”‚   â”œâ”€â”€ 01_production_bi.sql
â”‚   â”œâ”€â”€ 02_quality_bi.sql
â”‚   â””â”€â”€ 03_system_bi.sql
â”œâ”€â”€ btc_log/                               # æ—¥å¿—æ•°æ®åº“æ¨¡å—
â”‚   â”œâ”€â”€ 01_operation_logs.sql
â”‚   â””â”€â”€ 02_system_logs.sql
â”œâ”€â”€ btc_procurement_schema.sql             # é‡‡è´­ç®¡ç†æ•°æ®åº“
â””â”€â”€ btc_maintenance_schema.sql             # ç»´ä¿®ç®¡ç†æ•°æ®åº“
```

### 2. **æ ¸å¿ƒæ•°æ®åº“æž¶æž„ä¼˜åŒ–**

#### ç³»ç»ŸåŸºç¡€è¡¨ä¼˜åŒ–
- **æ–°å¢ž**: `sys_dept` éƒ¨é—¨è¡¨ï¼Œæ”¯æŒç»„ç»‡æž¶æž„
- **ä¼˜åŒ–**: `sys_user` ç”¨æˆ·è¡¨ï¼Œå…³è”éƒ¨é—¨ä¿¡æ¯
- **é‡æž„**: `sys_role` è§’è‰²è¡¨ï¼Œæ”¯æŒè§’è‰²ç»§æ‰¿
- **åˆ†ç¦»**: `sys_permission` æƒé™è¡¨å’Œ `sys_menu` èœå•è¡¨åˆ†ç¦»
- **æ–°å¢ž**: `sys_menu_permission` èœå•æƒé™å…³è”è¡¨

#### è§’è‰²ç»§æ‰¿åŠŸèƒ½
```sql
-- æ”¯æŒè§’è‰²ç»§æ‰¿çš„å…³é”®å­—æ®µ
CREATE TABLE sys_role (
    role_id VARCHAR(32) PRIMARY KEY,
    parent_role_id VARCHAR(32) COMMENT 'çˆ¶è§’è‰²ID',
    role_level INT DEFAULT 0 COMMENT 'è§’è‰²å±‚çº§',
    inherit_permissions BOOLEAN DEFAULT TRUE COMMENT 'æ˜¯å¦ç»§æ‰¿çˆ¶è§’è‰²æƒé™',
    inherit_data_scope BOOLEAN DEFAULT FALSE COMMENT 'æ˜¯å¦ç»§æ‰¿çˆ¶è§’è‰²æ•°æ®æƒé™',
    -- å…¶ä»–å­—æ®µ...
    FOREIGN KEY (parent_role_id) REFERENCES sys_role(role_id)
);
```

#### æƒé™èœå•åˆ†ç¦»
```sql
-- æƒé™è¡¨ï¼ˆä¸“æ³¨æƒé™æŽ§åˆ¶ï¼‰
CREATE TABLE sys_permission (
    permission_id VARCHAR(32) PRIMARY KEY,
    permission_code VARCHAR(128) NOT NULL,
    permission_type ENUM('MENU_ACCESS', 'BUTTON_ACTION', 'API_CALL', 'DATA_ACCESS'),
    resource_type VARCHAR(64) COMMENT 'èµ„æºç±»åž‹',
    resource_id VARCHAR(128) COMMENT 'èµ„æºæ ‡è¯†',
    action VARCHAR(64) COMMENT 'æ“ä½œç±»åž‹'
);

-- èœå•è¡¨ï¼ˆä¸“æ³¨ç•Œé¢å¯¼èˆªï¼‰
CREATE TABLE sys_menu (
    menu_id VARCHAR(32) PRIMARY KEY,
    menu_code VARCHAR(64) NOT NULL,
    menu_name VARCHAR(128) NOT NULL,
    path VARCHAR(255) COMMENT 'è·¯ç”±è·¯å¾„',
    component VARCHAR(255) COMMENT 'ç»„ä»¶è·¯å¾„',
    icon VARCHAR(64) COMMENT 'å›¾æ ‡'
);

-- èœå•æƒé™å…³è”è¡¨
CREATE TABLE sys_menu_permission (
    menu_id VARCHAR(32) NOT NULL,
    permission_id VARCHAR(32) NOT NULL,
    relation_type ENUM('REQUIRED', 'OPTIONAL') DEFAULT 'REQUIRED'
);
```

---

## ðŸ“Š æ•°æ®åº“æž¶æž„æ¦‚è§ˆ

### æœ€ç»ˆæ•°æ®åº“ç»“æž„

| æ•°æ®åº“ | è¡¨æ•°é‡ | ä¸»è¦åŠŸèƒ½ | æ–‡ä»¶ä½ç½® |
|--------|--------|----------|----------|
| **btc_core** | 45å¼  | æ ¸å¿ƒä¸šåŠ¡æ•°æ® | `btc_core_schema.sql` |
| **btc_procurement** | 9å¼  | é‡‡è´­ç®¡ç† | `btc_procurement_schema.sql` |
| **btc_maintenance** | 10å¼  | ç»´ä¿®ç®¡ç† | `btc_maintenance_schema.sql` |
| **btc_log** | 15å¼  | æ—¥å¿—ç³»ç»Ÿ | `btc_log/` ç›®å½• |
| **btc_bi** | 35å¼  | BIåˆ†æž | `btc_bi/` ç›®å½• |

### æ ¸å¿ƒè¡¨ç»“æž„å˜åŒ–

#### ç³»ç»ŸåŸºç¡€è¡¨ (9å¼ )
1. `tenant` - ç§Ÿæˆ·ç®¡ç†è¡¨
2. `sys_dept` - éƒ¨é—¨è¡¨ï¼ˆæ–°å¢žï¼‰
3. `sys_user` - ç”¨æˆ·è¡¨ï¼ˆä¼˜åŒ–ï¼‰
4. `sys_role` - è§’è‰²è¡¨ï¼ˆæ”¯æŒç»§æ‰¿ï¼‰
5. `sys_permission` - æƒé™è¡¨ï¼ˆé‡æž„ï¼‰
6. `sys_menu` - èœå•è¡¨ï¼ˆåˆ†ç¦»ï¼‰
7. `sys_menu_permission` - èœå•æƒé™å…³è”è¡¨ï¼ˆæ–°å¢žï¼‰
8. `sys_user_role` - ç”¨æˆ·è§’è‰²å…³è”è¡¨
9. `sys_role_permission` - è§’è‰²æƒé™å…³è”è¡¨

---

## ðŸ”§ æŠ€æœ¯ç‰¹æ€§

### 1. **è§’è‰²ç»§æ‰¿**
- æ”¯æŒå¤šå±‚çº§è§’è‰²ç»§æ‰¿
- æƒé™è‡ªåŠ¨ç»§æ‰¿
- æ•°æ®æƒé™èŒƒå›´ç»§æ‰¿
- å¾ªçŽ¯å¼•ç”¨æ£€æµ‹

### 2. **æƒé™èœå•åˆ†ç¦»**
- æƒé™ä¸“æ³¨è®¿é—®æŽ§åˆ¶
- èœå•ä¸“æ³¨ç•Œé¢å¯¼èˆª
- çµæ´»çš„æƒé™èœå•å…³è”
- æ”¯æŒå¤æ‚æƒé™æŽ§åˆ¶é€»è¾‘

### 3. **éƒ¨é—¨ç»„ç»‡æž¶æž„**
- æ”¯æŒå±‚çº§éƒ¨é—¨ç»“æž„
- ç”¨æˆ·å…³è”éƒ¨é—¨ä¿¡æ¯
- éƒ¨é—¨çº§æƒé™æŽ§åˆ¶
- æ•°æ®æƒé™èŒƒå›´æŽ§åˆ¶

### 4. **å­˜å‚¨è¿‡ç¨‹æ”¯æŒ**
- è§’è‰²ç»§æ‰¿å¾ªçŽ¯æ£€æµ‹
- è§’è‰²å±‚çº§è‡ªåŠ¨æ›´æ–°
- è§’è‰²ç»§æ‰¿è·¯å¾„æŸ¥è¯¢
- æƒé™ç»§æ‰¿æŸ¥è¯¢ä¼˜åŒ–

---

## ðŸš€ ä½¿ç”¨æŒ‡å—

### 1. **éƒ¨ç½²æ–°æž¶æž„**

```bash
# 1. å¤‡ä»½çŽ°æœ‰æ•°æ®åº“
mysqldump -u username -p database_name > backup.sql

# 2. æ‰§è¡Œæ–°çš„æž¶æž„æ–‡ä»¶
mysql -u username -p < mes-backend/database/schemas/btc_core_schema.sql

# 3. éªŒè¯æ•°æ®å®Œæ•´æ€§
mysql -u username -p -e "SHOW TABLES;" database_name
```

### 2. **è§’è‰²ç»§æ‰¿ä½¿ç”¨**

```sql
-- åˆ›å»ºè§’è‰²ç»§æ‰¿å…³ç³»
INSERT INTO sys_role (role_id, parent_role_id, role_code, role_name, inherit_permissions) 
VALUES ('ROLE_MANAGER', 'ROLE_ADMIN', 'MANAGER', 'éƒ¨é—¨ç»ç†', TRUE);

-- æŸ¥è¯¢ç”¨æˆ·çš„æ‰€æœ‰è§’è‰²ï¼ˆåŒ…æ‹¬ç»§æ‰¿ï¼‰
WITH RECURSIVE user_all_roles AS (
    -- ç›´æŽ¥åˆ†é…çš„è§’è‰²
    SELECT r.*, 0 as inheritance_level
    FROM sys_user_role ur
    JOIN sys_role r ON ur.role_id = r.role_id
    WHERE ur.user_id = ?
    
    UNION ALL
    
    -- ç»§æ‰¿çš„çˆ¶è§’è‰²
    SELECT pr.*, uar.inheritance_level + 1
    FROM sys_role pr
    JOIN user_all_roles uar ON pr.role_id = uar.parent_role_id
    WHERE uar.inherit_permissions = TRUE
)
SELECT * FROM user_all_roles;
```

### 3. **æƒé™èœå•å…³è”**

```sql
-- è®¾ç½®èœå•æƒé™å…³è”
INSERT INTO sys_menu_permission (menu_id, permission_id, relation_type) 
VALUES ('MENU_USER_MANAGE', 'PERM_USER_READ', 'REQUIRED');

-- æŸ¥è¯¢ç”¨æˆ·å¯è®¿é—®çš„èœå•
SELECT DISTINCT m.*
FROM sys_menu m
WHERE m.visible = TRUE 
  AND NOT EXISTS (
    SELECT 1 FROM sys_menu_permission mp
    WHERE mp.menu_id = m.menu_id 
      AND mp.relation_type = 'REQUIRED'
      AND mp.permission_id NOT IN (
        -- ç”¨æˆ·æ‹¥æœ‰çš„æƒé™
        SELECT rp.permission_id FROM sys_role_permission rp
        JOIN sys_user_role ur ON rp.role_id = ur.role_id
        WHERE ur.user_id = ?
      )
  );
```

---

## ðŸ“ˆ æ€§èƒ½ä¼˜åŒ–

### 1. **ç´¢å¼•ä¼˜åŒ–**
```sql
-- ä¸ºè§’è‰²ç»§æ‰¿æŸ¥è¯¢åˆ›å»ºç´¢å¼•
CREATE INDEX idx_role_parent ON sys_role(parent_role_id);
CREATE INDEX idx_role_level ON sys_role(role_level);
CREATE INDEX idx_user_role ON sys_user_role(user_id, role_id);
CREATE INDEX idx_role_permission ON sys_role_permission(role_id, permission_id);
```

### 2. **ç¼“å­˜ç­–ç•¥**
- è§’è‰²ç»§æ‰¿å…³ç³»ç¼“å­˜
- ç”¨æˆ·æƒé™ç¼“å­˜
- èœå•æƒé™ç¼“å­˜
- å®šæœŸåˆ·æ–°ç¼“å­˜

### 3. **æŸ¥è¯¢ä¼˜åŒ–**
- ä½¿ç”¨é€’å½’æŸ¥è¯¢å¤„ç†è§’è‰²ç»§æ‰¿
- é¿å…æ·±åº¦é€’å½’ï¼ˆé™åˆ¶å±‚çº§ï¼‰
- ä½¿ç”¨EXISTSæ›¿ä»£INå­æŸ¥è¯¢
- åˆç†ä½¿ç”¨LIMITé™åˆ¶ç»“æžœé›†

---

## ðŸ”„ è¿ç§»æŒ‡å—

### ä»Žæ—§æž¶æž„è¿ç§»

1. **æ•°æ®è¿ç§»è„šæœ¬**
```sql
-- è¿ç§»ç”¨æˆ·æ•°æ®
INSERT INTO sys_user (user_id, tenant_id, dept_id, username, ...)
SELECT user_id, tenant_id, 'DEFAULT_DEPT', username, ...
FROM old_user_table;

-- è¿ç§»è§’è‰²æ•°æ®
INSERT INTO sys_role (role_id, tenant_id, role_code, role_name, ...)
SELECT role_id, tenant_id, role_code, role_name, ...
FROM old_role_table;

-- è¿ç§»æƒé™æ•°æ®
INSERT INTO sys_permission (permission_id, permission_code, ...)
SELECT permission_id, permission_code, ...
FROM old_permission_table;
```

2. **æƒé™èœå•å…³è”è¿ç§»**
```sql
-- å°†æ—§çš„èœå•æƒé™å…³è”è¿ç§»åˆ°æ–°è¡¨
INSERT INTO sys_menu_permission (menu_id, permission_id, relation_type)
SELECT menu_id, permission_id, 'REQUIRED'
FROM old_menu_permission_table;
```

---

## ðŸ“‹ æ›´æ–°æ£€æŸ¥æ¸…å•

### âœ… å·²å®Œæˆ
- [x] åˆ é™¤é‡å¤çš„btc_coreè¡¨ç»“æž„æ–‡ä»¶
- [x] ç»Ÿä¸€ä¸ºæœ€ç»ˆç‰ˆæœ¬ï¼ˆæ”¯æŒè§’è‰²ç»§æ‰¿ï¼‰
- [x] æ›´æ–°æ•°æ®åº“è¡¨ç»“æž„æ¸…å•æ–‡æ¡£
- [x] æ›´æ–°è¡¨å…³ç³»å›¾
- [x] åˆ›å»ºæž¶æž„æ›´æ–°è¯´æ˜Žæ–‡æ¡£

### ðŸ”„ å¾…å®Œæˆ
- [ ] æ›´æ–°ç›¸å…³è¿ç§»è„šæœ¬
- [ ] æ›´æ–°APIæ–‡æ¡£
- [ ] æ›´æ–°å‰ç«¯æƒé™æŽ§åˆ¶ä»£ç 
- [ ] æ€§èƒ½æµ‹è¯•å’Œä¼˜åŒ–

---

## ðŸ“ž æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»ï¼š
- **æ•°æ®åº“æž¶æž„å¸ˆ**: db-arch@btc-mes.com
- **å¼€å‘å›¢é˜Ÿ**: dev@btc-mes.com
- **æŠ€æœ¯æ”¯æŒ**: support@btc-mes.com

---

*æœ€åŽæ›´æ–°æ—¶é—´: 2025-01-07*  
*æ–‡æ¡£ç‰ˆæœ¬: v2.0.0*
