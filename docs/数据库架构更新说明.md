# 数据库架构更新说明

## 📋 更新概述

**更新日期**: 2025-01-07  
**更新内容**: 整理和优化BTC-SaaS MES系统数据库架构  
**更新原因**: 统一数据库表结构，支持角色继承和权限菜单分离

---

## 🔄 主要更新内容

### 1. **文件结构优化**

#### 更新前
```
mes-backend/database/schemas/
├── btc_core_schema.sql                    # 原始版本
├── btc_core_system_base_optimized.sql     # 优化版本
├── btc_core_system_base_separated.sql     # 分离版本
├── btc_core_system_base_with_inheritance.sql  # 继承版本
└── btc_core/                              # 模块化目录
    ├── 01_master_data.sql
    ├── 02_production.sql
    ├── 03_inventory.sql
    ├── 04_quality.sql
    ├── 05_system_management.sql
    └── 06_workflow_config.sql
```

#### 更新后
```
mes-backend/database/schemas/
├── btc_core_schema.sql                    # 最终版本（支持角色继承）
├── btc_bi/                                # BI数据库模块
│   ├── 01_production_bi.sql
│   ├── 02_quality_bi.sql
│   └── 03_system_bi.sql
├── btc_log/                               # 日志数据库模块
│   ├── 01_operation_logs.sql
│   └── 02_system_logs.sql
├── btc_procurement_schema.sql             # 采购管理数据库
└── btc_maintenance_schema.sql             # 维修管理数据库
```

### 2. **核心数据库架构优化**

#### 系统基础表优化
- **新增**: `sys_dept` 部门表，支持组织架构
- **优化**: `sys_user` 用户表，关联部门信息
- **重构**: `sys_role` 角色表，支持角色继承
- **分离**: `sys_permission` 权限表和 `sys_menu` 菜单表分离
- **新增**: `sys_menu_permission` 菜单权限关联表

#### 角色继承功能
```sql
-- 支持角色继承的关键字段
CREATE TABLE sys_role (
    role_id VARCHAR(32) PRIMARY KEY,
    parent_role_id VARCHAR(32) COMMENT '父角色ID',
    role_level INT DEFAULT 0 COMMENT '角色层级',
    inherit_permissions BOOLEAN DEFAULT TRUE COMMENT '是否继承父角色权限',
    inherit_data_scope BOOLEAN DEFAULT FALSE COMMENT '是否继承父角色数据权限',
    -- 其他字段...
    FOREIGN KEY (parent_role_id) REFERENCES sys_role(role_id)
);
```

#### 权限菜单分离
```sql
-- 权限表（专注权限控制）
CREATE TABLE sys_permission (
    permission_id VARCHAR(32) PRIMARY KEY,
    permission_code VARCHAR(128) NOT NULL,
    permission_type ENUM('MENU_ACCESS', 'BUTTON_ACTION', 'API_CALL', 'DATA_ACCESS'),
    resource_type VARCHAR(64) COMMENT '资源类型',
    resource_id VARCHAR(128) COMMENT '资源标识',
    action VARCHAR(64) COMMENT '操作类型'
);

-- 菜单表（专注界面导航）
CREATE TABLE sys_menu (
    menu_id VARCHAR(32) PRIMARY KEY,
    menu_code VARCHAR(64) NOT NULL,
    menu_name VARCHAR(128) NOT NULL,
    path VARCHAR(255) COMMENT '路由路径',
    component VARCHAR(255) COMMENT '组件路径',
    icon VARCHAR(64) COMMENT '图标'
);

-- 菜单权限关联表
CREATE TABLE sys_menu_permission (
    menu_id VARCHAR(32) NOT NULL,
    permission_id VARCHAR(32) NOT NULL,
    relation_type ENUM('REQUIRED', 'OPTIONAL') DEFAULT 'REQUIRED'
);
```

---

## 📊 数据库架构概览

### 最终数据库结构

| 数据库 | 表数量 | 主要功能 | 文件位置 |
|--------|--------|----------|----------|
| **btc_core** | 45张 | 核心业务数据 | `btc_core_schema.sql` |
| **btc_procurement** | 9张 | 采购管理 | `btc_procurement_schema.sql` |
| **btc_maintenance** | 10张 | 维修管理 | `btc_maintenance_schema.sql` |
| **btc_log** | 15张 | 日志系统 | `btc_log/` 目录 |
| **btc_bi** | 35张 | BI分析 | `btc_bi/` 目录 |

### 核心表结构变化

#### 系统基础表 (9张)
1. `tenant` - 租户管理表
2. `sys_dept` - 部门表（新增）
3. `sys_user` - 用户表（优化）
4. `sys_role` - 角色表（支持继承）
5. `sys_permission` - 权限表（重构）
6. `sys_menu` - 菜单表（分离）
7. `sys_menu_permission` - 菜单权限关联表（新增）
8. `sys_user_role` - 用户角色关联表
9. `sys_role_permission` - 角色权限关联表

---

## 🔧 技术特性

### 1. **角色继承**
- 支持多层级角色继承
- 权限自动继承
- 数据权限范围继承
- 循环引用检测

### 2. **权限菜单分离**
- 权限专注访问控制
- 菜单专注界面导航
- 灵活的权限菜单关联
- 支持复杂权限控制逻辑

### 3. **部门组织架构**
- 支持层级部门结构
- 用户关联部门信息
- 部门级权限控制
- 数据权限范围控制

### 4. **存储过程支持**
- 角色继承循环检测
- 角色层级自动更新
- 角色继承路径查询
- 权限继承查询优化

---

## 🚀 使用指南

### 1. **部署新架构**

```bash
# 1. 备份现有数据库
mysqldump -u username -p database_name > backup.sql

# 2. 执行新的架构文件
mysql -u username -p < mes-backend/database/schemas/btc_core_schema.sql

# 3. 验证数据完整性
mysql -u username -p -e "SHOW TABLES;" database_name
```

### 2. **角色继承使用**

```sql
-- 创建角色继承关系
INSERT INTO sys_role (role_id, parent_role_id, role_code, role_name, inherit_permissions) 
VALUES ('ROLE_MANAGER', 'ROLE_ADMIN', 'MANAGER', '部门经理', TRUE);

-- 查询用户的所有角色（包括继承）
WITH RECURSIVE user_all_roles AS (
    -- 直接分配的角色
    SELECT r.*, 0 as inheritance_level
    FROM sys_user_role ur
    JOIN sys_role r ON ur.role_id = r.role_id
    WHERE ur.user_id = ?
    
    UNION ALL
    
    -- 继承的父角色
    SELECT pr.*, uar.inheritance_level + 1
    FROM sys_role pr
    JOIN user_all_roles uar ON pr.role_id = uar.parent_role_id
    WHERE uar.inherit_permissions = TRUE
)
SELECT * FROM user_all_roles;
```

### 3. **权限菜单关联**

```sql
-- 设置菜单权限关联
INSERT INTO sys_menu_permission (menu_id, permission_id, relation_type) 
VALUES ('MENU_USER_MANAGE', 'PERM_USER_READ', 'REQUIRED');

-- 查询用户可访问的菜单
SELECT DISTINCT m.*
FROM sys_menu m
WHERE m.visible = TRUE 
  AND NOT EXISTS (
    SELECT 1 FROM sys_menu_permission mp
    WHERE mp.menu_id = m.menu_id 
      AND mp.relation_type = 'REQUIRED'
      AND mp.permission_id NOT IN (
        -- 用户拥有的权限
        SELECT rp.permission_id FROM sys_role_permission rp
        JOIN sys_user_role ur ON rp.role_id = ur.role_id
        WHERE ur.user_id = ?
      )
  );
```

---

## 📈 性能优化

### 1. **索引优化**
```sql
-- 为角色继承查询创建索引
CREATE INDEX idx_role_parent ON sys_role(parent_role_id);
CREATE INDEX idx_role_level ON sys_role(role_level);
CREATE INDEX idx_user_role ON sys_user_role(user_id, role_id);
CREATE INDEX idx_role_permission ON sys_role_permission(role_id, permission_id);
```

### 2. **缓存策略**
- 角色继承关系缓存
- 用户权限缓存
- 菜单权限缓存
- 定期刷新缓存

### 3. **查询优化**
- 使用递归查询处理角色继承
- 避免深度递归（限制层级）
- 使用EXISTS替代IN子查询
- 合理使用LIMIT限制结果集

---

## 🔄 迁移指南

### 从旧架构迁移

1. **数据迁移脚本**
```sql
-- 迁移用户数据
INSERT INTO sys_user (user_id, tenant_id, dept_id, username, ...)
SELECT user_id, tenant_id, 'DEFAULT_DEPT', username, ...
FROM old_user_table;

-- 迁移角色数据
INSERT INTO sys_role (role_id, tenant_id, role_code, role_name, ...)
SELECT role_id, tenant_id, role_code, role_name, ...
FROM old_role_table;

-- 迁移权限数据
INSERT INTO sys_permission (permission_id, permission_code, ...)
SELECT permission_id, permission_code, ...
FROM old_permission_table;
```

2. **权限菜单关联迁移**
```sql
-- 将旧的菜单权限关联迁移到新表
INSERT INTO sys_menu_permission (menu_id, permission_id, relation_type)
SELECT menu_id, permission_id, 'REQUIRED'
FROM old_menu_permission_table;
```

---

## 📋 更新检查清单

### ✅ 已完成
- [x] 删除重复的btc_core表结构文件
- [x] 统一为最终版本（支持角色继承）
- [x] 更新数据库表结构清单文档
- [x] 更新表关系图
- [x] 创建架构更新说明文档

### 🔄 待完成
- [ ] 更新相关迁移脚本
- [ ] 更新API文档
- [ ] 更新前端权限控制代码
- [ ] 性能测试和优化

---

## 📞 技术支持

如有问题，请联系：
- **数据库架构师**: db-arch@btc-mes.com
- **开发团队**: dev@btc-mes.com
- **技术支持**: support@btc-mes.com

---

*最后更新时间: 2025-01-07*  
*文档版本: v2.0.0*
