# 用户角色多对多关系设计说明

## 📋 概述

本系统采用**多对多关系**设计用户和角色之间的关联，支持一个用户拥有多个角色，一个角色分配给多个用户的灵活权限管理。

---

## 🏗️ 数据库设计

### 1. 表结构

```sql
CREATE TABLE sys_user_role (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    user_id VARCHAR(32) NOT NULL COMMENT '用户ID',
    role_id VARCHAR(32) NOT NULL COMMENT '角色ID',
    created_by VARCHAR(64) NOT NULL,
    created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    INDEX idx_user (user_id),
    INDEX idx_role (role_id),
    UNIQUE KEY uk_user_role (user_id, role_id),  -- 防止重复分配
    FOREIGN KEY (user_id) REFERENCES sys_user(user_id),
    FOREIGN KEY (role_id) REFERENCES sys_role(role_id)
) COMMENT '用户角色关联表';
```

### 2. 设计特性

#### 2.1 多对多关系
- **一个用户 → 多个角色**: 用户可以被分配多个不同的角色
- **一个角色 → 多个用户**: 同一个角色可以分配给多个用户
- **唯一约束**: 防止同一用户重复分配同一角色

#### 2.2 索引优化
- `idx_user`: 支持快速查询用户的所有角色
- `idx_role`: 支持快速查询角色的所有用户
- `uk_user_role`: 确保用户-角色组合的唯一性

---

## 🎯 实际应用场景

### 1. 跨部门角色分配

#### 场景1: 工程部门主管 + 系统管理员
```sql
-- 用户: USER_INERT_ENGINEER_LEADER (工程部门主管)
-- 角色1: ROLE_INERT_ENGINEER_LEADER (工程部门主管)
-- 角色2: ROLE_INERT_SYSTEM_ADMIN (系统管理员)
```

**业务含义**: 工程部门主管同时具有系统管理权限，可以管理整个系统的配置。

#### 场景2: 品质经理 + 追溯分析师
```sql
-- 用户: USER_INERT_QC_MANAGER (品质经理)
-- 角色1: ROLE_INERT_QC_MANAGER (品质经理)
-- 角色2: ROLE_INERT_TRACE_ANALYST (追溯分析师)
```

**业务含义**: 品质经理同时具有追溯分析能力，可以进行质量问题的深度分析。

#### 场景3: 生产经理 + 质量管控
```sql
-- 用户: USER_INERT_PRODUCTION_MANAGER (生产经理)
-- 角色1: ROLE_INERT_PRODUCTION_MANAGER (生产经理)
-- 角色2: ROLE_INERT_QC_MANAGER (品质经理)
```

**业务含义**: 生产经理同时具有质量管控权限，可以在生产过程中进行质量控制。

#### 场景4: 物流经理 + 维护管理
```sql
-- 用户: USER_INERT_LOGISTICS_MANAGER (物流经理)
-- 角色1: ROLE_INERT_LOGISTICS_MANAGER (物流经理)
-- 角色2: ROLE_INERT_MAINTENANCE_MANAGER (维护经理)
```

**业务含义**: 物流经理同时具有维护管理权限，可以管理物流设备的维护。

### 2. 角色共享场景

#### 场景1: 多个生产操作员
```sql
-- 角色: ROLE_INERT_PRODUCTION_OPERATOR (生产操作员)
-- 用户1: USER_INERT_PRODUCTION_OPERATOR_001
-- 用户2: USER_INERT_PRODUCTION_OPERATOR_002
-- 用户3: USER_INERT_PRODUCTION_OPERATOR_003
```

**业务含义**: 多个用户都可以是生产操作员，共享相同的操作权限。

#### 场景2: 多个品质检验员
```sql
-- 角色: ROLE_INERT_QC_INSPECTOR (品质检验员)
-- 用户1: USER_INERT_QC_INSPECTOR_001
-- 用户2: USER_INERT_QC_INSPECTOR_002
-- 用户3: USER_INERT_QC_INSPECTOR_003
```

**业务含义**: 多个用户都可以是品质检验员，共享相同的检验权限。

---

## 🔍 查询示例

### 1. 查询用户的所有角色

```sql
-- 查询工程部门主管的所有角色
SELECT 
    u.real_name AS user_name,
    r.role_name,
    r.role_code,
    r.data_scope
FROM sys_user u
JOIN sys_user_role ur ON u.user_id = ur.user_id
JOIN sys_role r ON ur.role_id = r.role_id
WHERE u.user_id = 'USER_INERT_ENGINEER_LEADER';
```

**预期结果**:
```
user_name        | role_name      | role_code              | data_scope
工程部门主管     | 工程部门主管   | INERT_ENGINEER_LEADER  | DEPT_AND_CHILD
工程部门主管     | 内网系统管理员 | INERT_SYSTEM_ADMIN     | ALL
```

### 2. 查询角色的所有用户

```sql
-- 查询品质经理角色的所有用户
SELECT 
    r.role_name,
    u.real_name AS user_name,
    d.dept_name AS department
FROM sys_role r
JOIN sys_user_role ur ON r.role_id = ur.role_id
JOIN sys_user u ON ur.user_id = u.user_id
JOIN sys_dept d ON u.dept_id = d.dept_id
WHERE r.role_code = 'INERT_QC_MANAGER';
```

**预期结果**:
```
role_name | user_name | department
品质经理  | 品质经理  | 品质部门
品质经理  | 生产经理  | 生产部门
```

### 3. 查询用户的权限汇总

```sql
-- 查询用户的所有权限（通过角色）
SELECT DISTINCT
    u.real_name AS user_name,
    p.permission_code,
    p.permission_name,
    p.permission_type
FROM sys_user u
JOIN sys_user_role ur ON u.user_id = ur.user_id
JOIN sys_role r ON ur.role_id = r.role_id
JOIN sys_role_permission rp ON r.role_id = rp.role_id
JOIN sys_permission p ON rp.permission_id = p.permission_id
WHERE u.user_id = 'USER_INERT_ENGINEER_LEADER'
ORDER BY p.permission_type, p.permission_code;
```

---

## 🎭 权限计算逻辑

### 1. 权限合并规则

当用户拥有多个角色时，权限按以下规则合并：

#### 1.1 权限取并集
```sql
-- 用户权限 = 所有角色权限的并集
-- 例如：用户A有角色1和角色2
-- 角色1权限: [PERM_A, PERM_B]
-- 角色2权限: [PERM_B, PERM_C]
-- 用户A最终权限: [PERM_A, PERM_B, PERM_C]
```

#### 1.2 数据权限取最大范围
```sql
-- 数据权限范围优先级: ALL > DEPT_AND_CHILD > DEPT > SELF
-- 例如：用户A有角色1(DEPT)和角色2(ALL)
-- 用户A最终数据权限: ALL
```

### 2. 权限验证流程

```sql
-- 1. 查询用户的所有角色
-- 2. 查询所有角色的权限
-- 3. 合并权限（去重）
-- 4. 确定数据权限范围（取最大）
-- 5. 验证当前操作是否在权限范围内
```

---

## 🚀 扩展场景

### 1. 临时角色分配

```sql
-- 为临时项目分配特殊角色
INSERT INTO sys_user_role (user_id, role_id, created_by) VALUES
('USER_INERT_ENGINEER', 'ROLE_INERT_QC_INSPECTOR', 'SYSTEM');
```

**业务含义**: 工程师临时参与质量检验工作。

### 2. 跨租户角色

```sql
-- 英国领导同时具有内网查看权限
INSERT INTO sys_user_role (user_id, role_id, created_by) VALUES
('USER_UK_LEADER', 'ROLE_INERT_QC_MANAGER', 'SYSTEM');
```

**业务含义**: 英国领导可以查看内网的质量管理数据。

### 3. 角色继承增强

```sql
-- 高级工程师继承基础工程师权限
INSERT INTO sys_user_role (user_id, role_id, created_by) VALUES
('USER_INERT_SENIOR_ENGINEER', 'ROLE_INERT_ENGINEER', 'SYSTEM'),
('USER_INERT_SENIOR_ENGINEER', 'ROLE_INERT_ENGINEER_LEADER', 'SYSTEM');
```

**业务含义**: 高级工程师同时具有基础工程师和主管的权限。

---

## 📊 数据统计

### 1. 当前多对多关系统计

#### 1.1 用户角色分配统计
```
总用户数: 11个
总角色数: 20+个
用户角色关联数: 15个
多角色用户数: 4个
```

#### 1.2 多角色用户详情
```
USER_INERT_ENGINEER_LEADER: 2个角色
USER_INERT_QC_MANAGER: 2个角色  
USER_INERT_PRODUCTION_MANAGER: 2个角色
USER_INERT_LOGISTICS_MANAGER: 2个角色
```

### 2. 角色共享统计

```
ROLE_INERT_QC_MANAGER: 2个用户
ROLE_INERT_SYSTEM_ADMIN: 2个用户
ROLE_INERT_TRACE_ANALYST: 1个用户
ROLE_INERT_MAINTENANCE_MANAGER: 1个用户
```

---

## 🔧 管理建议

### 1. 角色分配原则

#### 1.1 最小权限原则
- 用户只分配必要的角色
- 避免过度授权
- 定期审查角色分配

#### 1.2 职责分离原则
- 关键操作需要多个角色确认
- 避免单一用户拥有过多权限
- 建立权限审批流程

### 2. 监控和维护

#### 2.1 权限审计
```sql
-- 查询拥有多个角色的用户
SELECT 
    u.real_name,
    COUNT(ur.role_id) AS role_count,
    GROUP_CONCAT(r.role_name) AS roles
FROM sys_user u
JOIN sys_user_role ur ON u.user_id = ur.user_id
JOIN sys_role r ON ur.role_id = r.role_id
GROUP BY u.user_id, u.real_name
HAVING COUNT(ur.role_id) > 1
ORDER BY role_count DESC;
```

#### 2.2 角色使用统计
```sql
-- 查询角色使用频率
SELECT 
    r.role_name,
    COUNT(ur.user_id) AS user_count
FROM sys_role r
LEFT JOIN sys_user_role ur ON r.role_id = ur.role_id
GROUP BY r.role_id, r.role_name
ORDER BY user_count DESC;
```

---

## 📋 总结

### 1. 设计优势

- ✅ **灵活性**: 支持复杂的权限分配需求
- ✅ **可扩展性**: 易于添加新的角色和用户
- ✅ **可维护性**: 清晰的关联关系，便于管理
- ✅ **性能优化**: 合理的索引设计，支持高效查询

### 2. 应用价值

- ✅ **业务适配**: 支持实际业务中的复杂权限需求
- ✅ **角色复用**: 同一角色可以分配给多个用户
- ✅ **权限组合**: 用户可以通过多个角色获得复合权限
- ✅ **动态调整**: 支持运行时动态调整用户角色

### 3. 最佳实践

- ✅ **合理设计**: 基于实际业务需求设计角色
- ✅ **权限审计**: 定期审查和优化权限分配
- ✅ **文档维护**: 保持角色权限文档的更新
- ✅ **监控告警**: 建立权限异常的监控机制

这个多对多关系设计为MES系统提供了灵活、可扩展的权限管理基础，能够很好地适应复杂的业务场景和权限需求。
