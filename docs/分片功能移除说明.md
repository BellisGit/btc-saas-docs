# 分片功能移除说明

## 📋 移除概述

**移除日期**: 2025-01-07  
**移除原因**: 暂时不需要分片功能，简化数据库架构  
**影响范围**: 数据库表结构、部署脚本、文档

---

## 🔄 移除内容

### 1. **数据库表结构移除**

#### 移除的分区定义
所有BI聚合表的分区定义已被移除，包括：

**btc_bi/01_production_bi.sql**
- `agg_production_progress_5m` 表
- `agg_wip_status_5m` 表  
- `agg_inventory_turnover_1h` 表
- `agg_stock_transaction_5m` 表
- `agg_supplier_performance_1d` 表
- `agg_cost_analysis_1d` 表
- `agg_workorder_efficiency_1h` 表

**btc_bi/02_quality_bi.sql**
- `agg_quality_stats_5m` 表
- `agg_defect_analysis_1h` 表
- `agg_inspector_performance_1d` 表
- `agg_repair_stats_1h` 表
- `agg_test_stats_1h` 表
- `agg_quality_cost_1d` 表

**btc_bi/03_system_bi.sql**
- `agg_equipment_efficiency_5m` 表
- `agg_equipment_failure_1h` 表
- `agg_alert_stats_1h` 表
- `agg_sensor_data_5m` 表
- `agg_user_activity_1h` 表
- `agg_system_performance_5m` 表

#### 移除的分区语法
```sql
-- 移除前（有分区）
CREATE TABLE agg_production_progress_5m (
    bucket_start DATETIME PRIMARY KEY,
    -- 其他字段...
) COMMENT '生产进度聚合表(5分钟)' 
PARTITION BY RANGE (TO_DAYS(bucket_start)) (
    PARTITION p202501 VALUES LESS THAN (TO_DAYS('2025-02-01')),
    PARTITION p202502 VALUES LESS THAN (TO_DAYS('2025-03-01')),
    -- 更多分区...
    PARTITION p_future VALUES LESS THAN MAXVALUE
);

-- 移除后（无分区）
CREATE TABLE agg_production_progress_5m (
    bucket_start DATETIME PRIMARY KEY,
    -- 其他字段...
) COMMENT '生产进度聚合表(5分钟)';
```

### 2. **部署脚本移除**

#### 移除的存储过程
- `CreateMonthlyPartition` - 创建月度分区
- `DropOldPartitions` - 删除旧分区

#### 移除的定时任务
```bash
# 移除前（分区管理定时任务）
0 2 1 * * root mysql -u root -pPASSWORD btc_log -e "CALL CreateMonthlyPartition('user_behavior_log', DATE_ADD(CURDATE(), INTERVAL 1 MONTH));"
0 3 15 * * root mysql -u root -pPASSWORD btc_log -e "CALL DropOldPartitions('user_behavior_log', 6);"

# 移除后（数据清理定时任务）
0 2 * * * root mysql -u root -pPASSWORD btc_log -e "DELETE FROM user_behavior_log WHERE occurred_at < DATE_SUB(NOW(), INTERVAL 6 MONTH);"
```

### 3. **文档更新**

#### 更新的文档文件
- `docs/09-database-deployment-guide.md` - 移除分区管理章节
- `docs/04-physical-layout.md` - 移除分区示例代码
- `docs/10-business-extension-complete.md` - 移除分区优化建议
- `docs/11-security-and-compliance.md` - 移除分区表定义

---

## 📊 影响分析

### 1. **性能影响**

#### 优势
- **简化部署**: 无需管理复杂的分区创建和清理逻辑
- **减少维护**: 不需要监控分区状态和存储过程执行
- **降低复杂度**: 表结构更加简单，易于理解和维护

#### 劣势
- **查询性能**: 对于大数据量表的查询可能较慢
- **数据管理**: 需要手动管理历史数据清理
- **存储效率**: 无法利用分区的存储优化特性

### 2. **功能影响**

#### 不受影响的功能
- ✅ 基本的数据存储和查询
- ✅ 索引查询性能
- ✅ 数据完整性约束
- ✅ 多租户数据隔离

#### 受影响的功能
- ❌ 自动分区管理
- ❌ 基于时间的数据归档
- ❌ 分区级别的查询优化

---

## 🔧 替代方案

### 1. **数据清理策略**

#### 定期清理脚本
```sql
-- 清理6个月前的日志数据
DELETE FROM user_behavior_log 
WHERE occurred_at < DATE_SUB(NOW(), INTERVAL 6 MONTH);

-- 清理1年前的BI聚合数据
DELETE FROM agg_production_progress_5m 
WHERE bucket_start < DATE_SUB(NOW(), INTERVAL 1 YEAR);
```

#### 定时任务配置
```bash
# 每天凌晨2点执行数据清理
0 2 * * * root /usr/local/bin/btc-data-cleanup.sh
```

### 2. **查询优化策略**

#### 索引优化
```sql
-- 为时间字段创建索引
CREATE INDEX idx_bucket_start ON agg_production_progress_5m (bucket_start);
CREATE INDEX idx_occurred_at ON user_behavior_log (occurred_at);

-- 创建复合索引
CREATE INDEX idx_tenant_time ON agg_production_progress_5m (tenant_id, bucket_start);
```

#### 查询优化
```sql
-- 使用时间范围限制查询
SELECT * FROM agg_production_progress_5m 
WHERE tenant_id = ? 
  AND bucket_start >= DATE_SUB(NOW(), INTERVAL 7 DAY)
  AND bucket_start < NOW();
```

### 3. **监控策略**

#### 表大小监控
```sql
-- 监控表大小
SELECT 
    table_name,
    ROUND(((data_length + index_length) / 1024 / 1024), 2) AS 'Size (MB)'
FROM information_schema.tables 
WHERE table_schema = 'btc_bi'
ORDER BY (data_length + index_length) DESC;
```

#### 查询性能监控
```sql
-- 监控慢查询
SELECT 
    query_time,
    lock_time,
    rows_examined,
    sql_text
FROM mysql.slow_log 
WHERE start_time >= DATE_SUB(NOW(), INTERVAL 1 DAY)
ORDER BY query_time DESC;
```

---

## 🚀 迁移指南

### 1. **现有分区表迁移**

如果系统中已存在分区表，需要先移除分区：

```sql
-- 移除表分区
ALTER TABLE agg_production_progress_5m REMOVE PARTITIONING;

-- 重新创建索引
DROP INDEX idx_bucket_start ON agg_production_progress_5m;
CREATE INDEX idx_bucket_start ON agg_production_progress_5m (bucket_start);
```

### 2. **存储过程清理**

```sql
-- 删除分区管理存储过程
DROP PROCEDURE IF EXISTS CreateMonthlyPartition;
DROP PROCEDURE IF EXISTS DropOldPartitions;
```

### 3. **定时任务更新**

```bash
# 删除旧的分区管理定时任务
rm /etc/cron.d/btc-database-partitions

# 创建新的数据清理定时任务
cat > /etc/cron.d/btc-database-maintenance << EOF
0 2 * * * root /usr/local/bin/btc-data-cleanup.sh
EOF
```

---

## 📈 性能建议

### 1. **数据归档策略**

#### 历史数据归档
```sql
-- 创建归档表
CREATE TABLE agg_production_progress_5m_archive LIKE agg_production_progress_5m;

-- 归档旧数据
INSERT INTO agg_production_progress_5m_archive 
SELECT * FROM agg_production_progress_5m 
WHERE bucket_start < DATE_SUB(NOW(), INTERVAL 1 YEAR);

-- 删除已归档数据
DELETE FROM agg_production_progress_5m 
WHERE bucket_start < DATE_SUB(NOW(), INTERVAL 1 YEAR);
```

### 2. **查询优化**

#### 使用LIMIT限制结果集
```sql
-- 限制查询结果数量
SELECT * FROM agg_production_progress_5m 
WHERE bucket_start >= DATE_SUB(NOW(), INTERVAL 7 DAY)
ORDER BY bucket_start DESC 
LIMIT 1000;
```

#### 使用覆盖索引
```sql
-- 创建覆盖索引
CREATE INDEX idx_tenant_time_progress ON agg_production_progress_5m 
(tenant_id, bucket_start, progress_rate, efficiency);
```

---

## 🔄 回滚方案

如果需要恢复分片功能，可以按以下步骤操作：

### 1. **恢复分区定义**

```sql
-- 重新添加分区
ALTER TABLE agg_production_progress_5m 
PARTITION BY RANGE (TO_DAYS(bucket_start)) (
    PARTITION p202501 VALUES LESS THAN (TO_DAYS('2025-02-01')),
    PARTITION p202502 VALUES LESS THAN (TO_DAYS('2025-03-01')),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

### 2. **恢复存储过程**

从Git历史记录中恢复分区管理存储过程。

### 3. **恢复定时任务**

从Git历史记录中恢复分区管理定时任务。

---

## 📋 检查清单

### ✅ 已完成
- [x] 移除所有BI表的分区定义
- [x] 更新数据库schema文件
- [x] 移除分区管理存储过程
- [x] 更新部署脚本
- [x] 更新相关文档
- [x] 创建数据清理替代方案

### 🔄 待完成
- [ ] 测试无分区表的查询性能
- [ ] 验证数据清理脚本
- [ ] 更新监控告警规则
- [ ] 更新运维文档

---

## 📞 技术支持

如有问题，请联系：
- **数据库团队**: db-team@btc-mes.com
- **运维团队**: ops-team@btc-mes.com
- **技术支持**: support@btc-mes.com

---

*最后更新时间: 2025-01-07*  
*文档版本: v1.0.0*
