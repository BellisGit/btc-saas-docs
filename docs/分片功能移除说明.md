# åˆ†ç‰‡åŠŸèƒ½ç§»é™¤è¯´æ˜

## ğŸ“‹ ç§»é™¤æ¦‚è¿°

**ç§»é™¤æ—¥æœŸ**: 2025-01-07  
**ç§»é™¤åŸå› **: æš‚æ—¶ä¸éœ€è¦åˆ†ç‰‡åŠŸèƒ½ï¼Œç®€åŒ–æ•°æ®åº“æ¶æ„  
**å½±å“èŒƒå›´**: æ•°æ®åº“è¡¨ç»“æ„ã€éƒ¨ç½²è„šæœ¬ã€æ–‡æ¡£

---

## ğŸ”„ ç§»é™¤å†…å®¹

### 1. **æ•°æ®åº“è¡¨ç»“æ„ç§»é™¤**

#### ç§»é™¤çš„åˆ†åŒºå®šä¹‰
æ‰€æœ‰BIèšåˆè¡¨çš„åˆ†åŒºå®šä¹‰å·²è¢«ç§»é™¤ï¼ŒåŒ…æ‹¬ï¼š

**btc_bi/01_production_bi.sql**
- `agg_production_progress_5m` è¡¨
- `agg_wip_status_5m` è¡¨  
- `agg_inventory_turnover_1h` è¡¨
- `agg_stock_transaction_5m` è¡¨
- `agg_supplier_performance_1d` è¡¨
- `agg_cost_analysis_1d` è¡¨
- `agg_workorder_efficiency_1h` è¡¨

**btc_bi/02_quality_bi.sql**
- `agg_quality_stats_5m` è¡¨
- `agg_defect_analysis_1h` è¡¨
- `agg_inspector_performance_1d` è¡¨
- `agg_repair_stats_1h` è¡¨
- `agg_test_stats_1h` è¡¨
- `agg_quality_cost_1d` è¡¨

**btc_bi/03_system_bi.sql**
- `agg_equipment_efficiency_5m` è¡¨
- `agg_equipment_failure_1h` è¡¨
- `agg_alert_stats_1h` è¡¨
- `agg_sensor_data_5m` è¡¨
- `agg_user_activity_1h` è¡¨
- `agg_system_performance_5m` è¡¨

#### ç§»é™¤çš„åˆ†åŒºè¯­æ³•
```sql
-- ç§»é™¤å‰ï¼ˆæœ‰åˆ†åŒºï¼‰
CREATE TABLE agg_production_progress_5m (
    bucket_start DATETIME PRIMARY KEY,
    -- å…¶ä»–å­—æ®µ...
) COMMENT 'ç”Ÿäº§è¿›åº¦èšåˆè¡¨(5åˆ†é’Ÿ)' 
PARTITION BY RANGE (TO_DAYS(bucket_start)) (
    PARTITION p202501 VALUES LESS THAN (TO_DAYS('2025-02-01')),
    PARTITION p202502 VALUES LESS THAN (TO_DAYS('2025-03-01')),
    -- æ›´å¤šåˆ†åŒº...
    PARTITION p_future VALUES LESS THAN MAXVALUE
);

-- ç§»é™¤åï¼ˆæ— åˆ†åŒºï¼‰
CREATE TABLE agg_production_progress_5m (
    bucket_start DATETIME PRIMARY KEY,
    -- å…¶ä»–å­—æ®µ...
) COMMENT 'ç”Ÿäº§è¿›åº¦èšåˆè¡¨(5åˆ†é’Ÿ)';
```

### 2. **éƒ¨ç½²è„šæœ¬ç§»é™¤**

#### ç§»é™¤çš„å­˜å‚¨è¿‡ç¨‹
- `CreateMonthlyPartition` - åˆ›å»ºæœˆåº¦åˆ†åŒº
- `DropOldPartitions` - åˆ é™¤æ—§åˆ†åŒº

#### ç§»é™¤çš„å®šæ—¶ä»»åŠ¡
```bash
# ç§»é™¤å‰ï¼ˆåˆ†åŒºç®¡ç†å®šæ—¶ä»»åŠ¡ï¼‰
0 2 1 * * root mysql -u root -pPASSWORD btc_log -e "CALL CreateMonthlyPartition('user_behavior_log', DATE_ADD(CURDATE(), INTERVAL 1 MONTH));"
0 3 15 * * root mysql -u root -pPASSWORD btc_log -e "CALL DropOldPartitions('user_behavior_log', 6);"

# ç§»é™¤åï¼ˆæ•°æ®æ¸…ç†å®šæ—¶ä»»åŠ¡ï¼‰
0 2 * * * root mysql -u root -pPASSWORD btc_log -e "DELETE FROM user_behavior_log WHERE occurred_at < DATE_SUB(NOW(), INTERVAL 6 MONTH);"
```

### 3. **æ–‡æ¡£æ›´æ–°**

#### æ›´æ–°çš„æ–‡æ¡£æ–‡ä»¶
- `docs/09-database-deployment-guide.md` - ç§»é™¤åˆ†åŒºç®¡ç†ç« èŠ‚
- `docs/04-physical-layout.md` - ç§»é™¤åˆ†åŒºç¤ºä¾‹ä»£ç 
- `docs/10-business-extension-complete.md` - ç§»é™¤åˆ†åŒºä¼˜åŒ–å»ºè®®
- `docs/11-security-and-compliance.md` - ç§»é™¤åˆ†åŒºè¡¨å®šä¹‰

---

## ğŸ“Š å½±å“åˆ†æ

### 1. **æ€§èƒ½å½±å“**

#### ä¼˜åŠ¿
- **ç®€åŒ–éƒ¨ç½²**: æ— éœ€ç®¡ç†å¤æ‚çš„åˆ†åŒºåˆ›å»ºå’Œæ¸…ç†é€»è¾‘
- **å‡å°‘ç»´æŠ¤**: ä¸éœ€è¦ç›‘æ§åˆ†åŒºçŠ¶æ€å’Œå­˜å‚¨è¿‡ç¨‹æ‰§è¡Œ
- **é™ä½å¤æ‚åº¦**: è¡¨ç»“æ„æ›´åŠ ç®€å•ï¼Œæ˜“äºç†è§£å’Œç»´æŠ¤

#### åŠ£åŠ¿
- **æŸ¥è¯¢æ€§èƒ½**: å¯¹äºå¤§æ•°æ®é‡è¡¨çš„æŸ¥è¯¢å¯èƒ½è¾ƒæ…¢
- **æ•°æ®ç®¡ç†**: éœ€è¦æ‰‹åŠ¨ç®¡ç†å†å²æ•°æ®æ¸…ç†
- **å­˜å‚¨æ•ˆç‡**: æ— æ³•åˆ©ç”¨åˆ†åŒºçš„å­˜å‚¨ä¼˜åŒ–ç‰¹æ€§

### 2. **åŠŸèƒ½å½±å“**

#### ä¸å—å½±å“çš„åŠŸèƒ½
- âœ… åŸºæœ¬çš„æ•°æ®å­˜å‚¨å’ŒæŸ¥è¯¢
- âœ… ç´¢å¼•æŸ¥è¯¢æ€§èƒ½
- âœ… æ•°æ®å®Œæ•´æ€§çº¦æŸ
- âœ… å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»

#### å—å½±å“çš„åŠŸèƒ½
- âŒ è‡ªåŠ¨åˆ†åŒºç®¡ç†
- âŒ åŸºäºæ—¶é—´çš„æ•°æ®å½’æ¡£
- âŒ åˆ†åŒºçº§åˆ«çš„æŸ¥è¯¢ä¼˜åŒ–

---

## ğŸ”§ æ›¿ä»£æ–¹æ¡ˆ

### 1. **æ•°æ®æ¸…ç†ç­–ç•¥**

#### å®šæœŸæ¸…ç†è„šæœ¬
```sql
-- æ¸…ç†6ä¸ªæœˆå‰çš„æ—¥å¿—æ•°æ®
DELETE FROM user_behavior_log 
WHERE occurred_at < DATE_SUB(NOW(), INTERVAL 6 MONTH);

-- æ¸…ç†1å¹´å‰çš„BIèšåˆæ•°æ®
DELETE FROM agg_production_progress_5m 
WHERE bucket_start < DATE_SUB(NOW(), INTERVAL 1 YEAR);
```

#### å®šæ—¶ä»»åŠ¡é…ç½®
```bash
# æ¯å¤©å‡Œæ™¨2ç‚¹æ‰§è¡Œæ•°æ®æ¸…ç†
0 2 * * * root /usr/local/bin/btc-data-cleanup.sh
```

### 2. **æŸ¥è¯¢ä¼˜åŒ–ç­–ç•¥**

#### ç´¢å¼•ä¼˜åŒ–
```sql
-- ä¸ºæ—¶é—´å­—æ®µåˆ›å»ºç´¢å¼•
CREATE INDEX idx_bucket_start ON agg_production_progress_5m (bucket_start);
CREATE INDEX idx_occurred_at ON user_behavior_log (occurred_at);

-- åˆ›å»ºå¤åˆç´¢å¼•
CREATE INDEX idx_tenant_time ON agg_production_progress_5m (tenant_id, bucket_start);
```

#### æŸ¥è¯¢ä¼˜åŒ–
```sql
-- ä½¿ç”¨æ—¶é—´èŒƒå›´é™åˆ¶æŸ¥è¯¢
SELECT * FROM agg_production_progress_5m 
WHERE tenant_id = ? 
  AND bucket_start >= DATE_SUB(NOW(), INTERVAL 7 DAY)
  AND bucket_start < NOW();
```

### 3. **ç›‘æ§ç­–ç•¥**

#### è¡¨å¤§å°ç›‘æ§
```sql
-- ç›‘æ§è¡¨å¤§å°
SELECT 
    table_name,
    ROUND(((data_length + index_length) / 1024 / 1024), 2) AS 'Size (MB)'
FROM information_schema.tables 
WHERE table_schema = 'btc_bi'
ORDER BY (data_length + index_length) DESC;
```

#### æŸ¥è¯¢æ€§èƒ½ç›‘æ§
```sql
-- ç›‘æ§æ…¢æŸ¥è¯¢
SELECT 
    query_time,
    lock_time,
    rows_examined,
    sql_text
FROM mysql.slow_log 
WHERE start_time >= DATE_SUB(NOW(), INTERVAL 1 DAY)
ORDER BY query_time DESC;
```

---

## ğŸš€ è¿ç§»æŒ‡å—

### 1. **ç°æœ‰åˆ†åŒºè¡¨è¿ç§»**

å¦‚æœç³»ç»Ÿä¸­å·²å­˜åœ¨åˆ†åŒºè¡¨ï¼Œéœ€è¦å…ˆç§»é™¤åˆ†åŒºï¼š

```sql
-- ç§»é™¤è¡¨åˆ†åŒº
ALTER TABLE agg_production_progress_5m REMOVE PARTITIONING;

-- é‡æ–°åˆ›å»ºç´¢å¼•
DROP INDEX idx_bucket_start ON agg_production_progress_5m;
CREATE INDEX idx_bucket_start ON agg_production_progress_5m (bucket_start);
```

### 2. **å­˜å‚¨è¿‡ç¨‹æ¸…ç†**

```sql
-- åˆ é™¤åˆ†åŒºç®¡ç†å­˜å‚¨è¿‡ç¨‹
DROP PROCEDURE IF EXISTS CreateMonthlyPartition;
DROP PROCEDURE IF EXISTS DropOldPartitions;
```

### 3. **å®šæ—¶ä»»åŠ¡æ›´æ–°**

```bash
# åˆ é™¤æ—§çš„åˆ†åŒºç®¡ç†å®šæ—¶ä»»åŠ¡
rm /etc/cron.d/btc-database-partitions

# åˆ›å»ºæ–°çš„æ•°æ®æ¸…ç†å®šæ—¶ä»»åŠ¡
cat > /etc/cron.d/btc-database-maintenance << EOF
0 2 * * * root /usr/local/bin/btc-data-cleanup.sh
EOF
```

---

## ğŸ“ˆ æ€§èƒ½å»ºè®®

### 1. **æ•°æ®å½’æ¡£ç­–ç•¥**

#### å†å²æ•°æ®å½’æ¡£
```sql
-- åˆ›å»ºå½’æ¡£è¡¨
CREATE TABLE agg_production_progress_5m_archive LIKE agg_production_progress_5m;

-- å½’æ¡£æ—§æ•°æ®
INSERT INTO agg_production_progress_5m_archive 
SELECT * FROM agg_production_progress_5m 
WHERE bucket_start < DATE_SUB(NOW(), INTERVAL 1 YEAR);

-- åˆ é™¤å·²å½’æ¡£æ•°æ®
DELETE FROM agg_production_progress_5m 
WHERE bucket_start < DATE_SUB(NOW(), INTERVAL 1 YEAR);
```

### 2. **æŸ¥è¯¢ä¼˜åŒ–**

#### ä½¿ç”¨LIMITé™åˆ¶ç»“æœé›†
```sql
-- é™åˆ¶æŸ¥è¯¢ç»“æœæ•°é‡
SELECT * FROM agg_production_progress_5m 
WHERE bucket_start >= DATE_SUB(NOW(), INTERVAL 7 DAY)
ORDER BY bucket_start DESC 
LIMIT 1000;
```

#### ä½¿ç”¨è¦†ç›–ç´¢å¼•
```sql
-- åˆ›å»ºè¦†ç›–ç´¢å¼•
CREATE INDEX idx_tenant_time_progress ON agg_production_progress_5m 
(tenant_id, bucket_start, progress_rate, efficiency);
```

---

## ğŸ”„ å›æ»šæ–¹æ¡ˆ

å¦‚æœéœ€è¦æ¢å¤åˆ†ç‰‡åŠŸèƒ½ï¼Œå¯ä»¥æŒ‰ä»¥ä¸‹æ­¥éª¤æ“ä½œï¼š

### 1. **æ¢å¤åˆ†åŒºå®šä¹‰**

```sql
-- é‡æ–°æ·»åŠ åˆ†åŒº
ALTER TABLE agg_production_progress_5m 
PARTITION BY RANGE (TO_DAYS(bucket_start)) (
    PARTITION p202501 VALUES LESS THAN (TO_DAYS('2025-02-01')),
    PARTITION p202502 VALUES LESS THAN (TO_DAYS('2025-03-01')),
    PARTITION p_future VALUES LESS THAN MAXVALUE
);
```

### 2. **æ¢å¤å­˜å‚¨è¿‡ç¨‹**

ä»Gitå†å²è®°å½•ä¸­æ¢å¤åˆ†åŒºç®¡ç†å­˜å‚¨è¿‡ç¨‹ã€‚

### 3. **æ¢å¤å®šæ—¶ä»»åŠ¡**

ä»Gitå†å²è®°å½•ä¸­æ¢å¤åˆ†åŒºç®¡ç†å®šæ—¶ä»»åŠ¡ã€‚

---

## ğŸ“‹ æ£€æŸ¥æ¸…å•

### âœ… å·²å®Œæˆ
- [x] ç§»é™¤æ‰€æœ‰BIè¡¨çš„åˆ†åŒºå®šä¹‰
- [x] æ›´æ–°æ•°æ®åº“schemaæ–‡ä»¶
- [x] ç§»é™¤åˆ†åŒºç®¡ç†å­˜å‚¨è¿‡ç¨‹
- [x] æ›´æ–°éƒ¨ç½²è„šæœ¬
- [x] æ›´æ–°ç›¸å…³æ–‡æ¡£
- [x] åˆ›å»ºæ•°æ®æ¸…ç†æ›¿ä»£æ–¹æ¡ˆ

### ğŸ”„ å¾…å®Œæˆ
- [ ] æµ‹è¯•æ— åˆ†åŒºè¡¨çš„æŸ¥è¯¢æ€§èƒ½
- [ ] éªŒè¯æ•°æ®æ¸…ç†è„šæœ¬
- [ ] æ›´æ–°ç›‘æ§å‘Šè­¦è§„åˆ™
- [ ] æ›´æ–°è¿ç»´æ–‡æ¡£

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»ï¼š
- **æ•°æ®åº“å›¢é˜Ÿ**: db-team@btc-mes.com
- **è¿ç»´å›¢é˜Ÿ**: ops-team@btc-mes.com
- **æŠ€æœ¯æ”¯æŒ**: support@btc-mes.com

---

*æœ€åæ›´æ–°æ—¶é—´: 2025-01-07*  
*æ–‡æ¡£ç‰ˆæœ¬: v1.0.0*
